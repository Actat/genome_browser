/**
 * @author Hiroyuki Wakaguri: hwakagur@bits.cc (Tokyo-Univ. Yutaka Suzuki's lab.)
 * kero_browse_track.js v1.7.20171221
 */
var WgBigWig2=function(name,color,dispName,bwUrl,option){this.option=(option!==undefined)?option:{};this.option.buttonOnOffFlg=(this.option.buttonOnOffFlg===undefined)?false:option.buttonOnOffFlg;this.option.middle0Flg=(this.option.middle0Flg===undefined)?false:option.middle0Flg;this.name=name;this.color=(color===undefined)?"#55AA55":color;this.defalutColor=this.color;this.dispName=dispName;this.imgObj,this.ojson;this.id2step={};this.oneBedStep=20;this.baseHeight=20;this.height=this.baseHeight;this.y;this.autoHeight=50;this.min=(this.option.middle0Flg)?-2:0;this.max=(this.option.middle0Flg)?2:500;this.maxNum=50;this.showType=(this.option.showType!==undefined)?this.option.showType:(this.option.middle0Flg)?"auto":"auto";this.bw=new BigbedData(bwUrl,{localFlg:this.option.localFlg});var m=this;this.imgCaching={cachingNum:10,getSettingType:function(){return m.color+"|"+m.autoHeight+"|"+m.min+"|"+m.max+"|"+m.maxNum+"|"+m.showType}}};WgBigWig2.prototype=new WgRoot();WgBigWig2.prototype.paint2=function(dt,y,width,chr,start,end,strand){var finView={};var id2step=this.id2step;var y2=y+this.height-1;if(this.option.middle0Flg){this.imgObj.fillStyle="#000000";this.imgObj.fillRect(0,y+(this.height-1)/2,width,1)}var stepForBed=[];var stepForBedStr=[];for(var i=0;i<dt.length;i++){var chip=(this.name.substr(0,4)=="peak")?dt[i]["wig"]:dt[i];if(chip[0]!==undefined&&chip[0].error!==undefined){this.paintError(y,width,start,end,strand,i,chip[0].error);continue}var peak=(this.name.substr(0,4)=="peak")?dt[i]["peak"]:[];var peak_poi=0;for(var j=0;j<chip.length;j++){if(chip[j].type=="bed"){var name=chip[j].bedClm[0].split(/;/)[1].split(/=/)[1];if(!name.match(/Liver/)){}var id=chip[j].id;if(finView[id])continue;finView[id]=true;var bedStart=chip[j].start;var bedEnd=chip[j].end;var step=undefined;var tmpStep=(id2step[id])?id2step[id]:1;if(stepForBed[tmpStep-1]===undefined){stepForBed[tmpStep-1]=[[bedStart,bedEnd]];step=tmpStep;id2step[id]=step}else{if(tmpStep!=1){var targetStep=stepForBed[tmpStep-1];for(var k=0;k<targetStep.length;k++){var tmpStart=targetStep[k][0];var tmpEnd=targetStep[k][1];if(tmpStart-11<=bedEnd&&bedStart<=tmpEnd+11){break}else if(bedEnd+11<tmpStart){step=tmpStep;stepForBed[tmpStep-1].splice(k,0,[bedStart,bedEnd]);break}}}if(step===undefined){for(var k=0;k<stepForBed.length;k++){var targetStep=stepForBed[k];if(targetStep===undefined){stepForBed[k]=[[bedStart,bedEnd]];step=k+1;id2step[id]=step}else{var ovFlg=false;for(var l=0;l<targetStep.length;l++){var tmpStart=targetStep[l][0];var tmpEnd=targetStep[l][1];if(tmpStart-11<=bedEnd&&bedStart<=tmpEnd+11){ovFlg=true;break}else if(bedEnd+11<tmpStart){step=k+1;id2step[id]=step;stepForBed[k].splice(l,0,[bedStart,bedEnd]);break}}if(!ovFlg&&step===undefined){step=k+1;id2step[id]=step;stepForBed[k].push([bedStart,bedEnd])}}if(step!==undefined)break}if(step===undefined){if(stepForBed.length<Math.floor(this.height/this.oneBedStep)+1){stepForBed.push([[bedStart,bedEnd]]);step=stepForBed.length;id2step[id]=step}}}}if(step!==undefined){var y1=y+(step-1)*this.oneBedStep;var y3=y1+5;var x3=(bedStart-start)*(width-1)/(end-start+1);var x4=(bedEnd-start+1)*(width-1)/(end-start+1);var x5=(x3+x4)/2-strWidth/2;if(strand=="-"){var tmp=width-1-x3;x3=width-1-x4;x4=tmp}this.imgObj.font="10px 'Helvetica'";var strWidth=this.imgObj.measureText(name).width;if(stepForBedStr[step-1]===undefined){stepForBedStr[step-1]=[[x5,x5+strWidth]];this.imgObj.fillStyle="#000000";this.imgObj.fillText(name,x5,y3+10)}else{var ngFlg=false;for(var k=0;k<stepForBedStr[step-1].length;k++){var se=stepForBedStr[step-1][k];if(se[0]-11<=x5+strWidth&&x5<=se[1]+11){ngFlg=true;break}}if(!ngFlg){this.imgObj.fillStyle="#000000";this.imgObj.fillText(name,x5,y3+10);stepForBedStr[step-1].push([x5,x5+strWidth])}}this.imgObj.fillStyle="rgb("+chip[j].bedClm[5]+")";this.imgObj.fillRect(x3,y1,x4-x3+1,y3-y1);this.imgObj.strokeStyle="#AAAAff";this.imgObj.strokeRect(x3,y1,x4-x3+1,y3-y1)}continue}var posStart=chip[j].start;var posEnd=chip[j].end;var peak_poi_cp=peak_poi;for(var k=peak_poi_cp;k<peak.length;k++){peak_poi=k;if(posStart<=peak[k].end)break}if(start<=posEnd&&posStart<=end){var num;if(this.showType=="normal"){var cnum=chip[j].num;if(this.option.middle0Flg){num=(cnum>this.max)?this.autoHeight/2:(cnum<this.min)?-this.autoHeight/2:cnum*this.autoHeight/2/this.max}else{num=(cnum>this.max)?this.autoHeight:(cnum<this.min)?0:(cnum-this.min)*this.autoHeight/(this.max-this.min)}}else if(this.showType=="log"){var cnum=chip[j].num;var min_log=(this.min<=1)?0:Math.log(this.min);var max_log=Math.log(this.max);var num_log=Math.log(chip[j].num);num=(cnum>this.max)?this.autoHeight:(cnum<this.min)?0:(num_log-min_log)*this.autoHeight/(max_log-min_log)}else{num=chip[j].num/this.maxNum*this.autoHeight;if(this.option.middle0Flg){num/=2}}var y1=y2-num+1;var x1=(posStart-start)*(width-1)/(end-start+1);var x2=(posEnd-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}this.imgObj.fillStyle=(peak[peak_poi]!==undefined&&posStart<=peak[peak_poi].end&&peak[peak_poi].start<=posEnd)?"red":this.color;if(this.option.middle0Flg){this.imgObj.fillRect(x1,y1-this.height/2,x2-x1+1,y2-y1+1)}else{this.imgObj.fillRect(x1,y1,x2-x1+1,y2-y1+1)}}}}};WgBigWig2.prototype.paintVScale=function(img,width){var x1=width-3;img.strokeStyle="#555555";img.fillStyle="#555555";img.beginPath();img.moveTo(x1,this.y);img.lineTo(x1,this.y+this.height);if(this.showType=="normal"){var baseVal=(this.max-this.min)/this.autoHeight;var inc;if(baseVal<=0.5){inc=1}else{inc=Math.pow(10,(Math.floor(Math.log(baseVal*2)/Math.log(10))+1))}var mStart=(Math.floor((this.min-1)/inc)+1)*inc;var yPich=inc*this.autoHeight/(this.max-this.min);for(var m=mStart;m<=this.max;m+=inc){var absM=Math.abs(m);var y1=this.y+this.height-(m-this.min)*this.autoHeight/(this.max-this.min);var xM=5;if((absM/inc)%10==5)xM=8;if((absM/inc)%10==0)xM=10;if((absM/inc)%10==0||(absM/inc)%10==5||yPich>=10){if(y1+5<this.y+this.height&&y1>this.y+5){img.font="10px 'Helvetica'";var strWidth=img.measureText(m).width;img.fillText(m,x1-10-strWidth,y1+5)}}img.moveTo(x1-xM,y1);img.lineTo(x1,y1)}}else if(this.showType=="log"){var min_log=(this.min<=1)?0:Math.log(this.min);var max_log=Math.log(this.max);var mStart;if(this.min<10){mStart=10}else{mStart=Math.pow(10,Math.floor(Math.log(this.min-1)/Math.log(10))+1)}var y_pich10=this.autoHeight/(max_log-min_log)*Math.log(10);var m_times=10;if(y_pich10<10){m_times=Math.floor(Math.pow(Math.E,10*(max_log-min_log)/this.autoHeight))}for(var m=mStart;m<=this.max;m*=m_times){var m_log=Math.log(m);var y1=this.y+this.height-(m_log-min_log)*this.autoHeight/(max_log-min_log);var xM=5;img.moveTo(x1-xM,y1);img.lineTo(x1,y1);img.font="10px 'Helvetica'";var strWidth=img.measureText(m).width;img.fillText(m,x1-xM-strWidth,y1+5)}}else{var y1=this.y;var y2=y1+this.height-1;var xM=5;var str=Math.floor(this.maxNum*1000)/1000;img.font="10px 'Helvetica'";var strWidth=img.measureText("-"+str).width;img.fillText(str,x1-xM-strWidth,y1+10);img.moveTo(x1-xM,y1);img.lineTo(x1,y1);if(this.option.middle0Flg){img.fillText("0",x1-xM-strWidth+20,(y1+y2)/2+2);img.moveTo(x1-xM,(y1+y2)/2);img.lineTo(x1,(y1+y2)/2);img.fillText("-"+str,x1-xM-strWidth,y2-5);img.moveTo(x1-xM,y2);img.lineTo(x1,y2)}}img.stroke()};WgBigWig2.prototype.setHeight2=function(dt,width,chr,start,end){if(this.showType=="auto"){this.maxNum=1;var tempHeight=0;for(var i=0;i<dt.length;i++){var chip=(this.name.substr(0,4)=="peak")?dt[i]["wig"]:dt[i];for(var j=0;j<chip.length;j++){var posStart=chip[j].start;var posEnd=chip[j].end;if(start<=posEnd&&posStart<=end){var num=Math.abs(parseFloat(chip[j].num));if(this.maxNum<num)this.maxNum=num;var setHeightVal=(this.showType=="normal")?parseFloat(chip[j].num):(this.showType=="log")?Math.log(chip[j].num)/Math.log(2)*10:this.autoHeight;if(tempHeight<setHeightVal)tempHeight=setHeightVal}}}}this.height=this.autoHeight};WgBigWig2.prototype.getMenuPopup=function(){var checked=new Array("","","");if(this.showType=="normal")checked[0]="checked=\"checked\"";if(this.showType=="log")checked[1]="checked=\"checked\"";if(this.showType=="auto")checked[2]="checked=\"checked\"";var htmlStr="";htmlStr+="<div style=\"border:1px solid\"><table border=\"0\" width=\"100%\"><tr><th align=\"left\" bgcolor=\"#aaaaaa\" colspan=\"2\">Setting:</th></tr><tr>";htmlStr+="<td bgcolor=\"#aaaaaa\">&nbsp;</td><td><form>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"normal\" id=\"normal\" ";htmlStr+=checked[0]+" /><label for=\"normal\">Normal</label></div>";if(!this.option.middle0Flg){htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"log\" id=\"log\" ";htmlStr+=checked[1]+" /><label for=\"log\">Log</label></div>"}htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"auto\" id=\"auto\" ";htmlStr+=checked[2]+" /><label for=\"auto\">Auto</label></div>";htmlStr+="</form>";htmlStr+="<hr /><a href=\"#\" class=\"det\">Detail...</a>";htmlStr+="</td></tr></table></div>";return htmlStr};WgBigWig2.prototype.showTypeChangeAction=function(){if(this.option.middle0Flg&&this.showType=="log")this.showType="auto"};WgBigWig2.prototype.getMenuDetail=function(){var checked=(this.defalutColor.toLowerCase()==this.color.toLowerCase())?"checked=\"checked\"":"";var disabled=(checked=="")?"":"disabled=\"disabled\"";var htmlStr="";htmlStr+="<form><div><strong>Detailed settings</strong></div>";htmlStr+="<div class=\"modal_inbox\">";htmlStr+="<table border=\"0\" width=\"100%\"><tr><td align=\"center\">";htmlStr+="<div>Track height: <input type=\"text\" id=\"height\" size=\"3\" maxlength=\"3\" value=\""+this.autoHeight+"\"/></div>";htmlStr+="<div><hr /></div>";htmlStr+="<table border=\"1\">";htmlStr+="<tr><th colspan=\"2\">Data rage (when not Auto mode):</th></tr>";if(!this.option.middle0Flg){htmlStr+="<tr><td>Min: </td><td><input type=\"text\" id=\"min\" size=\"5\" maxlength=\"10\" value=\""+this.min+"\"/></td></tr>"}htmlStr+="<tr><td>Max: </td><td><input type=\"text\" id=\"max\" size=\"5\" maxlength=\"10\" value=\""+this.max+"\"/></td></tr>";htmlStr+="</table>";htmlStr+="<div><hr /></div>";htmlStr+="<table border=\"1\">";htmlStr+="<tr><th align=\"left\" colspan=\"3\"><a target=\"_blank\" href=\"http://www.theodora.com/gif4/html_colors.gif\">Coloring: </a></td></tr>";htmlStr+="<tr><td nowrap>Defalut <input type=\"checkbox\" name=\"def_color\" value=\"def_color\" id=\"def_color\" ";htmlStr+=checked+" /></td><td nowrap>Color: #<input type=\"text\" id=\"col\" size=\"6\" maxlength=\"6\" value=\""+this.color.substr(1)+"\" "+disabled+" /></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"col_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="</table>";htmlStr+="<div>&nbsp;</div>";htmlStr+="</td></tr></table></div>";htmlStr+="<div class=\"modal_btn\"><input type=\"button\" id=\"apply_button\" value=\"Apply\" /><input type=\"button\" id=\"cancel_button\" value=\"Cancel\" /></div>";htmlStr+="</form>";return[htmlStr,[300,270]]};WgBigWig2.prototype.menuDetailAction=function(parent){var m=this;var id="col";var col=this.color;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",col);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});$("div"+parent.divId+" div#modal div.container #def_color").change(function(){if($("div"+parent.divId+" div#modal div.container #def_color").is(":checked")){$("div"+parent.divId+" div#modal div.container #col").attr('disabled',true);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",m.defalutColor)}else{$("div"+parent.divId+" div#modal div.container #col").attr('disabled',false);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color","#"+$("div"+parent.divId+" div#modal div.container #"+id).val())}})};WgBigWig2.prototype.setViewDetail=function(divId){var height=parseInt($("div"+divId+" div#modal div.container #height").val());if(height<10)height=10;if(height>500)height=500;if(isNaN(height))height=50;this.autoHeight=height;if(!this.option.middle0Flg){var min=parseInt($("div"+divId+" div#modal div.container #min").val());if(min<0)min=0;if(isNaN(min))min=0;this.min=min}var max=parseInt($("div"+divId+" div#modal div.container #max").val());if(max<min)max=min*10;if(max==min)max=min+1;if(max<1)max=1;if(isNaN(max))max=1000;this.max=max;if(this.option.middle0Flg)this.min=-max;this.color=($("div"+divId+" div#modal div.container #def_color").is(":checked"))?this.defalutColor:"#"+$("div"+divId+" div#modal div.container #col").val();return true};WgBigWig2.prototype.getName=function(){return this.name};WgBigWig2.prototype.getPannelBgcolor=function(){return(this.option.pannelBgcolor)?this.option.pannelBgcolor:"#EEEEEE"};WgBigWig2.prototype.getItemDispName=function(){var dispName=(this.dispName)?this.dispName:this.name;return dispName};WgBigWig2.prototype.getItemDetailName=function(){return(this.option.itemDetailName)?this.option.itemDetailName:this.getItemDispName()};WgBigWig2.prototype.getButtonInfo=function(){var buttonColor=(this.option.buttonColor===undefined)?{"color":["eeeeee","ffcccc"],"onOff":this.option.buttonOnOffFlg}:{"color":this.option.buttonColor,"onOff":this.option.buttonOnOffFlg};return buttonColor};WgBigWig2.prototype.accessObj=function(chr,binStart,binEnd,powP,accDefault){var m=this;var bpPerPixel=Math.pow(10,powP);var bpStart=binStart*bpPerPixel*POW_REG+1;var bpEnd=(parseInt(binStart)+1)*bpPerPixel*POW_REG;this.bw.readWaitReader(chr,bpStart,bpEnd,bpPerPixel,function(reductionLevel,fetcher){var data={};var tmp=[];for(var alnEach of fetcher()){var num=(reductionLevel)?alnEach.maxVal:alnEach.value;if(num===undefined){var bedClm=alnEach.otherClm.split(/\t/);tmp.push({type:"bed",id:bedClm[0],start:alnEach.chromStart,end:alnEach.chromEnd,bedClm:bedClm})}else{tmp.push({type:"wig",id:alnEach.chromStart,start:alnEach.chromStart,end:alnEach.chromEnd,num:num})}}data[m.name]=tmp;accDefault.success(data);accDefault.complete()},function(err){accDefault.error(err,err,err);accDefault.complete()})};var WgBam2=function(name,dispName,bamUrl,option){this.option=(option!==undefined)?option:{};if(this.option.uriDirFlg===undefined)this.option.uriDirFlg=true;this.name=name;this.dispName=dispName;this.charPx=10;this.minHeight=30;this.y;this.getSeqData=(this.option.seqUrl===undefined)?{"url":"https://dbtss.hgc.jp/cgi-bin/dbtss_db_json.cgi/9606","param":"SEE=1&UID=2"}:this.option.seqUrl;this.powMax=1;this.margin=1;this.eachStep=10;this.limitShowHeight=5;this.maxHeight=this.eachStep*30+this.limitShowHeight;this.overReg={};this.overRegList=[];this.bam=new BamData(bamUrl,{localFlg:this.option.localFlg})};WgBam2.prototype=new WgRoot();WgBam2.prototype.paint=function(y,width,chr,start,end,strand){var existId={};var status=[];var pow=Math.floor(Math.LOG10E*Math.log((end-start+1)/width));if(pow<0)pow=0;var reg=Math.pow(10,pow)*POW_REG;var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);this.imgObj.font=this.charPx+"px 'Helvetica'";if(pow>this.powMax){var y1=y;var y2=y1+this.height-1;var y3=(y1+y2)/2+3;this.imgObj.fillStyle="#EEEEEE";this.imgObj.fillRect(0,y1,width,y2-y1+1);var tooLargeStr="Too large region for showing alignment";var strWidth=this.imgObj.measureText(tooLargeStr).width;this.imgObj.fillStyle="#888888";x3=(width-strWidth)/2;this.imgObj.fillText(tooLargeStr,x3,y3);return[]}let pileup={};for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]){var each=this.ojson[pow][chr+"|"+i][this.name];var read=each.reads;if(!read)continue;for(var j=0;j<read.length;j++){var readS=read[j].pos;var readE=read[j].posEnd;var flag=read[j].flag;var stepNo=read[j].step;var cigar=read[j].cigar;var cigarOp=read[j].cigarOp;var cigarLn=read[j].cigarLn;var seq=read[j].seq;var seqPoi=0;if(start<=readE&&readS<=end){if(existId[read[j].id]){continue}else{existId[read[j].id]=true}var x1=(readS-start)*(width-1)/(end-start+1);var x2=(readE-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}var y1=y+this.eachStep*stepNo;var y2=y1+this.eachStep-3;if(stepNo>=0&&false){this.imgObj.fillStyle=(flag&16)?"#BBBBFF":"#FFBBBB";this.imgObj.fillRect(x1,y1,x2-x1+1,y2-y1+1)}else{let inPosList=[];let nowPos=readS;let ops=cigarOp;let lns=cigarLn;for(let k=1;k<ops.length;k++){let op=ops[k];let ln=parseInt(lns[k-1]);if(stepNo>=0&&op=="I"){if(pow==0){let x3=(nowPos-start)*(width-1)/(end-start+1);inPosList.push(x3)}seqPoi+=ln}else if(stepNo>=0&&op=="N"){let x3=(nowPos-start)*(width-1)/(end-start+1);let x4=(nowPos+ln-start)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x3;x3=width-1-x4;x4=tmp}let y3=(y1+y2)/2-1;this.imgObj.fillStyle=(flag&16)?"#BBBBFF":"#FFBBBB";this.imgObj.fillRect(x3,y3,x4-x3+1,2);nowPos+=ln}else if(stepNo>=0&&op=="H"){}else if(stepNo>=0&&op=="S"){seqPoi+=ln}else if(stepNo>=0&&op=="P"){alert("not supported cigar P")}else if(op=="M"||op=="X"||op=="="||op=="D"){if(stepNo>=0){let x3=(nowPos-start)*(width-1)/(end-start+1);let x4=(nowPos+ln-start)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x3;x3=width-1-x4;x4=tmp}this.imgObj.fillStyle=(flag&16)?"#BBBBFF":"#FFBBBB";if(op=="D"){this.imgObj.fillRect(x3,(y1+y2)/2-1,x4-x3+1,2);nowPos+=ln;continue}else{this.imgObj.fillRect(x3,y1,x4-x3+1,y2-y1+1)}}var sSeq="";var binAlnS=Math.floor((nowPos-1)/reg);var strStart=(nowPos-1)%reg;var nowLn=ln;while(sSeq.length<ln){var rest=reg-strStart;var kn=(rest<nowLn)?rest:nowLn;if(this.ojson[pow][chr+"|"+binAlnS]&&this.ojson[pow][chr+"|"+binAlnS][this.name]&&this.ojson[pow][chr+"|"+binAlnS][this.name].sequence){var gSeq=this.ojson[pow][chr+"|"+binAlnS][this.name].sequence;sSeq+=gSeq.substr(strStart,kn).toUpperCase()}else{sSeq+="*".repeat(kn)}binAlnS++;strStart=0;nowLn-=kn}var qSeq=seq.substr(seqPoi,ln);var cpPos=nowPos;for(let l=0;l<sSeq.length;l++){if(cpPos<start||end<cpPos){cpPos++;continue}let sBase=sSeq.charAt(l);let qBase=qSeq.charAt(l);let char=qBase;if(strand=="-"){var tmp=char;if(char=="A")tmp="T";if(char=="a")tmp="t";if(char=="C")tmp="G";if(char=="c")tmp="g";if(char=="G")tmp="C";if(char=="g")tmp="c";if(char=="T")tmp="A";if(char=="t")tmp="a";char=tmp}if(stepNo>=0&&sBase!=qBase&&sBase!="*"&&qBase!="-"){let x5=(cpPos-start)*(width-1)/(end-start+1);let x6=(cpPos-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x5;x5=width-1-x6;x6=tmp}this.imgObj.fillStyle=(char=="A"||char=="a")?"#88FF88":(char=="C"||char=="c")?"#8888FF":(char=="G"||char=="g")?"#FF8800":(char=="T"||char=="t")?"#FF4488":"#AAAAAA";this.imgObj.fillRect(x5,y1,x6-x5+1,y2-y1+1);if(x6-x5>this.charPx&&this.eachStep>=10){this.imgObj.fillStyle="#000000";this.imgObj.fillText(char,(x5+x6)/2-2,(y1+y2)/2+4)}}cpPos++}nowPos+=ln;seqPoi+=ln}}this.imgObj.fillStyle="#333333";for(let k=0;k<inPosList.length;k++){var x3=inPosList[k];if(strand=="-"){var x3=width-1-x3}this.imgObj.fillRect(x3-1,y1,2,y2-y1+1)}}}}}else{if(i>=0)status.push(i);this.paintLoading(y,width,start,end,strand,i)}}this.imgObj.fillStyle="#AAAAAA";for(let regS in this.overReg){var regE=this.overReg[regS];var x1=(regS-start)*(width-1)/(end-start+1);var x2=(regE-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}var y1=y+this.maxHeight-this.limitShowHeight;var y2=y1+3;this.imgObj.fillRect(x1,y1,x2-x1+1,y2-y1+1)}return status};WgBam2.prototype.setHeight=function(width,chr,start,end){var existId={};var pow=Math.floor(Math.LOG10E*Math.log((end-start+1)/width));if(pow<0)pow=0;var reg=Math.pow(10,pow)*POW_REG;if(pow>this.powMax){this.height=this.minHeight;return}var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);var step=[];var overReg=this.overReg;var overRegList=this.overRegList;var stepMax=0;for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]&&this.ojson[pow][chr+"|"+i][this.name].reads){var read=this.ojson[pow][chr+"|"+i][this.name].reads;for(var j=0;j<read.length;j++){let stepNo;var readS=read[j].pos;var readE=read[j].posEnd;var flag=read[j].flag;var cigar=read[j].cigar;if(cigar=="")continue;if(start<=readE&&readS<=end){if(existId[read[j].id]){read[j].step=undefined;continue}else{existId[read[j].id]=true}if(read[j].step!==undefined){var k=read[j].step;if(k!=-1){if(step[k]===undefined)step[k]=[];if(stepMax<k)stepMax=k;var ovFlg=false;for(var l=0;l<step[k].length;l++){var checkS=step[k][l][0];var checkE=step[k][l][1];if(readS-this.margin<=checkE&&checkS<=readE+this.margin){ovFlg=true;break}}if(!ovFlg){step[k].push([readS,readE]);stepNo=k}else{for(k=0;k<step.length;k++){ovFlg=false;if(step[k]===undefined)step[k]=[];for(var l=0;l<step[k].length;l++){var checkS=step[k][l][0];var checkE=step[k][l][1];if(readS-this.margin<=checkE&&checkS<=readE+this.margin){ovFlg=true;break}}if(!ovFlg){step[k].push([readS,readE]);stepNo=k;read[j].step=stepNo;break}}}}}else{for(var k=0;k<step.length;k++){if(step[k]===undefined)step[k]=[];var ovFlg=false;for(var l=0;l<step[k].length;l++){var checkS=step[k][l][0];var checkE=step[k][l][1];if(readS-this.margin<=checkE&&checkS<=readE+this.margin){ovFlg=true;break}}if(!ovFlg){step[k].push([readS,readE]);stepNo=k;break}}read[j].step=stepNo}if(stepNo===undefined||stepNo==-1){if((step.length+1)*this.eachStep<=this.maxHeight-this.limitShowHeight&&stepNo!=-1){stepNo=step.length;step[stepNo]=[[readS,readE]];stepMax=stepNo}else{if(overRegList.length==0){overRegList[0]=readS;overReg[readS]=readE}else{var findFlg=false;var targetK=overRegList.length-1;for(var k=0;k<overRegList.length;k++){var checkS=overRegList[k];var checkE=overReg[checkS];if(checkS<=readS&&readE<=checkE){findFlg=true;break}else if(readS<=checkE&&checkS<=readE){if(checkS<=readE&&readE<=checkE){overRegList.splice(k,1,readS);delete overReg[checkS];overReg[readS]=readE}else{var newS=(checkS<readS)?checkS:readS;var newE=readE;var delCnt=1;delete overReg[checkS];for(var l=k+1;l<overRegList.length;l++){var checkS2=overRegList[l];var checkE2=overReg[checkS2];if(readE<checkS2)break;delCnt++;delete overReg[checkS2];if(readE<checkE2){newE=checkE2;break}}overRegList.splice(k,delCnt,newS);overReg[newS]=newE}findFlg=true;break}else if(readE<checkS){overRegList.splice(k,0,readS);overReg[readS]=readE;findFlg=true;break}}if(!findFlg){overRegList.push(readS);overReg[readS]=readE}}read[j].step=-1;continue}read[j].step=stepNo}}}}else{}}var height=this.eachStep*(stepMax+1);if(this.overRegList.length)height+=this.limitShowHeight;this.height=(height>this.minHeight)?height:this.minHeight};WgBam2.prototype.getPopupData=function(){return};WgBam2.prototype.getName=function(){return this.name};WgBam2.prototype.getItemDispName=function(){var dispName=(this.dispName)?this.dispName:this.name;return dispName};WgBam2.prototype.getPannelBgcolor=function(){return(this.option.pannelBgcolor)?this.option.pannelBgcolor:"#EEEEEE"};WgBam2.prototype.accessObj=function(chr,binStart,binEnd,powP,accDefault){var m=this;var bpPerPixel=Math.pow(10,powP);var bpStart=binStart*bpPerPixel*POW_REG+1;var bpEnd=(parseInt(binStart)+1)*bpPerPixel*POW_REG;if(powP>this.powMax){return}var magic=[];var data={};if(this.option.uriDirFlg){data[this.name]={};data[this.name].reads=magic}else{data[powP]={};data[powP][chr+"|"+binStart]={};data[powP][chr+"|"+binStart][this.name]={};data[powP][chr+"|"+binStart][this.name].reads=magic}if(binStart==binEnd&&this.getSeqData){var jsonUrl=this.getSeqData.url+'/'+powP+'/'+chr+'/'+binStart+'/sequence/?'+this.getSeqData.param;var ajaxParam={success:function(seqData){if(seqData.sequence!==undefined)data[m.name].sequence=seqData.sequence;m.accessBamFile(chr,bpStart,bpEnd,accDefault,[data,magic])},error:function(XMLHttpRequest,textStatus,errorThrown){m.accessBamFile(chr,bpStart,bpEnd,accDefault,[data,magic])},complete:function(){}};ajaxParam.url=jsonUrl;ajaxParam.xhrFields={withCredentials:true};ajaxParam.dataType='json';$.ajax(ajaxParam)}else{this.accessBamFile(chr,bpStart,bpEnd,accDefault,[data,magic])}};WgBam2.prototype.accessBamFile=function(chr,bpStart,bpEnd,accDefault,dataMagic){var m=this;this.bam.readWaitReader(chr,bpStart,bpEnd,function(fetcher){var counter=0;var reads=dataMagic[1];for(var alnEach of fetcher()){reads.push({qname:alnEach[3],flag:alnEach[2],pos:alnEach[0],mapq:alnEach[1],cigar:alnEach[4],seq:alnEach[6],posEnd:alnEach[5],id:alnEach[11],cigarLn:alnEach[12],cigarOp:alnEach[13]});counter++;if(counter%100000==0){alert("Too many read (>= 100000) and some reads truncated. "+chr+":"+bpStart+"-"+bpEnd+" will be incomplete display.");break}}accDefault.success(dataMagic[0]);accDefault.complete()},function(err){accDefault.error(err,err,err);accDefault.complete()})};var WgRnaJnkF=function(fil,name,dispName,option){this.option=(option!==undefined)?option:{};this.option.buttonOnOffFlg=(this.option.buttonOnOffFlg===undefined)?false:option.buttonOnOffFlg;this.name=name;this.dispName=dispName;this.imgObj,this.ojson;this.showType="arc_height";this.maxDepth=0;this.aboidingSpace=0;this.height=20;this.y;this.bb=new BigbedData(fil)};WgRnaJnkF.prototype=new WgRoot();WgRnaJnkF.prototype.paint=function(y,width,chr,start,end,strand){var status=[];var pow=Math.floor(Math.LOG10E*Math.log((end-start+1)/width));if(pow<0)pow=0;var reg=Math.pow(10,pow)*POW_REG;var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);var nameXs=[];var maxDepth=0;for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]){var jnk=this.ojson[pow][chr+"|"+i][this.name];for(var j=0;j<jnk.length;j++){if(jnk[j].up_start<=end&&start<=jnk[j].dwn_end){if(maxDepth<jnk[j].depth)maxDepth=parseFloat(jnk[j].depth)}}}}this.maxDepth=maxDepth;this.aboidingSpace=0;if(this.showType=="arc_height"){this.imgObj.font="10px 'Helvetica'";var strWidth=this.imgObj.measureText(maxDepth).width;this.aboidingSpace=3+5+strWidth}for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]){var jnk=this.ojson[pow][chr+"|"+i][this.name];var y2=y+this.height-1;var y1=y2-5;var y3=y1-10;var y4=y3-5;var y5=y1-((this.height-5)-1)*4/3;for(var j=0;j<jnk.length;j++){var str=parseInt(jnk[j].strand);if(jnk[j].up_start<=end&&start<=jnk[j].up_end){var x1=(jnk[j].up_start-start)*(width-1)/(end-start+1);var x2=(jnk[j].up_end-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}var x3=(jnk[j].up_end-start+0.5)*(width-1)/(end-start+1);if(strand=="-")x3=width-1-x3;if(x1<0)x1=0;if(x2>width-1)x2=width-1;this.imgObj.fillStyle=(str)?"#EE0000":"#888888";this.imgObj.strokeStyle=(str)?"#EE0000":"#888888";this.imgObj.fillRect(x1,y1,x2-x1+1,y2-y1+1)}if(jnk[j].dwn_start<=end&&start<=jnk[j].dwn_end){var x1=(jnk[j].dwn_start-start)*(width-1)/(end-start+1);var x2=(jnk[j].dwn_end-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}var x3=(jnk[j].dwn_start-start+0.5)*(width-1)/(end-start+1);if(strand=="-")x3=width-1-x3;if(x1<0)x1=0;if(x2>width-1)x2=width-1;this.imgObj.fillStyle=(str)?"#888888":"#EE0000";this.imgObj.strokeStyle=(str)?"#888888":"#EE0000";this.imgObj.fillRect(x1,y1,x2-x1+1,y2-y1+1)}var ppm_col=255-(Math.floor(jnk[j].depth)+15);var hex=(this.showType=="arc_height")?"00":this.cov16(ppm_col);this.imgObj.strokeStyle=(str)?"#"+hex+hex+"FF":"#FF"+hex+hex;if(jnk[j].up_start<=end&&start<=jnk[j].dwn_end){var x1=(jnk[j].up_end-start+1)*(width-1)/(end-start+1);var x2=(jnk[j].dwn_start-start)*(width-1)/(end-start+1);if(this.showType=="arc_height"){y5=y1-(((this.height-5)-1)*4/3)*jnk[j].depth/maxDepth}if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}this.imgObj.beginPath();this.imgObj.moveTo(x1,y1);if(Math.abs(Math.floor(x1)-Math.floor(x2))<=1){var y6=(this.showType=="arc_height")?((this.height-5)-1)*jnk[j].depth/maxDepth:(this.height-5)-1;this.imgObj.lineTo(x1,y1-y6)}else{this.imgObj.bezierCurveTo(x1,y5,x2,y5,x2,y1)}this.imgObj.stroke()}}}else{if(i>=0)status.push(i);this.paintLoading(y,width,start,end,strand,i)}}return status};WgRnaJnkF.prototype.paintVScale=function(img,width){var x1=width-3;var y1=this.y;if(this.showType=="arc_height"){var maxDepth=this.maxDepth;img.strokeStyle="#555555";img.fillStyle="#555555";img.beginPath();img.moveTo(x1,this.y);img.lineTo(x1,this.y+this.height);var xM=5;img.moveTo(x1-xM,y1);img.lineTo(x1,y1);img.stroke();img.font="10px 'Helvetica'";var strWidth=img.measureText(maxDepth).width;img.fillText(maxDepth,x1-xM-strWidth,y1+10)}};WgRnaJnkF.prototype.getAboidingLeftPanelSpace=function(){return this.aboidingSpace};WgRnaJnkF.prototype.getMenuPopup=function(){var checked=[];if(this.showType=="arc_height")checked[0]="checked=\"checked\"";if(this.showType=="light_shade")checked[1]="checked=\"checked\"";var htmlStr="";htmlStr+="<div style=\"border:1px solid\"><table border=\"0\" width=\"100%\"><tr><th align=\"left\" bgcolor=\"#aaaaaa\" colspan=\"2\">Setting:</th></tr><tr>";htmlStr+="<td bgcolor=\"#aaaaaa\">&nbsp;</td><td><form>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"arc_height\" id=\"arc_height\" ";htmlStr+=checked[0]+" /><label for=\"arc_height\">Height mode</label></div>";if(!this.option.middle0Flg){htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"light_shade\" id=\"light_shade\" ";htmlStr+=checked[1]+" /><label for=\"light_shade\">Gradation mode</label></div>"}htmlStr+="</form>";htmlStr+="<hr /><a href=\"#\" class=\"det\">Detail...</a>";htmlStr+="</td></tr></table></div>";return htmlStr};WgRnaJnkF.prototype.getMenuDetail=function(){var htmlStr="";htmlStr+="<form><div><strong>Detailed settings</strong></div>";htmlStr+="<div class=\"modal_inbox\">";htmlStr+="<table border=\"0\" width=\"100%\"><tr><td align=\"center\">";htmlStr+="<div>Track height: <input type=\"text\" id=\"height\" size=\"3\" maxlength=\"3\" value=\""+this.height+"\"/></div>";htmlStr+="</td></tr></table></div>";htmlStr+="<div class=\"modal_btn\"><input type=\"button\" id=\"apply_button\" value=\"Apply\" /><input type=\"button\" id=\"cancel_button\" value=\"Cancel\" /></div>";htmlStr+="</form>";return[htmlStr,[300,100]]};WgRnaJnkF.prototype.setViewDetail=function(divId){var height=parseInt($("div"+divId+" div#modal div.container #height").val());if(height<10)height=10;if(height>500)height=500;if(isNaN(height))height=20;this.height=height;return true};WgRnaJnkF.prototype.getName=function(){return this.name};WgRnaJnkF.prototype.getItemDispName=function(){var dispName=(this.dispName)?this.dispName:this.name;return dispName};WgRnaJnkF.prototype.getItemDetailName=function(){return(this.option.itemDetailName)?this.option.itemDetailName:this.getItemDispName()};WgRnaJnkF.prototype.getPannelBgcolor=function(){return(this.option.pannelBgcolor)?this.option.pannelBgcolor:"#EEEEEE"};WgRnaJnkF.prototype.getButtonInfo=function(){var buttonColor=(this.option.buttonColor===undefined)?{"color":["eeeeee","ffcccc"],"onOff":this.option.buttonOnOffFlg}:{"color":this.option.buttonColor,"onOff":this.option.buttonOnOffFlg};return buttonColor};WgRnaJnkF.prototype.accessObj=function(chr,binStart,binEnd,powP,accDefault){var m=this;var bpPerPixel=Math.pow(10,powP);var bpStart=binStart*bpPerPixel*POW_REG+1;var bpEnd=(parseInt(binStart)+1)*bpPerPixel*POW_REG;this.bb.readWaitReader(chr,bpStart,bpEnd,bpPerPixel,function(reductionLevel,fetcher){var data={};var tmp=[];var sorter=[];for(var alnEach of fetcher()){var num=(reductionLevel)?alnEach.maxVal:alnEach.value;if(num===undefined){var bedClm=alnEach.otherClm.split(/\t/);var scoreName=bedClm[0].split(/\|/);var blockStarts=bedClm[8].split(/,/);var blockSizes=bedClm[7].split(/,/);var chromStart=parseInt(alnEach.chromStart);var chromEnd=parseInt(alnEach.chromEnd);var upStart=chromStart+parseInt(blockStarts[0]);var upEnd=upStart+parseInt(blockSizes[0])-1;var dwnStart=chromStart+parseInt(blockStarts[1]);var dwnEnd=dwnStart+parseInt(blockSizes[1])-1;tmp.push({type:"bed",id:scoreName[0],up_start:upStart,up_end:upEnd,dwn_start:dwnStart,dwn_end:dwnEnd,strand:(bedClm[2]=="+")?"1":"0",depth:scoreName[1],name:scoreName[0]})}else{tmp.push({type:"wig",id:alnEach.chromStart,start:alnEach.chromStart,end:alnEach.chromEnd,num:num})}}data[m.name]=tmp;accDefault.success(data);accDefault.complete()},function(err){accDefault.error(err,err,err);accDefault.complete()})};var WgSeqF=function(fil,option){this.imgObj,this.ojson;this.option=(option!==undefined)?option:{};this.option.frameFlg=(this.option.frameFlg===undefined)?true:this.option.frameFlg;this.option.inColorFlg=(this.option.inColorFlg===undefined)?true:this.option.inColorFlg;this.option.buttonOnOffFlg=(this.option.buttonOnOffFlg===undefined)?false:option.buttonOnOffFlg;this.charPx=(this.option.charPx===undefined)?10:this.option.charPx;this.height=12;this.y;this.wg=new WgenomeData(fil)};WgSeqF.prototype=new WgRoot();WgSeqF.prototype.paint=function(y,width,chr,start,end,strand){var status=[];var statusFor={};if(end-start+1<width){var reg=1*POW_REG;var y1=y;var y2=y1+10;this.imgObj.font=this.charPx+"px 'Helvetica'";for(var i=parseInt(start);i<=parseInt(end+1);i++){var bin=Math.floor((i-1)/reg);if(this.ojson["0"]&&this.ojson["0"][chr+"|"+bin]&&this.ojson["0"][chr+"|"+bin]["sequence"]){var char=this.ojson["0"][chr+"|"+bin]["sequence"].charAt(i-1-bin*reg);if(strand=="-"){var tmp=char;if(char=="A")tmp="T";if(char=="a")tmp="t";if(char=="C")tmp="G";if(char=="c")tmp="g";if(char=="G")tmp="C";if(char=="g")tmp="c";if(char=="T")tmp="A";if(char=="t")tmp="a";char=tmp}var x1=(i-start)*(width-1)/(end-start+1);var x2=(i-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}if(this.option.inColorFlg){this.imgObj.fillStyle=(char=="A"||char=="a")?"#88FF88":(char=="C"||char=="c")?"#8888FF":(char=="G"||char=="g")?"#FF8800":(char=="T"||char=="t")?"#FF4488":"#AAAAAA";this.imgObj.fillRect(x1,y1,x2-x1+1,y2-y1+1)}if(x2-x1>this.charPx){this.imgObj.fillStyle="#000000";this.imgObj.fillText(char,(x1+x2)/2-2,y2-1);if(this.option.frameFlg)this.imgObj.strokeRect(x1,y1,x2-x1+1,y2-y1+1)}}else{statusFor[bin]=1}}}for(var bin in statusFor)if(bin>=0)status.push(bin);return status};WgSeqF.prototype.getMenuPopup=function(){var htmlStr="";return htmlStr};WgSeqF.prototype.getName=function(){return"sequence"};WgSeqF.prototype.getItemDispName=function(){return"Sequence"};WgSeqF.prototype.getButtonInfo=function(){var buttonColor=(this.option.buttonColor===undefined)?{"color":["eeeeee","ffcccc"],"onOff":this.option.buttonOnOffFlg}:{"color":this.option.buttonColor,"onOff":this.option.buttonOnOffFlg};return buttonColor};WgSeqF.prototype.accessObj=function(chr,binStart,binEnd,powP,accDefault){var m=this;var bpPerPixel=Math.pow(10,powP);var bpStart=binStart*bpPerPixel*POW_REG+1;var bpEnd=(parseInt(binStart)+1)*bpPerPixel*POW_REG;this.wg.readWaitReader(chr,bpStart,bpEnd,function(fetcher){var seq="";for(var seqEach of fetcher()){seq+=seqEach}var data={};data[m.getName()]=seq;accDefault.success(data);accDefault.complete()},function(err){throw new Error("data not found.");})};var WgRefseqF=function(fil,name,dispName,option){this.name=(name!==undefined)?name:"refGene";this.dispName=(dispName!==undefined)?dispName:"NCBI RefSeq";this.imgObj,this.ojson;this.option=(option!==undefined)?option:{};this.option.spid=(this.option.spid===undefined)?9606:this.option.spid;if(this.option.jsonUrl!==undefined){this.jsonUrl=this.option.jsonUrl}this.fontSize=10;this.eachSqwHeight=10;this.eachHeight=25;this.height;this.y;this.colUtrP=(this.option.colUtr)?this.option.colUtr:"#99CCFF";this.colCdsP=(this.option.colCds)?this.option.colCds:"#44AAFF";this.colBoxP=(this.option.colBox)?this.option.colBox:"#0000FF";this.colUtrM=(this.option.colUtr)?this.option.colUtr:"#FFCC99";this.colCdsM=(this.option.colCds)?this.option.colCds:"#FFAA44";this.colBoxM=(this.option.colBox)?this.option.colBox:"#FF0000";this.showType=(this.option.showType)?this.option.showType:"expanded";var m=this;this.imgCaching={cachingNum:10,applyMinPow:3,getSettingType:function(){return m.fontSize+"|"+m.eachSqwHeight+"|"+m.eachHeight+"|"+m.colUtrP+"|"+m.colCdsP+"|"+m.colBoxP+"|"+m.colUtrM+"|"+m.colCdsM+"|"+m.colBoxM+"|"+m.showType}};this.bb=new BigbedData(fil)};WgRefseqF.prototype=new WgRoot();WgRefseqF.prototype.paint2=function(dt,y,width,chr,start,end,strand){var finView={};var eachHeight=(this.showType=="squished")?this.eachSqwHeight:this.eachHeight;var nameY=(this.showType=="squished")?0:this.fontSize+5;var nameXs=[];for(var i=0;i<dt.length;i++){var refGene=dt[i];for(var j=0;j<refGene.length;j++){if(refGene[j].tx_start<=end&&start<=refGene[j].tx_end){var step=(this.showType=="collapsed")?1:parseInt(refGene[j].step);var y2=y+eachHeight*(step-1)+((eachHeight-nameY)/2);var y1=y2-3;var y3=y2+3;var y4=y+eachHeight*(step-1);var y5=y4+eachHeight-nameY;var y6=y5+this.fontSize/1.4+3;var x1=(refGene[j].tx_start-start)*(width-1)/(end-start+1);var x2=(refGene[j].tx_end-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}if(x1<0)x1=0;if(x2>width-1)x2=width-1;var strandFlg=(refGene[j].strand=="+");this.imgObj.fillStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.fillRect(x1,y2,x2-x1+1,1);var name=refGene[j].name2+" ("+refGene[j].name+")";var id=refGene[j].refgene_id;if(!(id in finView)){this.imgObj.font=this.fontSize+"px 'Helvetica'";var strWidth=this.imgObj.measureText(name).width;var xMin=x1;var xMax=x2;var x7;if(xMin>width/3*2){x7=x1-strWidth/2}else if(xMax<width/3){x7=x2-strWidth/2}else{if(xMin<width/3)xMin=width/3;if(xMax>width/3*2)xMax=width/3*2;x7=(xMin+xMax)/2-strWidth/2}if(x7<0)x7=0;if(x7>width-strWidth)x7=width-strWidth;if(this.showType!="squished"){if(nameXs[step-1]===undefined||(strand!="-"&&nameXs[step-1]+10<x7)||(strand=="-"&&x7+strWidth+10<nameXs[step-1])){nameXs[step-1]=(strand=="-")?x7:x7+strWidth;this.imgObj.fillStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.fillText(name,x7,y6);finView[id]=1}}}var starts=refGene[j].exon_starts.split(",");for(var k=0;k<starts.length;k++){if(starts[k]!="")starts[k]=parseInt(starts[k])}var ends=refGene[j].exon_ends.split(",");for(var k=0;k<ends.length;k++){if(ends[k]!="")ends[k]=parseInt(ends[k])}var cdsStart=refGene[j].cds_start;var cdsEnd=refGene[j].cds_end;if(refGene[j].tx_start==cdsStart&&cdsEnd+1==cdsStart){cdsStart--}for(var k=0;k<starts.length;k++){if(starts[k]==""||end<starts[k])break;if(ends[k]<start)continue;if(cdsStart<=starts[k]&&ends[k]<=cdsEnd){var x5=(starts[k]-start)*(width-1)/(end-start+1);var x6=(ends[k]-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x5;x5=width-1-x6;x6=tmp}this.imgObj.fillStyle=(strandFlg)?this.colCdsP:this.colCdsM;this.imgObj.fillRect(x5,y4,x6-x5+1,y5-y4);this.imgObj.strokeStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.strokeRect(x5,y4,x6-x5+1,y5-y4)}else{var x3=(starts[k]-start)*(width-1)/(end-start+1);var x4=(ends[k]-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x3;x3=width-1-x4;x4=tmp}this.imgObj.fillStyle=(strandFlg)?this.colUtrP:this.colUtrM;this.imgObj.fillRect(x3,y1,x4-x3+1,y3-y1);this.imgObj.strokeStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.strokeRect(x3,y1,x4-x3+1,y3-y1);if((starts[k]<=cdsStart&&cdsStart<=ends[k])||(starts[k]<=cdsEnd&&cdsEnd<=ends[k])){var cdsSPoi=(starts[k]<=cdsStart&&cdsStart<=ends[k])?cdsStart:starts[k];var cdsEPoi=(starts[k]<=cdsEnd&&cdsEnd<=ends[k])?cdsEnd:ends[k];var x5=(cdsSPoi-start)*(width-1)/(end-start+1);var x6=(cdsEPoi-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x5;x5=width-1-x6;x6=tmp}this.imgObj.fillStyle=(strandFlg)?this.colCdsP:this.colCdsM;this.imgObj.fillRect(x5,y4,x6-x5+1,y5-y4);this.imgObj.strokeStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.strokeRect(x5,y4,x6-x5+1,y5-y4)}}}this.imgObj.strokeStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.beginPath();for(var k=x1;k<x2-5;k+=50){if((strandFlg&&strand!="-")||(!strandFlg&&strand=="-")){this.imgObj.moveTo(k,y2-2);this.imgObj.lineTo(k+5,y2);this.imgObj.lineTo(k,y2+2)}else{this.imgObj.moveTo(k+5,y2-2);this.imgObj.lineTo(k,y2);this.imgObj.lineTo(k+5,y2+2)}}this.imgObj.stroke()}}}};WgRefseqF.prototype.setHeight2=function(dt,width,chr,start,end){var eachHeight=(this.showType=="squished")?this.eachSqwHeight:this.eachHeight;var maxStep=1;if(this.showType!="collapsed"){for(var i=0;i<dt.length;i++){var refGene=dt[i];for(var j=0;j<refGene.length;j++){if(refGene[j].tx_start<=end&&start<=refGene[j].tx_end){var step=parseInt(refGene[j].step);if(maxStep<step)maxStep=step}}}}this.height=eachHeight*maxStep};WgRefseqF.prototype.getMenuPopup=function(){var checked=new Array("","","");if(this.showType=="collapsed")checked[0]="checked=\"checked\"";if(this.showType=="expanded")checked[1]="checked=\"checked\"";if(this.showType=="squished")checked[2]="checked=\"checked\"";var htmlStr="";htmlStr+="<div style=\"border:1px solid\"><table border=\"0\" width=\"100%\"><tr><th align=\"left\" bgcolor=\"#aaaaaa\" colspan=\"2\">Setting:</th></tr><tr>";htmlStr+="<td bgcolor=\"#aaaaaa\">&nbsp;</td><td><form>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"collapsed\" id=\"collapsed\" ";htmlStr+=checked[0]+" /><label for=\"collapsed\">Collapsed</label></div>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"expanded\" id=\"expanded\" ";htmlStr+=checked[1]+" /><label for=\"expanded\">Expanded</label></div>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"squished\" id=\"squished\" ";htmlStr+=checked[2]+" /><label for=\"squished\">Squished</label></div>";htmlStr+="</form>";htmlStr+="<hr /><a href=\"#\" class=\"det\">Detail...</a>";htmlStr+="</td></tr></table></div>";htmlStr+="<hr /><a href=\"#\" class=\"help\">Help</a>";return htmlStr};WgRefseqF.prototype.getMenuDetail=function(){var htmlStr="";htmlStr+="<form><div><strong>Detailed settings</strong></div>";htmlStr+="<div class=\"modal_inbox\">";htmlStr+="<table border=\"0\" width=\"100%\"><tr><td align=\"center\">";htmlStr+="<div>Font size: <input type=\"text\" id=\"font_size\" size=\"2\" maxlength=\"2\" value=\""+this.fontSize+"\" />px</div>";htmlStr+="</td></tr></table><hr />";htmlStr+="<table border=\"0\" width=\"100%\"><tr><td align=\"center\">";htmlStr+="<table border=\"1\">";htmlStr+="<tr><th align=\"left\" colspan=\"3\"><a target=\"_blank\" href=\"http://www.theodora.com/gif4/html_colors.gif\">Coloring: </a></td></tr>";htmlStr+="<tr><td rowspan=\"3\">Plus strand</td><td nowrap>Base color: #<input type=\"text\" id=\"colbox_p\" size=\"6\" maxlength=\"6\" value=\""+this.colBoxP.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colbox_p_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td nowrap>CDS color: #<input type=\"text\" id=\"colcds_p\" size=\"6\" maxlength=\"6\" value=\""+this.colCdsP.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colcds_p_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td nowrap>UTR color: #<input type=\"text\" id=\"colutr_p\" size=\"6\" maxlength=\"6\" value=\""+this.colUtrP.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colutr_p_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td rowspan=\"3\">Minus strand</td><td nowrap>Base color: #<input type=\"text\" id=\"colbox_m\" size=\"6\" maxlength=\"6\" value=\""+this.colBoxM.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colbox_m_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td nowrap>CDS color: #<input type=\"text\" id=\"colcds_m\" size=\"6\" maxlength=\"6\" value=\""+this.colCdsM.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colcds_m_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td nowrap>UTR color: #<input type=\"text\" id=\"colutr_m\" size=\"6\" maxlength=\"6\" value=\""+this.colUtrM.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colutr_m_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</table>";htmlStr+="<div>&nbsp;</div>";htmlStr+="</td></tr></table></div>";htmlStr+="<div class=\"modal_btn\"><input type=\"button\" id=\"apply_button\" value=\"Apply\" /><input type=\"button\" id=\"cancel_button\" value=\"Cancel\" /></div>";htmlStr+="</form>";return[htmlStr,[300,320]]};WgRefseqF.prototype.getHelpData=function(){var htmlStr="";htmlStr+="<form><table border=\"0\" width=\"100%\"><tr><td align=\"center\">";htmlStr+="NCBI RefSeq track";htmlStr+="<div>&nbsp;</div>";htmlStr+="<div><input type=\"button\" id=\"ok_button\" value=\"OK\" /></div>";htmlStr+="</td></tr></table></form>";return[htmlStr,[200,80]]};WgRefseqF.prototype.menuDetailAction=function(parent){var id,bgcol;id="colbox_p";bgcol=this.colBoxP;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colcds_p";bgcol=this.colCdsP;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colutr_p";bgcol=this.colUtrP;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colbox_m";bgcol=this.colBoxM;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colcds_m";bgcol=this.colCdsM;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colutr_m";bgcol=this.colUtrM;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())})};WgRefseqF.prototype.setViewDetail=function(divId){this.colBoxP="#"+$("div"+divId+" div#modal div.container #colbox_p").val();this.colCdsP="#"+$("div"+divId+" div#modal div.container #colcds_p").val();this.colUtrP="#"+$("div"+divId+" div#modal div.container #colutr_p").val();this.colBoxM="#"+$("div"+divId+" div#modal div.container #colbox_m").val();this.colCdsM="#"+$("div"+divId+" div#modal div.container #colcds_m").val();this.colUtrM="#"+$("div"+divId+" div#modal div.container #colutr_m").val();var fontSize=parseInt($("div"+divId+" div#modal div.container #font_size").val());if(fontSize<5)fontSize=5;if(fontSize>50)fontSize=50;if(isNaN(fontSize))fontSize=10;this.fontSize=fontSize;this.eachHeight=this.eachSqwHeight+this.fontSize+5;return true};WgRefseqF.prototype.getPopupData=function(y,width,chr,start,end,strand){var popup={};if(this.name=="refGene"){var eachHeight=(this.showType=="squished")?this.eachSqwHeight:this.eachHeight;var nameY=(this.showType=="squished")?0:this.fontSize+5;var pow=Math.floor(Math.LOG10E*Math.log((end-start+1)/width));if(pow<0)pow=0;var reg=Math.pow(10,pow)*POW_REG;var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);var nameXs=[];for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]){var refGene=this.ojson[pow][chr+"|"+i][this.name];for(var j=0;j<refGene.length;j++){if(refGene[j].tx_start<=end&&start<=refGene[j].tx_end){var step=(this.showType=="collapsed")?1:parseInt(refGene[j].step);var y1=y+eachHeight*(step-1);var y2=y1+eachHeight-nameY;var x1=(refGene[j].tx_start-start)*(width-1)/(end-start+1);var x2=(refGene[j].tx_end-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}if(x1<0)x1=0;if(x2>width-1)x2=width-1;var yStr=y1+","+y2;if(!(yStr in popup))popup[yStr]={};var xStr=x1+","+x2;var htmlStr="<table border=\"1\">";htmlStr+="<tr>";htmlStr+="<th>Gene ID</th>";htmlStr+="<td>"+refGene[j].name2+"</td>";htmlStr+="</tr>";htmlStr+="<tr>";htmlStr+="<th>Transcript ID</th>";htmlStr+="<td>"+refGene[j].name+"</td>";htmlStr+="</tr>";htmlStr+="<tr>";htmlStr+="<th>Go to</th>";htmlStr+="<td>";htmlStr+="<a href=\"#\" id=\"dbtss_link\">DBTSS</a>, ";htmlStr+="<a href=\"#\" onclick=\"window.open('http://www.ncbi.nlm.nih.gov/gene/?term="+refGene[j].name+"', '_blank')\">NCBI</a>";htmlStr+="</td>";htmlStr+="</tr>";htmlStr+="</table>";popup[yStr][xStr]={"html":htmlStr,"actionParam":[chr+":"+refGene[j].tx_start+"-"+refGene[j].tx_end+":"+refGene[j].strand,refGene[j].name2,this.option.spid],"action":function(d,p){(function(){var pCp=p;$("#right_pop #dbtss_link").click(function(){var region=pCp[0];var name=pCp[1];var regList=region.split(":");var se=regList[1].split("-");var nameStr=(name!==undefined)?"&name="+name:"";var lng=se[1]-se[0]+1;var modS=(regList[2]=="+")?4:10;var start=Math.floor(parseInt(se[0])-lng/modS);var modE=(regList[2]=="+")?10:4;var end=Math.floor(parseInt(se[1])+lng/modE);var topParam="SEE=1&UID=2"+nameStr+"&taxid="+pCp[2]+"&region="+regList[0]+":"+start+"-"+end+":"+regList[2];var bottomStart,bottomEnd;if(regList[2]=="+"){bottomStart=parseInt(se[0])-250;bottomEnd=parseInt(se[0])+250-1}else{bottomStart=parseInt(se[1])-250+1;bottomEnd=parseInt(se[1])+250}var bottomParam="SEE=1&UID=2&taxid="+pCp[2]+"&region="+regList[0]+":"+bottomStart+"-"+bottomEnd+":"+regList[2];$("#err").html("");$("#result").html("<div id='result_top'></div><div id='result_bottom'></div>");$("#result_top").html("<img src='icons/loading.gif' /> waiting...");$("#result_bottom").html("<img src='icons/loading.gif' /> waiting...");$.ajax({url:"https://dbtss.hgc.jp/cgi-bin/dbtss_view_top.cgi?"+topParam,data:"",dataType:'html',success:function(htmlStr){$("#result_top").html(htmlStr)},error:function(data){$("#err").html("<h3><font color='red'>Error: Cannot access to "+this.url+"</font></h3>");$("#result_top").html("")},complete:function(data){}});$.ajax({url:"https://dbtss.hgc.jp/cgi-bin/dbtss_view_detail.cgi?"+bottomParam,data:"",dataType:'html',success:function(htmlStr){$("#result_bottom").html(htmlStr)},error:function(data){$("#err").html("<h3><font color='red'>Error: Cannot access to "+this.url+"</font></h3>");$("#result_bottom").html("")},complete:function(data){}});return false})})()}}}}}}}return popup};WgRefseqF.prototype.setImgJson=function(imgObj,ojson,genome){this.imgObj=imgObj;this.ojson=ojson;this.chrSize=genome;if(this.option.initJson!==undefined&&!this.importedFlg){this.importedFlg=true;for(var chr in this.chrSize){var size=this.chrSize[chr][1];for(var pow=0;pow<=5;pow++){if(this.ojson[pow]===undefined)this.ojson[pow]={};var binEnd=Math.floor((size-1)/(Math.pow(10,pow)*POW_REG));for(var bin=0;bin<=binEnd;bin++){var chrBin=chr+"|"+bin;if(this.ojson[pow][chrBin]===undefined)this.ojson[pow][chrBin]={};if(this.ojson[pow][chrBin][this.name]===undefined)this.ojson[pow][chrBin][this.name]=[]}}}var initJson=this.option.initJson;for(var chr in initJson){var tmpDt={};var sorter={};var initJsonChr=initJson[chr];var geneHash=[];for(var i=0;i<initJsonChr.length;i++){var gene=initJsonChr[i];var inp={"name":gene[0],"strand":gene[1],"tx_start":gene[2],"tx_end":gene[3],"exon_starts":gene[6],"exon_ends":gene[7],"name2":gene[8],"refgene_id":gene[9],"step":gene[10]};if(gene[4]!=""){inp.cds_start=gene[4];inp.cds_end=gene[5]}geneHash.push(inp);var txStart=gene[2];var txEnd=gene[3];for(var pow=0;pow<=5;pow++){var binStart=Math.floor((txStart-1)/(Math.pow(10,pow)*POW_REG));var binEnd=Math.floor((txEnd-1)/(Math.pow(10,pow)*POW_REG));for(var bin=binStart;bin<=binEnd;bin++){if(tmpDt[pow]===undefined){tmpDt[pow]={};sorter[pow]={}}if(tmpDt[pow][bin]===undefined){tmpDt[pow][bin]={};sorter[pow][bin]=[]}if(tmpDt[pow][bin][txStart]===undefined){tmpDt[pow][bin][txStart]=[];sorter[pow][bin].push(txStart)}tmpDt[pow][bin][txStart].push(i)}}}for(var pow in tmpDt){for(var bin in tmpDt[pow]){var chrBin=chr+"|"+bin;sorter[pow][bin].sort(function(a,b){if(a>b)return 1;if(a<b)return-1;return 0});for(var j=0;j<sorter[pow][bin].length;j++){var txStart=sorter[pow][bin][j];var iList=tmpDt[pow][bin][txStart];for(var i=0;i<iList.length;i++){this.ojson[pow][chrBin][this.name].push(geneHash[iList[i]])}}}}}}};WgRefseqF.prototype.getName=function(){return this.name};WgRefseqF.prototype.getItemDispName=function(){return this.dispName};WgRefseqF.prototype.accessObj=function(chr,binStart,binEnd,powP,accDefault){var m=this;var bpPerPixel=Math.pow(10,powP);var bpStart=binStart*bpPerPixel*POW_REG+1;var bpEnd=(parseInt(binStart)+1)*bpPerPixel*POW_REG;this.bb.readWaitReader(chr,bpStart,bpEnd,1,function(reductionLevel,fetcher){var data={};var tmp=[];var sorter=[];for(var alnEach of fetcher()){var num=(reductionLevel)?alnEach.maxVal:alnEach.value;if(num===undefined){var bedClm=alnEach.otherClm.split(/\t/);var stepName=bedClm[0].split(/\|/,3);var blockStarts=bedClm[8].split(/,/);var blockSizes=bedClm[7].split(/,/);var chromStart=parseInt(alnEach.chromStart);var chromEnd=parseInt(alnEach.chromEnd);var cdsStart=parseInt(bedClm[3])+1;var cdsEnd=parseInt(bedClm[4]);var exonStarts="";var exonEnds="";for(var i=0;i<blockStarts.length;i++){var blockStart=chromStart+parseInt(blockStarts[i]);var blockEnd=blockStart+parseInt(blockSizes[i])-1;if(exonStarts!="")exonStarts+=",";exonStarts+=blockStart;if(exonEnds!="")exonEnds+=",";exonEnds+=blockEnd}tmp.push({type:"bed",refgene_id:bedClm[0],name:stepName[1],name2:stepName[2],strand:bedClm[2],tx_start:chromStart,tx_end:chromEnd,cds_start:cdsStart,cds_end:cdsEnd,exon_starts:exonStarts,exon_ends:exonEnds,step:stepName[0]})}else{tmp.push({type:"wig",id:alnEach.chromStart,start:alnEach.chromStart,end:alnEach.chromEnd,num:num})}}data[m.name]=tmp;accDefault.success(data);accDefault.complete()},function(err){accDefault.error(err,err,err);accDefault.complete()})};var WgRefseq=function(name,dispName,option){this.name=(name!==undefined)?name:"refGene";this.dispName=(dispName!==undefined)?dispName:"NCBI RefSeq";this.imgObj,this.ojson;this.option=(option!==undefined)?option:{};this.option.spid=(this.option.spid===undefined)?9606:this.option.spid;if(this.option.jsonUrl!==undefined){this.jsonUrl=this.option.jsonUrl}this.fontSize=10;this.eachSqwHeight=10;this.eachHeight=25;this.height;this.y;this.colUtrP=(this.option.colUtr)?this.option.colUtr:"#99CCFF";this.colCdsP=(this.option.colCds)?this.option.colCds:"#44AAFF";this.colBoxP=(this.option.colBox)?this.option.colBox:"#0000FF";this.colUtrM=(this.option.colUtr)?this.option.colUtr:"#FFCC99";this.colCdsM=(this.option.colCds)?this.option.colCds:"#FFAA44";this.colBoxM=(this.option.colBox)?this.option.colBox:"#FF0000";this.showType=(this.option.showType)?this.option.showType:"expanded";var m=this;this.imgCaching={cachingNum:10,applyMinPow:3,getSettingType:function(){return m.fontSize+"|"+m.eachSqwHeight+"|"+m.eachHeight+"|"+m.colUtrP+"|"+m.colCdsP+"|"+m.colBoxP+"|"+m.colUtrM+"|"+m.colCdsM+"|"+m.colBoxM+"|"+m.showType}}};WgRefseq.prototype=new WgRoot();WgRefseq.prototype.paint2=function(dt,y,width,chr,start,end,strand){var finView={};var eachHeight=(this.showType=="squished")?this.eachSqwHeight:this.eachHeight;var nameY=(this.showType=="squished")?0:this.fontSize+5;var nameXs=[];for(var i=0;i<dt.length;i++){var refGene=dt[i];for(var j=0;j<refGene.length;j++){if(refGene[j].tx_start<=end&&start<=refGene[j].tx_end){var step=(this.showType=="collapsed")?1:parseInt(refGene[j].step);var y2=y+eachHeight*(step-1)+((eachHeight-nameY)/2);var y1=y2-3;var y3=y2+3;var y4=y+eachHeight*(step-1);var y5=y4+eachHeight-nameY;var y6=y5+this.fontSize/1.4+3;var x1=(refGene[j].tx_start-start)*(width-1)/(end-start+1);var x2=(refGene[j].tx_end-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}if(x1<0)x1=0;if(x2>width-1)x2=width-1;var strandFlg=(refGene[j].strand=="+");this.imgObj.fillStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.fillRect(x1,y2,x2-x1+1,1);var name=refGene[j].name2+" ("+refGene[j].name+")";var id=refGene[j].refgene_id;if(!(id in finView)){this.imgObj.font=this.fontSize+"px 'Helvetica'";var strWidth=this.imgObj.measureText(name).width;var xMin=x1;var xMax=x2;var x7;if(xMin>width/3*2){x7=x1-strWidth/2}else if(xMax<width/3){x7=x2-strWidth/2}else{if(xMin<width/3)xMin=width/3;if(xMax>width/3*2)xMax=width/3*2;x7=(xMin+xMax)/2-strWidth/2}if(x7<0)x7=0;if(x7>width-strWidth)x7=width-strWidth;if(this.showType!="squished"){if(nameXs[step-1]===undefined||(strand!="-"&&nameXs[step-1]+10<x7)||(strand=="-"&&x7+strWidth+10<nameXs[step-1])){nameXs[step-1]=(strand=="-")?x7:x7+strWidth;this.imgObj.fillStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.fillText(name,x7,y6);finView[id]=1}}}var starts=refGene[j].exon_starts.split(",");for(var k=0;k<starts.length;k++){if(starts[k]!="")starts[k]=parseInt(starts[k])}var ends=refGene[j].exon_ends.split(",");for(var k=0;k<ends.length;k++){if(ends[k]!="")ends[k]=parseInt(ends[k])}var cdsStart=refGene[j].cds_start;var cdsEnd=refGene[j].cds_end;for(var k=0;k<starts.length;k++){if(starts[k]==""||end<starts[k])break;if(ends[k]<start)continue;if(cdsStart<=starts[k]&&ends[k]<=cdsEnd){var x5=(starts[k]-start)*(width-1)/(end-start+1);var x6=(ends[k]-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x5;x5=width-1-x6;x6=tmp}this.imgObj.fillStyle=(strandFlg)?this.colCdsP:this.colCdsM;this.imgObj.fillRect(x5,y4,x6-x5+1,y5-y4);this.imgObj.strokeStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.strokeRect(x5,y4,x6-x5+1,y5-y4)}else{var x3=(starts[k]-start)*(width-1)/(end-start+1);var x4=(ends[k]-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x3;x3=width-1-x4;x4=tmp}this.imgObj.fillStyle=(strandFlg)?this.colUtrP:this.colUtrM;this.imgObj.fillRect(x3,y1,x4-x3+1,y3-y1);this.imgObj.strokeStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.strokeRect(x3,y1,x4-x3+1,y3-y1);if((starts[k]<=cdsStart&&cdsStart<=ends[k])||(starts[k]<=cdsEnd&&cdsEnd<=ends[k])){var cdsSPoi=(starts[k]<=cdsStart&&cdsStart<=ends[k])?cdsStart:starts[k];var cdsEPoi=(starts[k]<=cdsEnd&&cdsEnd<=ends[k])?cdsEnd:ends[k];var x5=(cdsSPoi-start)*(width-1)/(end-start+1);var x6=(cdsEPoi-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x5;x5=width-1-x6;x6=tmp}this.imgObj.fillStyle=(strandFlg)?this.colCdsP:this.colCdsM;this.imgObj.fillRect(x5,y4,x6-x5+1,y5-y4);this.imgObj.strokeStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.strokeRect(x5,y4,x6-x5+1,y5-y4)}}}this.imgObj.strokeStyle=(strandFlg)?this.colBoxP:this.colBoxM;this.imgObj.beginPath();for(var k=x1;k<x2-5;k+=50){if((strandFlg&&strand!="-")||(!strandFlg&&strand=="-")){this.imgObj.moveTo(k,y2-2);this.imgObj.lineTo(k+5,y2);this.imgObj.lineTo(k,y2+2)}else{this.imgObj.moveTo(k+5,y2-2);this.imgObj.lineTo(k,y2);this.imgObj.lineTo(k+5,y2+2)}}this.imgObj.stroke()}}}};WgRefseq.prototype.setHeight2=function(dt,width,chr,start,end){var eachHeight=(this.showType=="squished")?this.eachSqwHeight:this.eachHeight;var maxStep=1;if(this.showType!="collapsed"){for(var i=0;i<dt.length;i++){var refGene=dt[i];for(var j=0;j<refGene.length;j++){if(refGene[j].tx_start<=end&&start<=refGene[j].tx_end){var step=parseInt(refGene[j].step);if(maxStep<step)maxStep=step}}}}this.height=eachHeight*maxStep};WgRefseq.prototype.getMenuPopup=function(){var checked=new Array("","","");if(this.showType=="collapsed")checked[0]="checked=\"checked\"";if(this.showType=="expanded")checked[1]="checked=\"checked\"";if(this.showType=="squished")checked[2]="checked=\"checked\"";var htmlStr="";htmlStr+="<div style=\"border:1px solid\"><table border=\"0\" width=\"100%\"><tr><th align=\"left\" bgcolor=\"#aaaaaa\" colspan=\"2\">Setting:</th></tr><tr>";htmlStr+="<td bgcolor=\"#aaaaaa\">&nbsp;</td><td><form>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"collapsed\" id=\"collapsed\" ";htmlStr+=checked[0]+" /><label for=\"collapsed\">Collapsed</label></div>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"expanded\" id=\"expanded\" ";htmlStr+=checked[1]+" /><label for=\"expanded\">Expanded</label></div>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"squished\" id=\"squished\" ";htmlStr+=checked[2]+" /><label for=\"squished\">Squished</label></div>";htmlStr+="</form>";htmlStr+="<hr /><a href=\"#\" class=\"det\">Detail...</a>";htmlStr+="</td></tr></table></div>";htmlStr+="<hr /><a href=\"#\" class=\"help\">Help</a>";return htmlStr};WgRefseq.prototype.getMenuDetail=function(){var htmlStr="";htmlStr+="<form><div><strong>Detailed settings</strong></div>";htmlStr+="<div class=\"modal_inbox\">";htmlStr+="<table border=\"0\" width=\"100%\"><tr><td align=\"center\">";htmlStr+="<div>Font size: <input type=\"text\" id=\"font_size\" size=\"2\" maxlength=\"2\" value=\""+this.fontSize+"\" />px</div>";htmlStr+="</td></tr></table><hr />";htmlStr+="<table border=\"0\" width=\"100%\"><tr><td align=\"center\">";htmlStr+="<table border=\"1\">";htmlStr+="<tr><th align=\"left\" colspan=\"3\"><a target=\"_blank\" href=\"http://www.theodora.com/gif4/html_colors.gif\">Coloring: </a></td></tr>";htmlStr+="<tr><td rowspan=\"3\">Plus strand</td><td nowrap>Base color: #<input type=\"text\" id=\"colbox_p\" size=\"6\" maxlength=\"6\" value=\""+this.colBoxP.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colbox_p_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td nowrap>CDS color: #<input type=\"text\" id=\"colcds_p\" size=\"6\" maxlength=\"6\" value=\""+this.colCdsP.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colcds_p_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td nowrap>UTR color: #<input type=\"text\" id=\"colutr_p\" size=\"6\" maxlength=\"6\" value=\""+this.colUtrP.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colutr_p_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td rowspan=\"3\">Minus strand</td><td nowrap>Base color: #<input type=\"text\" id=\"colbox_m\" size=\"6\" maxlength=\"6\" value=\""+this.colBoxM.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colbox_m_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td nowrap>CDS color: #<input type=\"text\" id=\"colcds_m\" size=\"6\" maxlength=\"6\" value=\""+this.colCdsM.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colcds_m_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</tr>";htmlStr+="<tr><td nowrap>UTR color: #<input type=\"text\" id=\"colutr_m\" size=\"6\" maxlength=\"6\" value=\""+this.colUtrM.substr(1)+"\"/></td>";htmlStr+="<td align=\"center\"><table><tr><td bgcolor=\"white\" id=\"colutr_m_td\">&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></td>";htmlStr+="</table>";htmlStr+="<div>&nbsp;</div>";htmlStr+="</td></tr></table></div>";htmlStr+="<div class=\"modal_btn\"><input type=\"button\" id=\"apply_button\" value=\"Apply\" /><input type=\"button\" id=\"cancel_button\" value=\"Cancel\" /></div>";htmlStr+="</form>";return[htmlStr,[300,320]]};WgRefseq.prototype.getHelpData=function(){var htmlStr="";htmlStr+="<form><table border=\"0\" width=\"100%\"><tr><td align=\"center\">";htmlStr+="NCBI RefSeq track";htmlStr+="<div>&nbsp;</div>";htmlStr+="<div><input type=\"button\" id=\"ok_button\" value=\"OK\" /></div>";htmlStr+="</td></tr></table></form>";return[htmlStr,[200,80]]};WgRefseq.prototype.menuDetailAction=function(parent){var id,bgcol;id="colbox_p";bgcol=this.colBoxP;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colcds_p";bgcol=this.colCdsP;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colutr_p";bgcol=this.colUtrP;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colbox_m";bgcol=this.colBoxM;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colcds_m";bgcol=this.colCdsM;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())});id="colutr_m";bgcol=this.colUtrM;$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("background-color",bgcol);$("div"+parent.divId+" div#modal div.container #"+id+"_td").css("border","solid 1px");$("div"+parent.divId+" div#modal div.container #"+id).change(function(){$("div"+parent.divId+" div#modal div.container #"+$(this).attr("id")+"_td").css("background-color","#"+$(this).val())})};WgRefseq.prototype.setViewDetail=function(divId){this.colBoxP="#"+$("div"+divId+" div#modal div.container #colbox_p").val();this.colCdsP="#"+$("div"+divId+" div#modal div.container #colcds_p").val();this.colUtrP="#"+$("div"+divId+" div#modal div.container #colutr_p").val();this.colBoxM="#"+$("div"+divId+" div#modal div.container #colbox_m").val();this.colCdsM="#"+$("div"+divId+" div#modal div.container #colcds_m").val();this.colUtrM="#"+$("div"+divId+" div#modal div.container #colutr_m").val();var fontSize=parseInt($("div"+divId+" div#modal div.container #font_size").val());if(fontSize<5)fontSize=5;if(fontSize>50)fontSize=50;if(isNaN(fontSize))fontSize=10;this.fontSize=fontSize;this.eachHeight=this.eachSqwHeight+this.fontSize+5;return true};WgRefseq.prototype.getPopupData=function(y,width,chr,start,end,strand){var popup={};if(this.name=="refGene"){var eachHeight=(this.showType=="squished")?this.eachSqwHeight:this.eachHeight;var nameY=(this.showType=="squished")?0:this.fontSize+5;var pow=Math.floor(Math.LOG10E*Math.log((end-start+1)/width));if(pow<0)pow=0;var reg=Math.pow(10,pow)*POW_REG;var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);var nameXs=[];for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]){var refGene=this.ojson[pow][chr+"|"+i][this.name];for(var j=0;j<refGene.length;j++){if(refGene[j].tx_start<=end&&start<=refGene[j].tx_end){var step=(this.showType=="collapsed")?1:parseInt(refGene[j].step);var y1=y+eachHeight*(step-1);var y2=y1+eachHeight-nameY;var x1=(refGene[j].tx_start-start)*(width-1)/(end-start+1);var x2=(refGene[j].tx_end-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}if(x1<0)x1=0;if(x2>width-1)x2=width-1;var yStr=y1+","+y2;if(!(yStr in popup))popup[yStr]={};var xStr=x1+","+x2;var htmlStr="<table border=\"1\">";htmlStr+="<tr>";htmlStr+="<th>Gene ID</th>";htmlStr+="<td>"+refGene[j].name2+"</td>";htmlStr+="</tr>";htmlStr+="<tr>";htmlStr+="<th>Transcript ID</th>";htmlStr+="<td>"+refGene[j].name+"</td>";htmlStr+="</tr>";htmlStr+="<tr>";htmlStr+="<th>Go to</th>";htmlStr+="<td>";htmlStr+="<a href=\"#\" id=\"dbtss_link\">DBTSS</a>, ";htmlStr+="<a href=\"#\" onclick=\"window.open('http://www.ncbi.nlm.nih.gov/gene/?term="+refGene[j].name+"', '_blank')\">NCBI</a>";htmlStr+="</td>";htmlStr+="</tr>";htmlStr+="</table>";popup[yStr][xStr]={"html":htmlStr,"actionParam":[chr+":"+refGene[j].tx_start+"-"+refGene[j].tx_end+":"+refGene[j].strand,refGene[j].name2,this.option.spid],"action":function(d,p){(function(){var pCp=p;$("#right_pop #dbtss_link").click(function(){var region=pCp[0];var name=pCp[1];var regList=region.split(":");var se=regList[1].split("-");var nameStr=(name!==undefined)?"&name="+name:"";var lng=se[1]-se[0]+1;var modS=(regList[2]=="+")?4:10;var start=Math.floor(parseInt(se[0])-lng/modS);var modE=(regList[2]=="+")?10:4;var end=Math.floor(parseInt(se[1])+lng/modE);var topParam="SEE=1&UID=2"+nameStr+"&taxid="+pCp[2]+"&region="+regList[0]+":"+start+"-"+end+":"+regList[2];var bottomStart,bottomEnd;if(regList[2]=="+"){bottomStart=parseInt(se[0])-250;bottomEnd=parseInt(se[0])+250-1}else{bottomStart=parseInt(se[1])-250+1;bottomEnd=parseInt(se[1])+250}var bottomParam="SEE=1&UID=2&taxid="+pCp[2]+"&region="+regList[0]+":"+bottomStart+"-"+bottomEnd+":"+regList[2];$("#err").html("");$("#result").html("<div id='result_top'></div><div id='result_bottom'></div>");$("#result_top").html("<img src='icons/loading.gif' /> waiting...");$("#result_bottom").html("<img src='icons/loading.gif' /> waiting...");$.ajax({url:"https://dbtss.hgc.jp/cgi-bin/dbtss_view_top.cgi?"+topParam,data:"",dataType:'html',success:function(htmlStr){$("#result_top").html(htmlStr)},error:function(data){$("#err").html("<h3><font color='red'>Error: Cannot access to "+this.url+"</font></h3>");$("#result_top").html("")},complete:function(data){}});$.ajax({url:"https://dbtss.hgc.jp/cgi-bin/dbtss_view_detail.cgi?"+bottomParam,data:"",dataType:'html',success:function(htmlStr){$("#result_bottom").html(htmlStr)},error:function(data){$("#err").html("<h3><font color='red'>Error: Cannot access to "+this.url+"</font></h3>");$("#result_bottom").html("")},complete:function(data){}});return false})})()}}}}}}}return popup};WgRefseq.prototype.setImgJson=function(imgObj,ojson,genome){this.imgObj=imgObj;this.ojson=ojson;this.chrSize=genome;if(this.option.initJson!==undefined&&!this.importedFlg){this.importedFlg=true;for(var chr in this.chrSize){var size=this.chrSize[chr][1];for(var pow=0;pow<=5;pow++){if(this.ojson[pow]===undefined)this.ojson[pow]={};var binEnd=Math.floor((size-1)/(Math.pow(10,pow)*POW_REG));for(var bin=0;bin<=binEnd;bin++){var chrBin=chr+"|"+bin;if(this.ojson[pow][chrBin]===undefined)this.ojson[pow][chrBin]={};if(this.ojson[pow][chrBin][this.name]===undefined)this.ojson[pow][chrBin][this.name]=[]}}}var initJson=this.option.initJson;for(var chr in initJson){var tmpDt={};var sorter={};var initJsonChr=initJson[chr];var geneHash=[];for(var i=0;i<initJsonChr.length;i++){var gene=initJsonChr[i];var inp={"name":gene[0],"strand":gene[1],"tx_start":gene[2],"tx_end":gene[3],"exon_starts":gene[6],"exon_ends":gene[7],"name2":gene[8],"refgene_id":gene[9],"step":gene[10]};if(gene[4]!=""){inp.cds_start=gene[4];inp.cds_end=gene[5]}geneHash.push(inp);var txStart=gene[2];var txEnd=gene[3];for(var pow=0;pow<=5;pow++){var binStart=Math.floor((txStart-1)/(Math.pow(10,pow)*POW_REG));var binEnd=Math.floor((txEnd-1)/(Math.pow(10,pow)*POW_REG));for(var bin=binStart;bin<=binEnd;bin++){if(tmpDt[pow]===undefined){tmpDt[pow]={};sorter[pow]={}}if(tmpDt[pow][bin]===undefined){tmpDt[pow][bin]={};sorter[pow][bin]=[]}if(tmpDt[pow][bin][txStart]===undefined){tmpDt[pow][bin][txStart]=[];sorter[pow][bin].push(txStart)}tmpDt[pow][bin][txStart].push(i)}}}for(var pow in tmpDt){for(var bin in tmpDt[pow]){var chrBin=chr+"|"+bin;sorter[pow][bin].sort(function(a,b){if(a>b)return 1;if(a<b)return-1;return 0});for(var j=0;j<sorter[pow][bin].length;j++){var txStart=sorter[pow][bin][j];var iList=tmpDt[pow][bin][txStart];for(var i=0;i<iList.length;i++){this.ojson[pow][chrBin][this.name].push(geneHash[iList[i]])}}}}}}};WgRefseq.prototype.getName=function(){return this.name};WgRefseq.prototype.getItemDispName=function(){return this.dispName};var WgRnaseqF=function(name,dispName,bbUrl,option){this.option=(option!==undefined)?option:{};this.option.buttonOnOffFlg=(this.option.buttonOnOffFlg===undefined)?false:option.buttonOnOffFlg;this.name=name;this.dispName=dispName;this.imgObj,this.ojson;this.eachHeight=25;this.eachSqwHeight=10;this.height;this.y;this.showType="expanded";this.bb=new BigbedData(bbUrl);var m=this;this.imgCaching={cachingNum:10,applyMinPow:3,getSettingType:function(){return m.eachSqwHeight+"|"+m.eachHeight+"|"+m.showType}}};WgRnaseqF.prototype=new WgRoot();WgRnaseqF.prototype.paint2=function(dt,y,width,chr,start,end,strand){var finView={};var eachHeight=(this.showType=="squished")?this.eachSqwHeight:this.eachHeight;var nameY=(this.showType=="squished")?0:15;var nameXs=[];for(var i=0;i<dt.length;i++){var rpkm=dt[i];for(var j=0;j<rpkm.length;j++){if(rpkm[j].utr_start<=end&&start<=rpkm[j].utr_end){var step=(this.showType=="collapsed")?1:parseInt(rpkm[j].step);var rpkm_col,rpkm_col2;var rpkm_org=rpkm[j].rpkm;if(rpkm_org==0){rpkm_org="0"}if(rpkm_org==""){rpkm_org="ND";rpkm_col="#BBBBBB";rpkm_col2="#666666"}else{var rpkm_val=parseInt(rpkm_org*2);if(rpkm_val>255)rpkm_val=255;var rpkm_brd=(rpkm_val<255-50)?rpkm_val+50:120;var hex=this.cov16(255-Math.floor(rpkm_val));rpkm_col=(rpkm[j].strand=="-")?"#FF"+hex+hex:"#"+hex+hex+"FF";hex=this.cov16(255-Math.floor(rpkm_brd));rpkm_col2=(rpkm[j].strand=="-")?"#FF"+hex+hex:"#"+hex+hex+"FF"}var y2=y+eachHeight*(step-1)+((eachHeight-nameY)/2);var y1=y2-3;var y3=y2+3;var y4=y+eachHeight*(step-1);var y5=y4+eachHeight-nameY;var y6=y5+10;var x1=(rpkm[j].utr_start-start)*(width-1)/(end-start+1);var x2=(rpkm[j].utr_end-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}if(x1<0)x1=0;if(x2>width-1)x2=width-1;this.imgObj.fillStyle=rpkm_col2;this.imgObj.fillRect(x1,y2,x2-x1+1,1);var strandFlg=(rpkm[j].strand=="+");var name=rpkm[j].symbol;if(name=="-"||name=="")name=rpkm[j].name;name+=" ("+rpkm_org+")";var id=rpkm[j].id;if(!(id in finView)){this.imgObj.font="10px 'Helvetica'";var strWidth=this.imgObj.measureText(name).width;var xMin=x1;var xMax=x2;var x7;if(xMin>width/3*2){x7=x1-strWidth/2}else if(xMax<width/3){x7=x2-strWidth/2}else{if(xMin<width/3)xMin=width/3;if(xMax>width/3*2)xMax=width/3*2;x7=(xMin+xMax)/2-strWidth/2}if(x7<0)x7=0;if(x7>width-strWidth)x7=width-strWidth;if(this.showType!="squished"){if(nameXs[step-1]===undefined||(strand!="-"&&nameXs[step-1]+10<x7)||(strand=="-"&&x7+strWidth+10<nameXs[step-1])){nameXs[step-1]=(strand=="-")?x7:x7+strWidth;this.imgObj.fillStyle="#444444";this.imgObj.fillText(name,x7,y6);finView[id]=1}}}var starts=rpkm[j].exn_starts.split(",");for(var k=0;k<starts.length;k++){if(starts[k]!="")starts[k]=parseInt(starts[k])}var ends=rpkm[j].exn_ends.split(",");for(var k=0;k<ends.length;k++){if(ends[k]!="")ends[k]=parseInt(ends[k])}var cdsStart=rpkm[j].cds_start;var cdsEnd=rpkm[j].cds_end;for(var k=0;k<starts.length;k++){if(starts[k]==""||end<starts[k])break;if(ends[k]<start)continue;if(cdsStart!=""&&cdsStart<=starts[k]&&ends[k]<=cdsEnd){var x5=(starts[k]-start)*(width-1)/(end-start+1);var x6=(ends[k]-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x5;x5=width-1-x6;x6=tmp}this.imgObj.fillStyle=rpkm_col;this.imgObj.fillRect(x5,y4,x6-x5+1,y5-y4);this.imgObj.strokeStyle=rpkm_col2;this.imgObj.strokeRect(x5,y4,x6-x5+1,y5-y4)}else{var x3=(starts[k]-start)*(width-1)/(end-start+1);var x4=(ends[k]-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x3;x3=width-1-x4;x4=tmp}this.imgObj.fillStyle=rpkm_col;this.imgObj.fillRect(x3,y1,x4-x3+1,y3-y1);this.imgObj.strokeStyle=rpkm_col2;this.imgObj.strokeRect(x3,y1,x4-x3+1,y3-y1);if((starts[k]<=cdsStart&&cdsStart<=ends[k])||(starts[k]<=cdsEnd&&cdsEnd<=ends[k])){var cdsSPoi=(starts[k]<=cdsStart&&cdsStart<=ends[k])?cdsStart:starts[k];var cdsEPoi=(starts[k]<=cdsEnd&&cdsEnd<=ends[k])?cdsEnd:ends[k];var x5=(cdsSPoi-start)*(width-1)/(end-start+1);var x6=(cdsEPoi-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x5;x5=width-1-x6;x6=tmp}this.imgObj.fillStyle=rpkm_col;this.imgObj.fillRect(x5,y4,x6-x5+1,y5-y4);this.imgObj.strokeStyle=rpkm_col2;this.imgObj.strokeRect(x5,y4,x6-x5+1,y5-y4)}}}this.imgObj.strokeStyle=rpkm_col2;this.imgObj.beginPath();for(var k=x1;k<x2-5;k+=50){if((strandFlg&&strand!="-")||(!strandFlg&&strand=="-")){this.imgObj.moveTo(k,y2-2);this.imgObj.lineTo(k+5,y2);this.imgObj.lineTo(k,y2+2)}else{this.imgObj.moveTo(k+5,y2-2);this.imgObj.lineTo(k,y2);this.imgObj.lineTo(k+5,y2+2)}}this.imgObj.stroke()}}}};WgRnaseqF.prototype.setHeight2=function(dt,width,chr,start,end){var eachHeight=(this.showType=="squished")?this.eachSqwHeight:this.eachHeight;var maxStep=1;if(this.showType!="collapsed"){for(var i=0;i<dt.length;i++){var rpkm=dt[i];for(var j=0;j<rpkm.length;j++){if(rpkm[j].utr_start<=end&&start<=rpkm[j].utr_end){var step=parseInt(rpkm[j].step);if(maxStep<step)maxStep=step}}}}this.height=eachHeight*maxStep};WgRnaseqF.prototype.getMenuPopup=function(){var checked=new Array("","","");if(this.showType=="collapsed")checked[0]="checked=\"checked\"";if(this.showType=="expanded")checked[1]="checked=\"checked\"";if(this.showType=="squished")checked[2]="checked=\"checked\"";var htmlStr="";htmlStr+="<form>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"collapsed\" id=\"collapsed\" ";htmlStr+=checked[0]+" /><label for=\"collapsed\">Collapsed</label></div>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"expanded\" id=\"expanded\" ";htmlStr+=checked[1]+" /><label for=\"expanded\">Expanded</label></div>";htmlStr+="<div><input type=\"radio\" name=\"show_type\" value=\"squished\" id=\"squished\" ";htmlStr+=checked[2]+" /><label for=\"squished\">Squished</label></div>";htmlStr+="</form>";return htmlStr};WgRnaseqF.prototype.getPopupData=function(y,width,chr,start,end){var popup={};var eachHeight=(this.showType=="squished")?this.eachSqwHeight:this.eachHeight;var nameY=(this.showType=="squished")?0:15;var pow=Math.floor(Math.LOG10E*Math.log((end-start+1)/width));if(pow<0)pow=0;var reg=Math.pow(10,pow)*POW_REG;var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);var nameXs=[];for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]){var rpkm=this.ojson[pow][chr+"|"+i][this.name];for(var j=0;j<rpkm.length;j++){if(rpkm[j].utr_start<=end&&start<=rpkm[j].utr_end){var step=(this.showType=="collapsed")?1:parseInt(rpkm[j].step);var y1=y+eachHeight*(step-1);var y2=y1+eachHeight-nameY;var x1=(rpkm[j].utr_start-start)*(width-1)/(end-start+1);var x2=(rpkm[j].utr_end-start+1)*(width-1)/(end-start+1);if(x1<0)x1=0;if(x2>width-1)x2=width-1;var yStr=y1+","+y2;if(!(yStr in popup))popup[yStr]={};var xStr=x1+","+x2;var htmlStr="<table border=\"1\">";htmlStr+="<tr>";htmlStr+="<th>Gene Symbol</th>";htmlStr+="<td>"+rpkm[j].symbol+"</td>";htmlStr+="</tr>";htmlStr+="<tr>";htmlStr+="<th>RefSeq ID</th>";htmlStr+="<td>"+rpkm[j].name+"</td>";htmlStr+="</tr>";htmlStr+="<tr>";htmlStr+="<th>Go to</th>";htmlStr+="<td><a href=\"https://dbtss.hgc.jp/cgi-bin/prom_start_es.cgi?SEE=1&UID=2&MSK=3&IDS="+rpkm[j].name+"&SPI=00\">DBTSS</a>, ";htmlStr+="<a href=\"#\" onclick=\"window.open('http://www.ncbi.nlm.nih.gov/gene/?term="+rpkm[j].name+"', '_blank')\">NCBI</a></td>";htmlStr+="</tr>";htmlStr+="</table>";popup[yStr][xStr]={"html":htmlStr}}}}}return popup};WgRnaseqF.prototype.getName=function(){return this.name};WgRnaseqF.prototype.getPannelBgcolor=function(){return(this.option.pannelBgcolor)?this.option.pannelBgcolor:"#EEEEEE"};WgRnaseqF.prototype.getItemDispName=function(){return this.dispName};WgRnaseqF.prototype.getButtonInfo=function(){var buttonColor=(this.option.buttonColor===undefined)?{"color":["eeeeee","ffcccc"],"onOff":this.option.buttonOnOffFlg}:{"color":this.option.buttonColor,"onOff":this.option.buttonOnOffFlg};return buttonColor};WgRnaseqF.prototype.accessObj=function(chr,binStart,binEnd,powP,accDefault){var m=this;var bpPerPixel=Math.pow(10,powP);var bpStart=binStart*bpPerPixel*POW_REG+1;var bpEnd=(parseInt(binStart)+1)*bpPerPixel*POW_REG;this.bb.readWaitReader(chr,bpStart,bpEnd,1,function(reductionLevel,fetcher){var data={};var tmp=[];var sorter=[];for(var alnEach of fetcher()){var num=(reductionLevel)?alnEach.maxVal:alnEach.value;if(num===undefined){var bedClm=alnEach.otherClm.split(/\t/);var stepName=bedClm[0].split(/\|/,4);var blockStarts=bedClm[8].split(/,/);var blockSizes=bedClm[7].split(/,/);var chromStart=parseInt(alnEach.chromStart);var chromEnd=parseInt(alnEach.chromEnd);var cdsStart=parseInt(bedClm[3])+1;var cdsEnd=parseInt(bedClm[4]);var exonStarts="";var exonEnds="";for(var i=0;i<blockStarts.length;i++){var blockStart=chromStart+parseInt(blockStarts[i]);var blockEnd=blockStart+parseInt(blockSizes[i])-1;if(exonStarts!="")exonStarts+=",";exonStarts+=blockStart;if(exonEnds!="")exonEnds+=",";exonEnds+=blockEnd}tmp.push({type:"bed",id:stepName[1],name:stepName[1],symbol:stepName[2],strand:bedClm[2],utr_start:chromStart,utr_end:chromEnd,cds_start:cdsStart,cds_end:cdsEnd,exn_starts:exonStarts,exn_ends:exonEnds,step:stepName[0],rpkm:parseFloat(stepName[3])})}else{tmp.push({type:"wig",id:alnEach.chromStart,start:alnEach.chromStart,end:alnEach.chromEnd,num:num})}}data[m.name]=tmp;accDefault.success(data);accDefault.complete()},function(err){accDefault.error(err,err,err);accDefault.complete()})};var WgComparaF=function(addDiv,dispName,comparaName,dispComparaName,urlSetCmp,viewerPartsData,gvVector,option){this.comparaFlg=true;this.divId;this.urlSet;this.addDiv=addDiv;this.height=0;this.width;this.nowWidth;this.y;this.option=(option===undefined)?{}:option;this.option.buttonOnOffFlg=(this.option.buttonOnOffFlg===undefined)?false:option.buttonOnOffFlg;this.option.gvItemSwitchFlg=(this.option.gvItemSwitchFlg===undefined)?false:option.gvItemSwitchFlg;this.option.gvInitShow=(this.option.gvInitShow===undefined)?[]:option.gvInitShow;this.option.uriDirFlg=true;this.gvc;this.gv;this.gvVector=gvVector;this.chrData1=urlSetCmp.chrData1;this.chrData2=urlSetCmp.chrData2;this.dispName=dispName;this.dispComparaName=dispComparaName;this.comparaName=comparaName;this.urlSetCmp=urlSetCmp;this.viewerPartsData=viewerPartsData;this.name=comparaName;this.dataForCmp=new GenomeViewerCommonData();this.dataForPartner=new GenomeViewerCommonData();this.initFlg=true};WgComparaF.prototype=new WgRoot();WgComparaF.prototype.paint=function(y,width,chr,start,end,strand){if(this.nowWidth===undefined){this.nowWidth=width}else if(this.nowWidth!=width){this.nowWidth=width;this.initFlg=true}if(this.initFlg){this.initFlg=false;var gv=this.gvVector.gv;this.width=gv.width;this.urlSet=gv.urlSet;this.chrData1=gv.genome;this.callingData=[gv.viewerParts,gv.option.ibuttonId,this];var divId=gv.divId;var urlSet=this.urlSet;var addDiv=this.addDiv;$("div"+divId+" #"+addDiv+"_compara").remove();$("div"+divId+" #"+addDiv+"_newview").remove();if($("div"+divId+" #items_button")[0]){$("div"+divId+" #items_button").before("<div id=\""+addDiv+"_compara"+"\"></div>\n");$("div"+divId+" #items_button").before("<div id=\""+addDiv+"_newview"+"\"></div>\n")}else{$("div"+divId).append("<div id=\""+addDiv+"_compara"+"\"></div>\n");$("div"+divId).append("<div id=\""+addDiv+"_newview"+"\"></div>\n")}var myOption={toolbarId:addDiv+"_toolcmp",viewerId:addDiv+"_compara",ibuttonId:addDiv+"_bttncmp",commonData:this.dataForCmp,uriDirFlg:this.option.uriDirFlg,scaleSizingFlg:false,showPanelFlg:true,autoSizingFlg:true,defaultMode:"info",itemSwitchFlg:false,showChromFlg:false,showScaleFlg:true,showPositionFlg:true,locationBarFlg:false};var oalign;var m=this;var myOptionGv={toolbarId:addDiv+"_toolbar",viewerId:addDiv+"_newview",ibuttonId:addDiv+"_buttons",btnSpaceId:addDiv+"_bs",commonData:this.dataForPartner,chrBoxCol:this.option.chrBoxCol,onTrackAction:this.option.onTrackAction,trackBtnHideFlg:this.gvVector.gv.option.trackBtnHideFlg,uriDirFlg:this.option.uriDirFlg,initShow:this.option.gvInitShow,bgVlineFlg:gv.option.bgVlineFlg,scaleSizingFlg:false,showPanelFlg:true,autoSizingFlg:true,defaultMode:"nav",itemSwitchFlg:this.option.gvItemSwitchFlg,defBtnHideFlg:true,showChromFlg:true,showScaleFlg:true,showPositionFlg:true,chromSizingFlg:false,dblclickSizingFlg:false,locationBarFlg:false,moveCallback:function(pos,mvFlg){if(oalign!==undefined&&mvFlg){oalign.setPos2(pos);m.gvc.paint()}}};var urlSetCmp=this.urlSetCmp;var gv=new GenomeViewer(this.width,50,this.chrData2,"",divId,this.viewerPartsData,{},myOptionGv);this.gv=gv;var oalign=new WgComparaAlignF(this.comparaName,this.dispComparaName,this.callingData,this.gv,urlSetCmp,divId,addDiv,{linkto:this.option.linkto});var gvc=new GenomeViewer(this.width,50,this.chrData1,"",divId,[[oalign,true]],urlSet,myOption);oalign.setCallingObject(gvc);this.gvc=gvc}if(this.gvc!==undefined){var showStart=start+(end-start+1)/3;var showEnd=end-(end-start+1)/3;this.gvc.setGenomePosition(chr,showStart,showEnd,strand)}var status=[];return status};WgComparaF.prototype.setInitFlg=function(flag){this.initFlg=flag};WgComparaF.prototype.setHeight=function(width,chr,start,end){};WgComparaF.prototype.getPopupData=function(){return};WgComparaF.prototype.getName=function(){return this.name};WgComparaF.prototype.getItemDispName=function(){var dispName=(this.dispName)?this.dispName:this.name;return dispName};WgComparaF.prototype.getButtonInfo=function(){var buttonColor=(this.option.buttonColor===undefined)?{"color":["eeeeee","ffcccc"],"onOff":this.option.buttonOnOffFlg}:{"color":this.option.buttonColor,"onOff":this.option.buttonOnOffFlg};return buttonColor};var WgComparaAlignF=function(name,dispName,callingData,gv,urlSet,divId,addDiv,option){this.ojson=[];this.baseHeight=30;this.height=this.baseHeight;this.alnHeight=50;this.option=(option===undefined)?{}:option;this.option.baseShowFlg=(this.option.baseShowFlg===undefined)?true:this.option.baseShowFlg;this.dispName=dispName;this.name=name;this.cmpDt;this.gv=gv;this.callingObj;this.bb=new BigbedData(urlSet.bigBed,{localFlg:this.option.localFlg});this.chrData1=urlSet.chrData1;this.chrData2=urlSet.chrData2;this.wg1=new WgenomeData(urlSet.sequenceFile1);this.wg2=new WgenomeData(urlSet.sequenceFile2);this.alnTarget=[];this.forcePos2={};this.sp2LoadSeqBin={};this.sp2Seq={};this.showMode="default";this.flipFlg=false;var m=this;this.menuPopAction=function(){$("input[name='show_mode']").change(function(){m.showMode=$("input[name='show_mode']:checked").val();$("div"+divId+" #right_pop").css("visibility","hidden");m.callingObj.paint()});$("input[name='flip_aln']").change(function(){m.flipFlg=!m.flipFlg;$("div"+divId+" #right_pop").css("visibility","hidden");m.callingObj.paint()});$("div"+divId+" a.cmpaln").click(function(){$("div"+divId+" #"+addDiv+"_compara").remove();$("div"+divId+" #"+addDiv+"_newview").remove();if($("div"+divId+" #"+addDiv+"_bs")[0]){$("div"+divId+" #"+addDiv+"_bs").html("")}var targetI;var targetName=callingData[2].getName();for(var i=0;i<callingData[0].length;i++){var targetObj=callingData[0][i];var partsId=targetObj.getName();if(partsId==targetName){targetI=i;break}}if(targetI!==undefined){callingData[0].splice(targetI,1);var buttonInfo=m.getButtonInfo();var col=buttonInfo.color[0];$("div"+divId+" #"+callingData[1]+" #"+targetName).css("background-color","#"+col);callingData[2].setInitFlg(true)}if(m.option.pushDelete){m.option.pushDelete()}$("div"+divId+" #right_pop").css("visibility","hidden");return false})};this.chrBar=10;this.height=20;this.y};WgComparaAlignF.prototype=new WgRoot();WgComparaAlignF.prototype.paint=function(y,width,chr,start,end,strand){var status=[];var pow=Math.floor(Math.LOG10E*Math.log((end-start+1)/width));if(pow<0)pow=0;var reg=Math.pow(10,pow)*POW_REG;var dist=end-start+1;var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]){}else{if(i>=0)status.push(i);this.paintLoading(y,width,start,end,strand,i)}}var chr2step={};var maxStep=0;var corChrom,corStart,corEnd,orient,corStrand;var minPStart1,maxPEnd1,minPStart2,maxPEnd2;if(this.cmpDt[0]!==undefined&&this.cmpDt[0]=="err"){var y1=y;var y2=y1+this.height-1;this.imgObj.fillStyle="#DDDDDD";this.imgObj.fillRect(0,y1,width,y2-y1+1);var errStr=this.cmpDt[1];this.imgObj.font="10px 'Helvetica'";var strWidth=this.imgObj.measureText(errStr).width;this.imgObj.fillStyle="#888888";var y3=(y1+y2)/2;var x3=(width-strWidth)/2;this.imgObj.fillText(errStr,x3,y3);return status}var vReg;var inFlg=false;for(var j=0;j<this.cmpDt.length;j++){var reg1=this.cmpDt[j]["region1"];var start1=parseInt(reg1[1]);var end1=parseInt(reg1[2]);var reg2=this.cmpDt[j]["region2"];var chromId2=reg2[0];if(chr2step[chromId2]===undefined){chr2step[chromId2]=maxStep;maxStep++}var step=(this.showMode=="oneline")?0:chr2step[chromId2];if(start1<=end&&start<=end1){var y1=y+this.chrBar*step;var y2=y1+this.chrBar-1;var x1=(start1-start)*(width-1)/(end-start+1);var x2=(end1-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}if(x1<0)x1=0;if(x2>width-1)x2=width-1;this.imgObj.fillStyle="#0000FF";this.imgObj.fillRect(x1,y1,x2-x1+1,y2-y1+1)}if(j==0){vReg=[j,reg1,reg2]}if(this.alnTarget!==undefined&&this.alnTarget[0]==reg2[0]&&this.alnTarget[1]<=reg2[2]&&this.alnTarget[2]>=reg2[1]){if(j==0)inFlg=true;if(!inFlg)vReg=[j,reg1,reg2]}}if(vReg!==undefined){var start1=parseInt(vReg[1][1]);var end1=parseInt(vReg[1][2]);var step=(this.showMode=="oneline")?0:chr2step[vReg[2][0]];if(start1<=end&&start<=end1){var y1=y+this.chrBar*step;var y2=y1+this.chrBar-1;var x1=(start1-start)*(width-1)/(end-start+1);var x2=(end1-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}if(x1<0)x1=0;if(x2>width-1)x2=width-1;this.imgObj.fillStyle="#FF8888";this.imgObj.fillRect(x1,y1,x2-x1+1,y2-y1+1)}orient=vReg[2][3];var mid1=(start+end)/2;var nearestDist;var mid2;var parts=this.cmpDt[vReg[0]]["parts"];for(var k=0;k<parts.length;k++){var pStart1=parts[k][0];var pEnd1=parts[k][1];var pStart2=parts[k][2];var pEnd2=parts[k][3];var pMid1=(pStart1+pEnd1)/2;var pDist=Math.abs(mid1-pMid1);if(pStart1<=mid1&&mid1<=pEnd1){nearestDist=0;mid2=(orient)?pStart2+mid1-pStart1:pEnd2-(mid1-pStart1)}else if(nearestDist===undefined||nearestDist>pDist){nearestDist=pDist;mid2=(pStart2+pEnd2)/2}if(minPStart1===undefined){minPStart1=pStart1;maxPEnd1=pEnd1;minPStart2=pStart2;maxPEnd2=pEnd2}else{if(minPStart1>pStart1)minPStart1=pStart1;if(maxPEnd1<pEnd1)maxPEnd1=pEnd1;if(minPStart2>pStart2)minPStart2=pStart2;if(maxPEnd2<pEnd2)maxPEnd2=pEnd2}}corChrom=vReg[2][4];if(this.forcePos2.start!==undefined){var allLng=(this.forcePos2.end-this.forcePos2.start+1)*3;var midPos=(this.forcePos2.start+this.forcePos2.end)/2;corStart=midPos-allLng/2+0.5;this.forcePos2={}}else{corStart=mid2-dist/2+0.5}corEnd=corStart+dist-1;corStrand=(((strand=="+"||strand===undefined)&&orient)||(strand=="-"&&!orient))?"+":"-";if(pow==0)this.accSp2Seq(corChrom,minPStart2,maxPEnd2,corStrand);var showStart=corStart+(corEnd-corStart+1)/3;var showEnd=corEnd-(corEnd-corStart+1)/3;this.gv.setGenomePosition(corChrom,showStart,showEnd,corStrand)}if(vReg!==undefined&&this.cmpDt[vReg[0]]!==undefined){var y3=y+this.chrBar;if(this.showMode!="oneline")y3+=this.chrBar*(maxStep-1);var baseSpaceFlg=((width-1)/(end-start+1)>10)?true:false;if(this.option.baseShowFlg&&baseSpaceFlg){y3+=10}var y4=y3+this.alnHeight;this.imgObj.fillStyle="#000000";this.imgObj.fillRect(0,y3,width,1);this.imgObj.fillRect(0,y4,width,1);var parts=this.cmpDt[vReg[0]]["parts"];for(var i=0;i<parts.length;i++){var pStart1=parts[i][0];var pEnd1=parts[i][1];var pStart2=parts[i][2];var pEnd2=parts[i][3];var pOrient=parts[i][4];var alnShowFlg=false;if(pow==0){var seqPair=this.getSeqPair(chr,minPStart1,pEnd1,corChrom,minPStart2,pEnd2);var seq1=seqPair[0].toUpperCase();var seq2=seqPair[1].toUpperCase();alnShowFlg=true;var s1=seq1.substr(pStart1-minPStart1,pEnd1-pStart1+1);var s2=seq2.substr(pStart2-minPStart2,pEnd2-pStart2+1);if(!orient)s2=this.revComp(s2);for(var j=0;j<s1.length;j++){var base1=s1.charAt(j);var base2=(orient==pOrient)?s2.charAt(j):s2.charAt(s1.length-j-1);var x5=((pStart1+j)-start+0.5)*(width-1)/(end-start+1);if(strand=="-"){x5=width-1-x5}var basePos=(pOrient)?pStart2+j:pEnd2-j;var x7=(basePos-corStart+0.5)*(width-1)/(corEnd-corStart+1);if(!orient){x7=width-1-x7}if(strand=="-"){x7=width-1-x7}var aln_base2=(orient==pOrient)?base2:this.revComp(base2);if((base1=="A"||base1=="C"||base1=="G"||base1=="T")&&base1==aln_base2){this.imgObj.strokeStyle=(orient==pOrient)?"#000000":"#FF0000";this.imgObj.beginPath();this.imgObj.moveTo(x5,y3);this.imgObj.lineTo(x7,y4);this.imgObj.stroke()}else if(base1=="."||base2=="."||base2==""){this.imgObj.strokeStyle=(orient==pOrient)?"#AAAAAA":"#FFAAAA";this.imgObj.beginPath();this.imgObj.moveTo(x5,y3);this.imgObj.lineTo(x7,y4);this.imgObj.stroke()}if(this.option.baseShowFlg&&baseSpaceFlg){if(strand=="-"){var tmp=base1;if(base1=="A")tmp="T";if(base1=="a")tmp="t";if(base1=="C")tmp="G";if(base1=="c")tmp="g";if(base1=="G")tmp="C";if(base1=="g")tmp="c";if(base1=="T")tmp="A";if(base1=="t")tmp="a";base1=tmp;tmp=base2;if(base2=="A")tmp="T";if(base2=="a")tmp="t";if(base2=="C")tmp="G";if(base2=="c")tmp="g";if(base2=="G")tmp="C";if(base2=="g")tmp="c";if(base2=="T")tmp="A";if(base2=="t")tmp="a";base2=tmp}this.imgObj.font="10px 'Helvetica'";this.imgObj.fillText(base1,x5-4,y3-2);this.imgObj.fillText(base2,x7-4,y4+10)}}}if(!alnShowFlg){var x5=(pStart1-start)*(width-1)/(end-start+1);var x6=(pEnd1-start+1)*(width-1)/(end-start+1);var x7=(pStart2-corStart)*(width-1)/(corEnd-corStart+1);var x8=(pEnd2-corStart+1)*(width-1)/(corEnd-corStart+1);if(!orient){var tmp=width-1-x7;x7=width-1-x8;x8=tmp}if(strand=="-"){var tmp=width-1-x7;x7=width-1-x8;x8=tmp}if(strand=="-"){var tmp=width-1-x5;x5=width-1-x6;x6=tmp}this.imgObj.beginPath();this.imgObj.moveTo(x5,y3);this.imgObj.lineTo(x7,y4);if(x8-x7>1){this.imgObj.lineTo(x8,y4);this.imgObj.lineTo(x6,y3);this.imgObj.closePath();this.imgObj.fillStyle=(orient==pOrient)?"#000033":"#FF0033";this.imgObj.fill()}else{this.imgObj.strokeStyle=(orient==pOrient)?"#000033":"#FF0033";this.imgObj.stroke()}}}}return status};WgComparaAlignF.prototype.revComp=function(seq){var newSeq="";for(var i=seq.length-1;i>=0;i--){var char=seq.charAt(i);var tmp=char;if(char=="A")tmp="T";if(char=="a")tmp="t";if(char=="C")tmp="G";if(char=="c")tmp="g";if(char=="G")tmp="C";if(char=="g")tmp="c";if(char=="T")tmp="A";if(char=="t")tmp="a";newSeq+=tmp}return newSeq};WgComparaAlignF.prototype.setCallingObject=function(callingObj){this.callingObj=callingObj};WgComparaAlignF.prototype.accSp2Seq=function(chr,start,end,strand){var reg=POW_REG;var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);var loadBinStart,loadBinEnd;for(var bin=binStart;bin<=binEnd;bin++){if(this.sp2Seq[chr+"|"+bin]===undefined&&!this.sp2LoadSeqBin[chr+"|"+bin]){this.sp2LoadSeqBin[chr+"|"+bin]=true;if(loadBinStart===undefined)loadBinStart=bin;loadBinEnd=bin}}if(loadBinStart!==undefined){var m=this;var bpStart=binStart*reg+1;var bpEnd=(binEnd+1)*reg;m.wg2.readWaitReader(chr,bpStart,bpEnd,function(fetcher){var seq="";for(var seqEach of fetcher()){seq+=seqEach}for(var bin=binStart;bin<=binEnd;bin++){m.sp2Seq[chr+"|"+bin]=seq.substr((bin-binStart)*POW_REG,POW_REG)}if(m.callingObj!==undefined){m.callingObj.paint()}},function(err){alert("Error! "+this.url+","+err)})}};WgComparaAlignF.prototype.getSeqPair=function(chr1,start1,end1,chr2,start2,end2){var reg=POW_REG;var binStart,binEnd;var seq1="";binStart=Math.floor((start1-1)/reg);binEnd=Math.floor((end1-1)/reg);for(var bin=binStart;bin<=binEnd;bin++){var nowSeq1;if(this.ojson[0]&&this.ojson[0][chr1+"|"+bin]&&this.ojson[0][chr1+"|"+bin][this.name]){nowSeq1=this.ojson[0][chr1+"|"+bin][this.name][1]}if(nowSeq1===undefined){nowSeq1="";for(var j=1;j<=reg;j++){nowSeq1+="."}}var nowBinStart=bin*reg+1;var nowBinEnd=(bin+1)*reg;if(end1<nowBinEnd){if(nowBinStart<=end1)nowSeq1=nowSeq1.substr(0,reg-(nowBinEnd-end1));else nowSeq1=""}if(nowBinStart<start1){if(start1<=nowBinEnd)nowSeq1=nowSeq1.substr(start1-nowBinStart);else nowSeq1=""}seq1+=nowSeq1}var seq2="";binStart=Math.floor((start2-1)/reg);binEnd=Math.floor((end2-1)/reg);for(var bin=binStart;bin<=binEnd;bin++){var nowSeq2;if(this.sp2Seq[chr2+"|"+bin]){nowSeq2=this.sp2Seq[chr2+"|"+bin]}if(nowSeq2===undefined){nowSeq2="";for(var j=1;j<=reg;j++){nowSeq2+="."}}var nowBinStart=bin*reg+1;var nowBinEnd=(bin+1)*reg;if(end2<nowBinEnd){nowSeq2=nowSeq2.substr(0,reg-(nowBinEnd-end2))}if(nowBinStart<start2){nowSeq2=nowSeq2.substr(start2-nowBinStart)}seq2+=nowSeq2}return[seq1,seq2]};WgComparaAlignF.prototype.setCmpDt=function(temp,orienter){var sorter={};var sorterArr=[];for(var key in temp){var lng=temp[key]["region1"][5];if(sorter[lng]===undefined){sorterArr.push(lng);sorter[lng]=[]}sorter[lng].push(key)}sorterArr.sort(function(a,b){if(a>b)return-1;if(a<b)return 1;return 0});var result=[];for(var i=0;i<sorterArr.length;i++){var lng=sorterArr[i];var keyList=sorter[lng];for(var j=0;j<keyList.length;j++){var key=keyList[j];var rs=temp[key];var chromId2=rs["region2"][0];var orient2=(orienter[chromId2][0]>orienter[chromId2][1])?0:1;rs["region2"][3]=(this.flipFlg)?1-orient2:orient2;result.push(rs)}}this.cmpDt=result};WgComparaAlignF.prototype.paintVScale=function(img,width){var chr2step={};var maxStep=0;if(this.cmpDt[0]!==undefined&&this.cmpDt[0]=="err"){}else if(this.showMode=="oneline"){var str="switch alignment";var y1=this.y+9;img.font="10px 'Helvetica'";var strWidth=img.measureText(str).width;var x1=width-strWidth-8;img.fillText(str,x1,y1)}else{for(var j=0;j<this.cmpDt.length;j++){var reg1=this.cmpDt[j]["region1"];var reg2=this.cmpDt[j]["region2"];var start1=parseInt(reg1[1]);var end1=parseInt(reg1[2]);var chromId2=reg2[0];if(chr2step[chromId2]===undefined){chr2step[chromId2]=maxStep;var chr=reg2[4];var y1=this.y+this.chrBar*maxStep+9;img.font="10px 'Helvetica'";var strWidth=img.measureText(chr).width;var x1=width-strWidth-8;img.fillText(chr,x1,y1);maxStep++}}}};WgComparaAlignF.prototype.setHeight=function(width,chr,start,end){var pow=Math.floor(Math.LOG10E*Math.log((end-start+1)/width));if(pow<0)pow=0;var reg=Math.pow(10,pow)*POW_REG;var temp={};var dist=end-start+1;var checker={};var orienter={};var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]){var cmp=this.ojson[pow][chr+"|"+i][this.name];if(cmp[0]=="err"){this.height=this.baseHeight;this.cmpDt=cmp;return}var chromId1=this.chrData1[chr][0];var chrom1=chr;var lng1=this.chrData1[chr][1];for(var j=0;j<cmp[0].length;j++){var chrom2=cmp[0][j][2];var chromId2=this.chrData2[chrom2][0];var lng2=this.chrData2[chrom2][1];var start2=cmp[0][j][3];var end2=cmp[0][j][4];var orient=cmp[0][j][1];var start1=cmp[0][j][5];var end1=cmp[0][j][6];if(end1<start||end<start1)continue;if(checker[start1])continue;checker[start1]=true;var no=1;var findFlg=false;while(temp[chromId2+"|"+no]!==undefined){var rtmp=temp[chromId2+"|"+no];var startReg2=rtmp["region2"][1];var endReg2=rtmp["region2"][2];if((endReg2<start2&&start2-endReg2+1>dist/5)||(end2<startReg2&&startReg2-end2+1>dist/5)){no++}else{findFlg=true;if(rtmp["region1"][1]>start1)rtmp["region1"][1]=start1;if(rtmp["region1"][2]<end1)rtmp["region1"][2]=end1;if(rtmp["region2"][1]>start2)rtmp["region2"][1]=start2;if(rtmp["region2"][2]<end2)rtmp["region2"][2]=end2;rtmp["region1"][5]+=end1-start1+1;rtmp["region2"][5]+=end2-start2+1;rtmp["parts"].push([start1,end1,start2,end2,orient]);break}}if(!findFlg){temp[chromId2+"|"+no]={"region1":[chromId1,start1,end1,1,chrom1,end1-start1+1,lng1],"region2":[chromId2,start2,end2,"",chrom2,end2-start2+1,lng2],"parts":[[start1,end1,start2,end2,orient]],}}if(orienter[chromId2]===undefined)orienter[chromId2]=[0,0];orienter[chromId2][orient]+=end1-start1+1}}}this.setCmpDt(temp,orienter);var chr2step={};var maxStep=0;for(var j=0;j<this.cmpDt.length;j++){var reg2=this.cmpDt[j]["region2"];var chromId2=reg2[0];if(chr2step[chromId2]===undefined){chr2step[chromId2]=maxStep;maxStep++}}var baseSpace=(this.option.baseShowFlg&&(width-1)/(end-start+1)>10)?20:0;this.height=this.alnHeight+baseSpace+this.chrBar;if(this.showMode!="oneline")this.height+=this.chrBar*(maxStep-1)};WgComparaAlignF.prototype.getMenuPopup=function(){var htmlStr="";var checked=[];if(this.showMode=="default")checked[0]="checked=\"checked\"";if(this.showMode=="oneline")checked[1]="checked=\"checked\"";if(this.flipFlg)checked[2]="checked=\"checked\"";var htmlStr="";htmlStr+="<div style=\"border:1px solid\"><table border=\"0\" width=\"100%\"><tr><th align=\"left\" bgcolor=\"#aaaaaa\" colspan=\"2\">Setting:</th></tr><tr>";htmlStr+="<td bgcolor=\"#aaaaaa\">&nbsp;</td><td><form>";htmlStr+="<div><input type=\"radio\" name=\"show_mode\" value=\"default\" id=\"default\" ";htmlStr+=checked[0]+" /><label for=\"default\">All chromosome</label></div>";htmlStr+="<div><input type=\"radio\" name=\"show_mode\" value=\"oneline\" id=\"oneline\" ";htmlStr+=checked[1]+" /><label for=\"oneline\">One line</label></div>";htmlStr+="<hr />";htmlStr+="<div><input type=\"checkbox\" name=\"flip_aln\" value=\"flip_aln\" id=\"flip_aln\" ";htmlStr+=checked[2]+" /><label for=\"flip_aln\">Flip alignment</label></div>";htmlStr+="</form>";htmlStr+="<hr /><a href=\"#\" class=\"det\">Detail...</a>";htmlStr+="</td></tr></table></div>";htmlStr+="<hr /><a href=\"#\" class=\"cmpaln\">Delete comparative view</a>";return htmlStr};WgComparaAlignF.prototype.getMenuDetail=function(){var htmlStr="";htmlStr+="<form><div><strong>Detailed settings</strong></div>";htmlStr+="<div class=\"modal_inbox\">";htmlStr+="<table border=\"0\" width=\"100%\" ><tr><td align=\"center\" height=\"30\">";htmlStr+="<div>Alignment height: <input type=\"text\" id=\"aln_height\" size=\"3\" maxlength=\"3\" value=\""+this.alnHeight+"\" />px</div>";htmlStr+="</td></tr></table>";htmlStr+="</div>";htmlStr+="<div class=\"modal_btn\"><input type=\"button\" id=\"apply_button\" value=\"Apply\" /><input type=\"button\" id=\"cancel_button\" value=\"Cancel\" /></div>";htmlStr+="</form>";return[htmlStr,[200,100]]};WgComparaAlignF.prototype.setViewDetail=function(divId){var aln_height=parseInt($("div"+divId+" div#modal div.container #aln_height").val());if(aln_height<5)aln_height=5;if(aln_height>500)aln_height=500;if(isNaN(aln_height))aln_height=50;this.alnHeight=aln_height;return true};WgComparaAlignF.prototype.getPopupData=function(y,width,chr,start,end,strand){var popup={};var chr2step={};var maxStep=0;if(this.cmpDt!==undefined){for(var j=0;j<this.cmpDt.length;j++){var reg1=this.cmpDt[j]["region1"];if(reg1===undefined)continue;var start1=parseInt(reg1[1]);var end1=parseInt(reg1[2]);var reg2=this.cmpDt[j]["region2"];var chromId2=reg2[0];if(chr2step[chromId2]===undefined){chr2step[chromId2]=maxStep;maxStep++}var step=(this.showMode=="oneline")?0:chr2step[chromId2];if(start1<=end&&start<=end1){var y1=y+this.chrBar*step;var y2=y1+this.chrBar-1;var x1=(start1-start)*(width-1)/(end-start+1);var x2=(end1-start+1)*(width-1)/(end-start+1);if(strand=="-"){var tmp=width-1-x1;x1=width-1-x2;x2=tmp}if(x1<0)x1=0;if(x2>width-1)x2=width-1;var yStr=y1+", "+y2;var xStr=x1+", "+x2;if(popup[yStr]===undefined)popup[yStr]={};popup[yStr][xStr]={"actionParam":[this,reg2],"action":function(d,p){var m=p[0];if(m.callingObj!==undefined){m.alnTarget=p[1];m.callingObj.paint()}}}}}}if(this.option.linkto!==undefined){var xStr="0, "+(width-1);var y1=(y+this.chrBar*maxStep);var yStr=y1+", "+(y+this.height-1);var location=chr+":"+start+"-"+end;htmlStr="<a href=\""+this.option.linkto.urlParam+location+"\" target=\"_blank\">"+this.option.linkto.term+"</a>";popup[yStr]={};popup[yStr][xStr]={"html":htmlStr}}return popup};WgComparaAlignF.prototype.getName=function(){return this.name};WgComparaAlignF.prototype.getItemDispName=function(){var dispName=(this.dispName)?this.dispName:this.name;return dispName};WgComparaAlignF.prototype.setPos2=function(pos){this.forcePos2=pos};WgComparaAlignF.prototype.accessObj=function(chr,binStart,binEnd,powP,accDefault){var m=this;var bpPerPixel=Math.pow(10,powP);var bpStart=binStart*bpPerPixel*POW_REG+1;var bpEnd=(parseInt(binStart)+1)*bpPerPixel*POW_REG;var data={};if(bpEnd-bpStart+1>10000000){data[m.name]=["err","Region is too large"];accDefault.success(data);accDefault.complete()}else{this.bb.readWaitReader(chr,bpStart,bpEnd,1,function(reductionLevel,fetcher){var tmp=[];for(var alnEach of fetcher()){var bedClm=alnEach.otherClm.split(/\t/);var dt=bedClm[0].split("|");dt.push(parseInt(alnEach.chromStart));dt.push(parseInt(alnEach.chromEnd));dt[1]=parseInt(dt[1]);dt[3]=parseInt(dt[3])+1;dt[4]=parseInt(dt[4]);tmp.push(dt)}data[m.name]=[tmp];if(powP==0){m.wg1.readWaitReader(chr,bpStart,bpEnd,function(fetcher){var seq="";for(var seqEach of fetcher()){seq+=seqEach}data[m.name][1]=seq;accDefault.success(data);accDefault.complete()},function(err){accDefault.error(err,err,err);accDefault.complete()})}else{accDefault.success(data);accDefault.complete()}},function(err){accDefault.error(err,err,err);accDefault.complete()})}};var WgSeparator=function(height,bgcolor){this.imgObj,this.ojson;if(!bgcolor){bgcolor=this.getRndColor()}this.bgcolor=bgcolor;this.height=height;this.y};WgSeparator.prototype=new WgRoot();WgSeparator.prototype.paint=function(y,width,chr,start,end){this.imgObj.fillStyle=this.bgcolor;this.imgObj.fillRect(0,y,width,this.height);return[]};WgSeparator.prototype.getName=function(){return"separator"};WgSeparator.prototype.getRndColor=function(){var c1=this.cov16(Math.random()*200);var c2=this.cov16(Math.random()*200);var c3=this.cov16(Math.random()*200);return"#"+c1+c2+c3};WgSeparator.prototype.getPannelBgcolor=function(){return"#CCCCCC"};var WgScale=function(height,genome){this.imgObj,this.ojson;this.height=height;this.genome=genome;this.y};WgScale.prototype=new WgRoot();WgScale.prototype.paint=function(y,width,chr,start,end,strand){this.imgObj.fillStyle="#000000";var y1=y+0;var y3=y+this.height-1;var flog=Math.floor(10*10*(end-start+1)/width);if(flog<=0)flog=1;var pow=Math.pow(10,Math.floor(Math.LOG10E*Math.log(flog)));var pos=Math.floor(start/pow)*pow;var xc;var x2_edge;var mvX=pow*(width-1)/(end-start+1);var hfMvX=1+0.5*(width-1)/(end-start+1);var maxPos=this.genome[chr][1];while((xc=(pos-start+0.5)*(width-1)/(end-start+1))<width){var x1=(strand=="-")?width-1-xc:xc;var y2=y1+5;var checkPos=Math.floor(pos/pow);if(checkPos%10==5)y2+=5;if(checkPos%10==0){this.imgObj.font="10px 'Helvetica'";var posStr=Number(pos).toLocaleString();var strWidth=this.imgObj.measureText(posStr).width;var x2=x1-strWidth/2;if(x2>0&&x2+strWidth<width){if(x2_edge===undefined||(strand!="-"&&x2_edge+20<x2)||(strand=="-"&&x2+strWidth+20<x2_edge)){this.imgObj.fillText(posStr,x2,y2+18);x2_edge=(strand=="-")?x2:x2+strWidth}}y2+=8}if(pos<=1||pos>=maxPos){this.imgObj.strokeStyle="#ff0000";this.imgObj.beginPath();if((strand=="-"&&pos<=1)||(strand!="-"&&pos>=maxPos)){if(strand!="-"&&pos-pow<maxPos){var fewMvX=(pos-maxPos)*(width-1)/(end-start+1);this.imgObj.moveTo(x1+hfMvX,y1);this.imgObj.lineTo(x1+hfMvX-fewMvX,y3);this.imgObj.lineTo(x1+hfMvX-fewMvX,y1);this.imgObj.lineTo(x1+hfMvX,y3)}this.imgObj.moveTo(x1+hfMvX+mvX,y1);this.imgObj.lineTo(x1+hfMvX,y3);this.imgObj.lineTo(x1+hfMvX,y1);this.imgObj.lineTo(x1+hfMvX+mvX,y3)}else{if(strand=="-"&&pos-pow<maxPos){var fewMvX=(pos-maxPos)*(width-1)/(end-start+1);this.imgObj.moveTo(x1-hfMvX,y1);this.imgObj.lineTo(x1-hfMvX+fewMvX,y3);this.imgObj.lineTo(x1-hfMvX+fewMvX,y1);this.imgObj.lineTo(x1-hfMvX,y3)}this.imgObj.moveTo(x1-hfMvX-mvX,y1);this.imgObj.lineTo(x1-hfMvX,y3);this.imgObj.lineTo(x1-hfMvX,y1);this.imgObj.lineTo(x1-hfMvX-mvX,y3)}this.imgObj.stroke()}this.imgObj.fillRect(x1,y1,1,y2-y1);pos+=pow}this.imgObj.fillRect(0,y1+this.height-1,width,1);return[]};var WgChr=function(callObj,addParamStr,baseY,relYSpace,genome,option){this.option=(option!==undefined)?option:{};this.option.chrBoxCol=(this.option.chrBoxCol===undefined)?"#ffee88":this.option.chrBoxCol;if(this.option.chrData===undefined)this.option.chrData={};this.cCc;this.height;this.width;this.chrData=this.option.chrData;this.showChr="";this.loading="";this.initFlg=false;if(addParamStr===undefined)addParamStr="";this.addParamStr=addParamStr;this.callObj=callObj;this.baseY=baseY;this.genome=genome;this.chrHeight=(this.option.chrHeight)?this.option.chrHeight:10;this.relYSpace=relYSpace};WgChr.prototype={initData:function(cCc,width,height){this.cCc=cCc;this.height=height;this.width=width;this.initFlg=true},paint:function(chr,start,end,strand){var m=this;var imgObj=this.imgObj;var cCc=this.cCc;var showWidth=this.width;if(this.callObj.urlSet.chromosome!==undefined||this.chrData[chr]!==undefined){if(this.loading!=chr){if(this.chrData[chr]===undefined){this.loading=chr;var paramStr=(this.addParamStr=="")?"":'&'+this.addParamStr;var urlStr=this.callObj.urlSet.chromosome;urlStr+=(this.option.chrUriDirFlg)?"/"+chr:'?chr='+chr;if(paramStr)urlStr+=(this.option.chrUriDirFlg)?"/?"+paramStr:paramStr;$.ajax({url:urlStr,xhrFields:{withCredentials:this.option.withCredentials},dataType:'json',success:function(data){m.chrData[chr]=data;m.bufferPaint(chr);m.loading=""},error:function(data){this.loading="";alert("Error! "+this.url)},complete:function(data){}})}else if(this.showChr!=chr||this.initFlg){this.bufferPaint(chr)}}else if(this.chrData[chr]===undefined){this.chrBoxPaint(chr)}}else{this.chrBoxPaint(chr)}if(this.baseY>=10){if(strand!="-")strand="+";var str=chr+":"+Number(Math.floor(start)).toLocaleString()+"-"+Number(Math.floor(end)).toLocaleString()+":"+strand;cCc.font="10px 'Helvetica'";var strWidth=cCc.measureText(str).width;cCc.fillStyle="#000000";cCc.clearRect(0,0,showWidth,this.baseY);cCc.fillText(str,10,this.baseY/2+4)}var wg=this.option.wholeGenome;if(wg===undefined||!wg.additionEraseFlg){var y2=this.height-this.relYSpace+5;var x2=this.width;cCc.clearRect(0,y2-12+5,x2,15);cCc.fillStyle="#000000";cCc.fillRect(0,y2,x2,1);cCc.beginPath();cCc.moveTo(0,y2);cCc.lineTo(10,y2-5);cCc.lineTo(10,y2+5);cCc.closePath();cCc.fill();cCc.beginPath();cCc.moveTo(x2,y2);cCc.lineTo(x2-10,y2-5);cCc.lineTo(x2-10,y2+5);cCc.closePath();cCc.fill();var lngStr=Math.floor(end)-Math.floor(start)+1;if(lngStr>=10000000){lngStr=Number(Math.floor((lngStr+500000)/1000000)).toLocaleString()+" mb"}else if(lngStr>=10000){lngStr=Number(Math.floor((lngStr+500)/1000)).toLocaleString()+" kb"}else{lngStr=Number(Math.floor(lngStr)).toLocaleString()+" b"}cCc.font="15px 'Helvetica'";var strWidth=cCc.measureText(lngStr).width;var x3=(x2-strWidth)/2;cCc.clearRect(x3-5,y2-12+5,strWidth+5*2,15);cCc.fillText(lngStr,x3,y2+5)}else{var y3=13;var lngStr=chr;cCc.fillStyle="#000000";cCc.font="10px 'Helvetica'";var strWidth=cCc.measureText(lngStr).width;cCc.clearRect(0,y3,strWidth,10);cCc.fillText(lngStr,0,y3+7)}return[]},chrBoxPaint:function(chr){var wg=this.option.wholeGenome;var leftSpace=0;if(wg&&wg.leftSpace)leftSpace=wg.leftSpace;this.showChr=chr;this.initFlg=false;var cCc=this.cCc;var showWidth=this.width;var showWidthChr=showWidth-leftSpace;var showHeight=this.height;var chrHeight=this.chrHeight;var callObj=this.callObj;var chrLng=this.genome[chr][1];cCc.clearRect(0,0,showWidth,showHeight);if(!wg)this.paintScale(cCc,chrLng);var y1=((showHeight-this.baseY-this.relYSpace)-chrHeight)/2+this.baseY;var y2=y1+chrHeight-1;var dirFlg=true;var nameX=0;cCc.font="10px 'Helvetica'";cCc.fillStyle="#000000";cCc.fillRect(leftSpace,0,showWidthChr,1);cCc.fillRect(leftSpace,showHeight-1,showWidthChr,1);var y1=(showHeight-this.baseY-this.relYSpace)/2+this.baseY-6;var y2=(showHeight-this.baseY-this.relYSpace)/2+this.baseY+6;cCc.fillStyle=this.option.chrBoxCol;cCc.fillRect(leftSpace,y1,showWidthChr,y2-y1+1);cCc.strokeRect(leftSpace,y1,showWidthChr,y2-y1+1)},bufferPaint:function(chr){var wg=this.option.wholeGenome;var leftSpace=0;if(wg&&wg.leftSpace)leftSpace=wg.leftSpace;this.showChr=chr;this.initFlg=false;var data=this.chrData[chr];if(!data.length){this.chrBoxPaint(chr);return}var cCc=this.cCc;var showWidth=this.width;var showWidthChr=showWidth-leftSpace;var showHeight=this.height;var chrHeight=this.chrHeight;var callObj=this.callObj;var chrLng=0;for(var i=0;i<data.length;i++){var end=data[i][1];if(chrLng<end)chrLng=end}cCc.clearRect(0,0,showWidth+2,showHeight);if(!wg)this.paintScale(cCc,chrLng);var y1=(wg===undefined)?((showHeight-this.baseY-this.relYSpace)-chrHeight)/2+this.baseY:showHeight-chrHeight;var y2=y1+chrHeight-1;var dirFlg=true;var nameX=0;cCc.font="10px 'Helvetica'";for(var i=0;i<data.length;i++){var cytoStart=data[i][0];var cytoEnd=data[i][1];var cytoName=data[i][2];cytoName=cytoName.replace(/^\d+/,"");var cytoScore;var score=data[i][3];if(isNaN(score)){if(score.substr(0,4)=="gpos"){cytoScore=parseInt((100-score.substr(4))*2.55)}else if(score=="gneg"){cytoScore=255}else if(score=="acen"){cytoScore=256}else{console.log("Error: invalid score: "+score)}}else{cytoScore=parseInt((1-data[i][3])*255)}var x1=leftSpace+(showWidthChr-1)*(cytoStart-1)/(chrLng-1);var x2=leftSpace+(showWidthChr-1)*(cytoEnd-1)/(chrLng-1);var strWidth=cCc.measureText(cytoName).width;var x3=(x1+x2-strWidth)/2;if(nameX+10<x3){cCc.fillStyle="#000000";var y3=(wg===undefined)?y2+10:y2-12;cCc.fillText(cytoName,x3,y3);nameX=x3+strWidth}if(cytoScore>255){cCc.strokeStyle="#000000";cCc.fillStyle="#AA0000";cCc.beginPath();if(dirFlg){cCc.moveTo(x1,y1);cCc.lineTo(x2,(y1+y2)/2);cCc.lineTo(x1,y2)}else{cCc.moveTo(x1,(y1+y2)/2);cCc.lineTo(x2,y2);cCc.lineTo(x2,y1)}cCc.closePath();cCc.fill();cCc.stroke();dirFlg=!dirFlg}else{var col=cytoScore.toString(16);cCc.fillStyle="#"+col+col+col;cCc.fillRect(x1,y1,x2-x1+1,y2-y1+1);cCc.strokeStyle="#000000";cCc.strokeRect(x1,y1,x2-x1+1,y2-y1+1)}}cCc.fillStyle="#000000";cCc.fillRect(leftSpace,0,showWidthChr,1);cCc.fillRect(leftSpace,showHeight-1,showWidthChr,1);callObj.paint()},paintScale:function(cCc,chrLng){var width=this.width;var wg=this.option.wholeGenome;var leftSpace=0;if(wg&&wg.leftSpace)leftSpace=wg.leftSpace;var mWidth=width-leftSpace;var flog=Math.floor(10*10*chrLng/mWidth);if(flog<=0)flog=1;var pow=Math.pow(10,Math.floor(Math.LOG10E*Math.log(flog)));var pos=pow;var x1;var x2_edge;var y1=this.baseY+1;cCc.fillStyle="#000000";cCc.fillRect(leftSpace,y1,mWidth,1);while((x1=leftSpace+(pos-1)*(mWidth-1)/chrLng)<=width){var y2=this.baseY+5;var checkPos=Math.floor(pos/pow);if(checkPos%10==5)y2+=3;if(checkPos%10==0){cCc.font="10px 'Helvetica'";var posStr=Number(pos).toLocaleString();var strWidth=cCc.measureText(posStr).width;var x2=x1-strWidth/2;if(x2>0&&x2+strWidth<width&&(x2_edge===undefined||x2_edge+20<x2)){cCc.fillText(posStr,x2,y2+13);x2_edge=x2+strWidth}y2+=5}cCc.fillRect(x1,y1,1,y2-y1);pos+=pow}},setHeight:function(width,chr,start,end){},getPopupData:function(){return},getHeight:function(){return this.height}};var WgSkeleton=function(name){this.name=name;this.height=50;this.y};WgSkeleton.prototype=new WgRoot();WgSkeleton.prototype.paint=function(y,width,chr,start,end,strand){var status=[];var pow=Math.floor(Math.LOG10E*Math.log((end-start+1)/width));if(pow<0)pow=0;var reg=Math.pow(10,pow)*POW_REG;var binStart=Math.floor((start-1)/reg);var binEnd=Math.floor((end-1)/reg);for(var i=binStart;i<=binEnd;i++){if(this.ojson[pow]&&this.ojson[pow][chr+"|"+i]&&this.ojson[pow][chr+"|"+i][this.name]){var data=this.ojson[pow][chr+"|"+i][this.name]}else{if(i>=0)status.push(i);this.paintLoading(y,width,start,end,strand,i)}}return status};WgSkeleton.prototype.setHeight=function(width,chr,start,end){};WgSkeleton.prototype.getPopupData=function(){return};WgSkeleton.prototype.getName=function(){return this.name};

/**
 * @author Hiroyuki Wakaguri: hwakagur@bits.cc
 * bam.js v1.3.20171218
 */
var BamData=function(fil,option){this.file=fil;this.option=(option!==undefined)?option:{};this.chrData;this.baiData;this.minBegCoffset;this.bamChunk={};this.loadData={};this.loadData.chunk={}};BamData.prototype.accRequest=function(callback,reject,option){if(option===undefined)option={};if(this.option.localFlg){var accFile=(option.file!==undefined)?option.file:this.file[0];var blob=accFile;if(option.byteStart!==undefined&&option.byteEnd!==undefined){if(window.File&&window.FileReader&&window.FileList&&window.Blob){blob=accFile.slice(option.byteStart,option.byteEnd+1)}else{alert('The File APIs are not fully supported in this browser.');return false}}var reader=new FileReader();reader.onloadend=function(evt){if(evt.target.readyState==FileReader.DONE){callback(evt.target.result)}else{reject("file access failed",evt.target);return false}};reader.readAsArrayBuffer(blob)}else{var accFile=(option.file!==undefined)?option.file:this.file;var xhr=new XMLHttpRequest();xhr.open('GET',accFile,true);if(option.byteStart!==undefined&&option.byteEnd!==undefined){xhr.setRequestHeader("Range","bytes="+option.byteStart+"-"+option.byteEnd)}xhr.addEventListener('loadend',function(ev){if(xhr.status!==200&&xhr.status!==206){console.error('web status: '+xhr.status+', '+xhr.statusText);reject("web access failed",xhr);return xhr.status}callback(xhr.response)},false);xhr.responseType='arraybuffer';xhr.send()}};BamData.prototype.chromosome=function(callback,reject){if(this.chrData!==undefined){callback();return true}var m=this;var option={};option.byteStart=0;option.byteEnd=this.minBegCoffset-1;this.accRequest(function(response){var chrData={};var plain=new Zlib.Gunzip(new Uint8Array(response)).decompress();let dataview=new DataView(plain.buffer);var poi=0;chrData.magic=String.fromCharCode(plain[poi])+String.fromCharCode(plain[poi+1])+String.fromCharCode(plain[poi+2])+String.fromCharCode(plain[poi+3]);poi+=4;var l_text=dataview.getUint32(poi,true);chrData.l_text=l_text;var text="";
poi+=4;for(;poi<8+l_text;poi++){text+=String.fromCharCode(plain[poi])}chrData.text=text;var n_ref=dataview.getUint32(poi,true);chrData.n_ref=n_ref;poi+=4;chrData.chr2no={};for(var i=1;i<=n_ref;i++){var l_name=dataview.getUint32(poi,true);poi+=4;var name="";for(var j=1;j<l_name;j++){name+=String.fromCharCode(plain[poi]);poi++}poi++;var l_ref=dataview.getUint32(poi,true);poi+=4;chrData.chr2no[name]={no:i-1,l_name:l_name,l_ref:l_ref}}m.chrData=chrData;callback()},reject,option)};BamData.prototype.chromIndex=function(callback,reject){if(this.loadData.chromIndex){callback();return}this.loadData.chromIndex=true;var m=this;var func=function(){m.chromosome(callback,reject)};this.accIndex(func,reject)};BamData.prototype.accIndex=function(callback,reject){if(this.baiData!==undefined){callback();return true}var m=this;var option={};option.file=(this.option.localFlg)?this.file[1]:this.file+".bai";this.accRequest(function(response){var plain=new Uint8Array(response);let dataview=new DataView(plain.buffer);var data={};var poi=0;var magic=String.fromCharCode(plain[poi])+String.fromCharCode(plain[poi+1])+String.fromCharCode(plain[poi+2])+String.fromCharCode(plain[poi+3]);data.magic=magic;poi+=4;var n_ref=dataview.getUint32(poi,true);data.n_ref=n_ref;poi+=4;data.chr=[];for(var i=0;i<n_ref;i++){data.chr[i]={};var n_bin=dataview.getUint32(poi,true);data.chr[i].n_bin=n_bin;poi+=4;data.chr[i].bin_data={};for(var j=1;j<=n_bin;j++){var bin=dataview.getUint32(poi,true);data.chr[i].bin_data[bin]={};poi+=4;var n_chunk=dataview.getUint32(poi,true);data.chr[i].bin_data[bin].n_chunk=n_chunk;poi+=4;data.chr[i].bin_data[bin].chunk=[];for(var k=1;k<=n_chunk;k++){var chunk_beg=dataview.getUint32(poi+4,true)*Math.pow(256,4)+dataview.getUint32(poi,true);var begUoffset=dataview.getUint16(poi,true);var begCoffset=dataview.getUint16(poi+6,true)*Math.pow(256,4)+dataview.getUint32(poi+2,true);poi+=8;var chunk_end=dataview.getUint32(poi+4,true)*Math.pow(256,4)+dataview.getUint32(poi,true);
var endUoffset=dataview.getUint16(poi,true);var endCoffset=dataview.getUint16(poi+6,true)*Math.pow(256,4)+dataview.getUint32(poi+2,true);poi+=8;if(endCoffset!=0&&(m.minBegCoffset===undefined||m.minBegCoffset>begCoffset)){m.minBegCoffset=begCoffset}data.chr[i].bin_data[bin].chunk[k-1]=[begCoffset,begUoffset,endCoffset,endUoffset,false,false]}}var n_intv=dataview.getUint32(poi,true);data.chr[i].n_intv=n_intv;poi+=4;data.chr[i].linearIndex=[];for(var j=1;j<=n_intv;j++){var ioffset=dataview.getUint32(poi+4,true)*Math.pow(256,4)+dataview.getUint32(poi,true);var linUoffset=dataview.getUint16(poi,true);var linCoffset=dataview.getUint16(poi+6,true)*Math.pow(256,4)+dataview.getUint32(poi+2,true);data.chr[i].linearIndex[j-1]=[linCoffset,linUoffset];poi+=8}}m.baiData=data;callback()},reject,option)};BamData.prototype.getTargetChunks=function(chr,start,end){var targetChunks=[];var baiData=this.baiData;var chrId=this.chrData.chr2no[chr].no;if(baiData.chr[chrId]===undefined)return[];var indexNo=Math.floor((start-1)/16384);var linearIndex=[0,0];if(indexNo>=0)linearIndex=baiData.chr[chrId].linearIndex[indexNo];var bins=this.reg2bins(start,end);var sorter={};var sorter2=[];for(var i=0;i<bins.length;i++){if(baiData.chr[chrId]!==undefined&&baiData.chr[chrId].bin_data[bins[i]]!==undefined){var chunk=baiData.chr[chrId].bin_data[bins[i]].chunk;for(var j=0;j<chunk.length;j++){var binReg=chunk[j];if(linearIndex[0]<binReg[2]||(linearIndex[0]==binReg[2]&&linearIndex[1]<=binReg[3])){var binRegSall=binReg[0]*256*256+binReg[1];var binRegEall=binReg[2]*256*256+binReg[3];if(sorter[binRegSall]===undefined){sorter2.push(binRegSall);sorter[binRegSall]=binRegEall}else if(sorter[binRegSall]<binRegEall){sorter[binRegSall]=binRegEall}}}}}var bend;var sorted2=sorter2.sort(function(a,b){return a-b});for(var i=0;i<sorted2.length;i++){var binRegSall=sorted2[i];var overlapFlg=false;if(bend!==undefined&&binRegSall<bend){overlapFlg=true}var binRegEall=sorter[binRegSall];
if(overlapFlg&&bend<binRegEall){targetChunks[targetChunks.length-1][1]=binRegEall;bend=binRegEall}else if(!overlapFlg){targetChunks.push([binRegSall,binRegEall]);bend=binRegEall}}return targetChunks};BamData.prototype.isLoaded=function(binSE){var isLoaded=true;var binRegS=Math.floor(binSE[0]/(256*256));var binRegE=Math.floor(binSE[1]/(256*256));var j=binRegS;while(j<=binRegE){var bamChunk=this.bamChunk[j];if(bamChunk===undefined){isLoaded=false;break}var nextJ=bamChunk[0];j=nextJ}return isLoaded};BamData.prototype.isAllLoaded=function(chr,start,end){if(this.chrData===undefined){return false}var flg=true;var targetChunks=this.getTargetChunks(chr,start,end);for(var i=0;i<targetChunks.length;i++){if(!this.isLoaded(targetChunks[i])){flg=false;break}}return flg};BamData.prototype.readWaitReader=function(chr,start,end,callback,reject,option){if(option===undefined)option={};if(option.timeout===undefined)option.timeout=300;var m=this;var func=function*(){var targetChunks=m.getTargetChunks(chr,start,end);for(var i=0;i<targetChunks.length;i++){for(var alnEach of m.getParsedData(targetChunks[i])){var alnStart=alnEach[0];var alnEnd=alnEach[5];if(alnStart<=end&&start<=alnEnd){yield alnEach}}}};this.addRegionData(chr,start,end,function(){if(m.isAllLoaded(chr,start,end)){callback(func)}else{var counter=0;var intervalID=setInterval(function(){m.addRegionData(chr,start,end,function(){if(m.isAllLoaded(chr,start,end)){clearInterval(intervalID);callback(func)}else{if(++counter>=option.timeout){clearInterval(intervalID);reject("timeout bam.js")}}},reject)},1000)}},reject)};BamData.prototype.readReader=function(chr,start,end,callback,reject){var m=this;this.addRegionData(chr,start,end,function(){var func=function*(){var targetChunks=m.getTargetChunks(chr,start,end);for(var i=0;i<targetChunks.length;i++){if(m.isLoaded(targetChunks[i])){for(var alnEach of m.getParsedData(targetChunks[i])){var alnStart=alnEach[0];var alnEnd=alnEach[5];
if(alnStart<=end&&start<=alnEnd){yield[true,alnEach]}}}else{yield[false,targetChunks[i]]}}};callback(func)},reject)};BamData.prototype.getParsedData=function*(binSE){var binRegS=Math.floor(binSE[0]/(256*256));var binRegE=Math.floor(binSE[1]/(256*256));var startPoi=binSE[0]%(256*256);var endPoi=binSE[1]%(256*256);var restArray;var j=binRegS;while(j<=binRegE){var bamChunk=this.bamChunk[j];var nextJ=bamChunk[0];var plain=bamChunk[1];var poi=(j==binRegS)?startPoi:0;var poiEnd=(j==binRegE)?endPoi:plain.length;if(restArray!==undefined){poiEnd+=restArray.length;var tmpArray=new Uint8Array(restArray.length+plain.length);tmpArray.set(restArray,0);tmpArray.set(plain,restArray.length);plain=tmpArray;restArray=undefined}let dataview=new DataView(plain.buffer);while(poi<poiEnd){var hit=[];hit[11]=poi+j*256*256;if(dataview.byteLength-poi<4){restArray=plain.slice(poi);break}var block_size=dataview.getUint32(poi,true);poi+=4;var nextBlock=poi+block_size;if(poiEnd<nextBlock){restArray=plain.slice(poi-4);break}var refID=dataview.getUint32(poi,true);poi+=4;var pos=dataview.getUint32(poi,true);hit[0]=pos+1;poi+=4;var l_read_name=dataview.getUint8(poi,true);var mapq=dataview.getUint8(poi+1,true);var bin_=dataview.getUint16(poi+2,true);hit[1]=mapq;poi+=4;var n_cigar_op=dataview.getUint16(poi,true);var flag=dataview.getUint16(poi+2,true);hit[2]=flag;poi+=4;var l_seq=dataview.getUint32(poi,true);poi+=4;var next_refID=dataview.getUint32(poi,true);hit[8]=(next_refID==4294967295)?"*":next_refID;poi+=4;var next_pos=dataview.getUint32(poi,true);hit[9]=(next_pos==4294967295)?"*":next_pos;poi+=4;var tlen=dataview.getUint32(poi,true);hit[10]=tlen;poi+=4;var read_name="";for(var i=1;i<l_read_name;i++){read_name+=String.fromCharCode(plain[poi]);poi++}poi++;hit[3]=read_name;var ln=0;var cigar="";var cigarLn=[];var cigarOp=[""];for(var i=1;i<=n_cigar_op;i++){var opAll=dataview.getUint32(poi,true);var op_len=Math.floor(opAll/16);var op="MIDNSHP=X".substr(opAll&15,1);cigar+=op_len+op;
cigarLn.push(op_len);cigarOp.push(op);if(op=="M"||op=="D"||op=="N"||op=="P"||op=="="||op=="X")ln+=op_len;poi+=4}hit[4]=cigar;hit[12]=cigarLn;hit[13]=cigarOp;hit[5]=pos+ln;var seq="";var iMax=Math.floor((l_seq+1)/2);for(var i=1;i<=iMax;i++){var base2=plain[poi];var b1="=ACMGRSVTWYHKDBN".substr(Math.floor(base2/16),1);var b2="=ACMGRSVTWYHKDBN".substr(base2&15,1);if(l_seq%2==1&&i==iMax)b2="";seq+=b1+b2;poi++}hit[6]=seq;var qual="";for(var i=1;i<=l_seq;i++){qual+=String.fromCharCode(plain[poi]+33);poi++}hit[7]=qual;yield hit;poi=nextBlock}j=nextJ}if(restArray!==undefined){alert("Error: restArray was found.")}};BamData.prototype.addRegionData=function(chr,start,end,callback,reject){var m=this;var func=function(){if(m.chrData===undefined){callback();return}var targetChunks=m.getTargetChunks(chr,start,end);var unloadedChunks=m.getUnloadedChunks(targetChunks);var promises=[];var num=unloadedChunks.length;for(var i=0;i<num;i++){promises.push(m.accBamPartial(unloadedChunks))}Promise.all(promises).then(callback)};this.chromIndex(func,reject)};
BamData.prototype.getUnloadedChunks=function(targetChunks){var sorter=[];for(var poi in this.loadData.chunk){sorter.push(poi)}sorter=sorter.sort(function(a,b){return a-b});var unloadedChunks=[];var j=0;for(var i=0;i<targetChunks.length;i++){var binSE=targetChunks[i];var binRegS=Math.floor(binSE[0]/(256*256));var binRegE=Math.floor(binSE[1]/(256*256));var skipFlg=false;while(sorter[j]!==undefined){var binLoadedS=sorter[j];var binLoadedE=this.loadData.chunk[binLoadedS];if(binLoadedE<binRegS){j++;continue}if(binLoadedE==binRegS){if(this.loadData.chunk[binLoadedE]!==undefined&&binRegS==binRegE){skipFlg=true;break}j++;continue}if(binRegE<binLoadedS){break}if(binRegE==binLoadedS){if(binRegS==binRegE){skipFlg=true}break}if(binLoadedS<=binRegS&&binRegE<=binLoadedE){if(this.loadData.chunk[binLoadedE]!==undefined){skipFlg=true}else{binRegS=binRegE}break}if(binLoadedS<=binRegS&&binRegS<binLoadedE&&binLoadedE<binRegE){binRegS=binLoadedE;j++;continue}if(binRegS<binLoadedS&&binLoadedS<binRegE&&binRegE<=binLoadedE){binRegE=binLoadedS;break}if(binRegS<binLoadedS&&binLoadedE<binRegE){this.loadData.chunk[binRegS]=binLoadedS;unloadedChunks.push([binRegS,binLoadedS]);j++;continue}alert("Error")}if(!skipFlg){this.loadData.chunk[binRegS]=binRegE;unloadedChunks.push([binRegS,binRegE])}}var bbinRegE;var returnChunks=[];for(var i=0;i<unloadedChunks.length;i++){var chunkReg=unloadedChunks[i];if(bbinRegE!==undefined&&bbinRegE==chunkReg[0]){returnChunks[returnChunks.length-1][1]=chunkReg[1]}else{returnChunks.push(chunkReg)}bbinRegE=chunkReg[1]}return returnChunks};BamData.prototype.accBamPartial=function(unloadedChunks){var m=this;var chunkData=unloadedChunks.pop();var option={};option.byteStart=chunkData[0];option.byteEnd=chunkData[1]-1+65536;return new Promise(function(resolve,reject){m.accRequest(function(response){var origin=new Uint8Array(response);var nowPoi=0;var lastPoi=chunkData[1]-chunkData[0];while(nowPoi<=lastPoi){var blockLng=origin[nowPoi+16]+origin[nowPoi+16+1]*256+1;
var nowOrigin=origin.subarray(nowPoi,nowPoi+blockLng);var nowPlain=new Zlib.Gunzip(nowOrigin).decompress();m.bamChunk[chunkData[0]+nowPoi]=[chunkData[0]+nowPoi+blockLng,nowPlain];if(m.loadData.chunk[chunkData[0]+nowPoi]!==undefined&&m.loadData.chunk[chunkData[0]+nowPoi]==chunkData[0]+nowPoi){m.loadData.chunk[chunkData[0]+nowPoi]=chunkData[0]+nowPoi+blockLng}nowPoi+=blockLng}resolve()},reject,option)})};BamData.prototype.reg2bins=function(beg,end){var list=[];var i=0,k;--beg;list[i++]=0;for(k=1+(beg>>26);k<=1+(end>>26);++k)list[i++]=k;for(k=9+(beg>>23);k<=9+(end>>23);++k)list[i++]=k;for(k=73+(beg>>20);k<=73+(end>>20);++k)list[i++]=k;for(k=585+(beg>>17);k<=585+(end>>17);++k)list[i++]=k;for(k=4681+(beg>>14);k<=4681+(end>>14);++k)list[i++]=k;return list};BamData.prototype.onError=function(err){alert("Error:"+err)};

/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
(function() {'use strict';function n(e){throw e;}var q=void 0,aa=this;function r(e,c){var d=e.split("."),b=aa;!(d[0]in b)&&b.execScript&&b.execScript("var "+d[0]);for(var a;d.length&&(a=d.shift());)!d.length&&c!==q?b[a]=c:b=b[a]?b[a]:b[a]={}};var u="undefined"!==typeof Uint8Array&&"undefined"!==typeof Uint16Array&&"undefined"!==typeof Uint32Array&&"undefined"!==typeof DataView;new (u?Uint8Array:Array)(256);var v;for(v=0;256>v;++v)for(var w=v,ba=7,w=w>>>1;w;w>>>=1)--ba;function x(e,c,d){var b,a="number"===typeof c?c:c=0,f="number"===typeof d?d:e.length;b=-1;for(a=f&7;a--;++c)b=b>>>8^z[(b^e[c])&255];for(a=f>>3;a--;c+=8)b=b>>>8^z[(b^e[c])&255],b=b>>>8^z[(b^e[c+1])&255],b=b>>>8^z[(b^e[c+2])&255],b=b>>>8^z[(b^e[c+3])&255],b=b>>>8^z[(b^e[c+4])&255],b=b>>>8^z[(b^e[c+5])&255],b=b>>>8^z[(b^e[c+6])&255],b=b>>>8^z[(b^e[c+7])&255];return(b^4294967295)>>>0}
var A=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,
2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,
2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,
2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,
3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,
936918E3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],z=u?new Uint32Array(A):A;function B(){}B.prototype.getName=function(){return this.name};B.prototype.getData=function(){return this.data};B.prototype.H=function(){return this.I};r("Zlib.GunzipMember",B);r("Zlib.GunzipMember.prototype.getName",B.prototype.getName);r("Zlib.GunzipMember.prototype.getData",B.prototype.getData);r("Zlib.GunzipMember.prototype.getMtime",B.prototype.H);function D(e){var c=e.length,d=0,b=Number.POSITIVE_INFINITY,a,f,g,k,m,p,t,h,l,y;for(h=0;h<c;++h)e[h]>d&&(d=e[h]),e[h]<b&&(b=e[h]);a=1<<d;f=new (u?Uint32Array:Array)(a);g=1;k=0;for(m=2;g<=d;){for(h=0;h<c;++h)if(e[h]===g){p=0;t=k;for(l=0;l<g;++l)p=p<<1|t&1,t>>=1;y=g<<16|h;for(l=p;l<a;l+=m)f[l]=y;++k}++g;k<<=1;m<<=1}return[f,d,b]};var E=[],F;for(F=0;288>F;F++)switch(!0){case 143>=F:E.push([F+48,8]);break;case 255>=F:E.push([F-144+400,9]);break;case 279>=F:E.push([F-256+0,7]);break;case 287>=F:E.push([F-280+192,8]);break;default:n("invalid literal: "+F)}
var ca=function(){function e(a){switch(!0){case 3===a:return[257,a-3,0];case 4===a:return[258,a-4,0];case 5===a:return[259,a-5,0];case 6===a:return[260,a-6,0];case 7===a:return[261,a-7,0];case 8===a:return[262,a-8,0];case 9===a:return[263,a-9,0];case 10===a:return[264,a-10,0];case 12>=a:return[265,a-11,1];case 14>=a:return[266,a-13,1];case 16>=a:return[267,a-15,1];case 18>=a:return[268,a-17,1];case 22>=a:return[269,a-19,2];case 26>=a:return[270,a-23,2];case 30>=a:return[271,a-27,2];case 34>=a:return[272,
a-31,2];case 42>=a:return[273,a-35,3];case 50>=a:return[274,a-43,3];case 58>=a:return[275,a-51,3];case 66>=a:return[276,a-59,3];case 82>=a:return[277,a-67,4];case 98>=a:return[278,a-83,4];case 114>=a:return[279,a-99,4];case 130>=a:return[280,a-115,4];case 162>=a:return[281,a-131,5];case 194>=a:return[282,a-163,5];case 226>=a:return[283,a-195,5];case 257>=a:return[284,a-227,5];case 258===a:return[285,a-258,0];default:n("invalid length: "+a)}}var c=[],d,b;for(d=3;258>=d;d++)b=e(d),c[d]=b[2]<<24|b[1]<<
16|b[0];return c}();u&&new Uint32Array(ca);function G(e,c){this.i=[];this.j=32768;this.d=this.f=this.c=this.n=0;this.input=u?new Uint8Array(e):e;this.o=!1;this.k=H;this.z=!1;if(c||!(c={}))c.index&&(this.c=c.index),c.bufferSize&&(this.j=c.bufferSize),c.bufferType&&(this.k=c.bufferType),c.resize&&(this.z=c.resize);switch(this.k){case I:this.a=32768;this.b=new (u?Uint8Array:Array)(32768+this.j+258);break;case H:this.a=0;this.b=new (u?Uint8Array:Array)(this.j);this.e=this.F;this.q=this.B;this.l=this.D;break;default:n(Error("invalid inflate mode"))}}
var I=0,H=1;
G.prototype.g=function(){for(;!this.o;){var e=J(this,3);e&1&&(this.o=!0);e>>>=1;switch(e){case 0:var c=this.input,d=this.c,b=this.b,a=this.a,f=c.length,g=q,k=q,m=b.length,p=q;this.d=this.f=0;d+1>=f&&n(Error("invalid uncompressed block header: LEN"));g=c[d++]|c[d++]<<8;d+1>=f&&n(Error("invalid uncompressed block header: NLEN"));k=c[d++]|c[d++]<<8;g===~k&&n(Error("invalid uncompressed block header: length verify"));d+g>c.length&&n(Error("input buffer is broken"));switch(this.k){case I:for(;a+g>b.length;){p=
m-a;g-=p;if(u)b.set(c.subarray(d,d+p),a),a+=p,d+=p;else for(;p--;)b[a++]=c[d++];this.a=a;b=this.e();a=this.a}break;case H:for(;a+g>b.length;)b=this.e({t:2});break;default:n(Error("invalid inflate mode"))}if(u)b.set(c.subarray(d,d+g),a),a+=g,d+=g;else for(;g--;)b[a++]=c[d++];this.c=d;this.a=a;this.b=b;break;case 1:this.l(da,ea);break;case 2:fa(this);break;default:n(Error("unknown BTYPE: "+e))}}return this.q()};
var K=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],L=u?new Uint16Array(K):K,N=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],O=u?new Uint16Array(N):N,P=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],Q=u?new Uint8Array(P):P,R=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],ga=u?new Uint16Array(R):R,ha=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,
13,13],U=u?new Uint8Array(ha):ha,V=new (u?Uint8Array:Array)(288),W,ia;W=0;for(ia=V.length;W<ia;++W)V[W]=143>=W?8:255>=W?9:279>=W?7:8;var da=D(V),X=new (u?Uint8Array:Array)(30),Y,ja;Y=0;for(ja=X.length;Y<ja;++Y)X[Y]=5;var ea=D(X);function J(e,c){for(var d=e.f,b=e.d,a=e.input,f=e.c,g=a.length,k;b<c;)f>=g&&n(Error("input buffer is broken")),d|=a[f++]<<b,b+=8;k=d&(1<<c)-1;e.f=d>>>c;e.d=b-c;e.c=f;return k}
function Z(e,c){for(var d=e.f,b=e.d,a=e.input,f=e.c,g=a.length,k=c[0],m=c[1],p,t;b<m&&!(f>=g);)d|=a[f++]<<b,b+=8;p=k[d&(1<<m)-1];t=p>>>16;e.f=d>>t;e.d=b-t;e.c=f;return p&65535}
function fa(e){function c(a,c,b){var d,e=this.w,f,g;for(g=0;g<a;)switch(d=Z(this,c),d){case 16:for(f=3+J(this,2);f--;)b[g++]=e;break;case 17:for(f=3+J(this,3);f--;)b[g++]=0;e=0;break;case 18:for(f=11+J(this,7);f--;)b[g++]=0;e=0;break;default:e=b[g++]=d}this.w=e;return b}var d=J(e,5)+257,b=J(e,5)+1,a=J(e,4)+4,f=new (u?Uint8Array:Array)(L.length),g,k,m,p;for(p=0;p<a;++p)f[L[p]]=J(e,3);if(!u){p=a;for(a=f.length;p<a;++p)f[L[p]]=0}g=D(f);k=new (u?Uint8Array:Array)(d);m=new (u?Uint8Array:Array)(b);e.w=
0;e.l(D(c.call(e,d,g,k)),D(c.call(e,b,g,m)))}G.prototype.l=function(e,c){var d=this.b,b=this.a;this.r=e;for(var a=d.length-258,f,g,k,m;256!==(f=Z(this,e));)if(256>f)b>=a&&(this.a=b,d=this.e(),b=this.a),d[b++]=f;else{g=f-257;m=O[g];0<Q[g]&&(m+=J(this,Q[g]));f=Z(this,c);k=ga[f];0<U[f]&&(k+=J(this,U[f]));b>=a&&(this.a=b,d=this.e(),b=this.a);for(;m--;)d[b]=d[b++-k]}for(;8<=this.d;)this.d-=8,this.c--;this.a=b};
G.prototype.D=function(e,c){var d=this.b,b=this.a;this.r=e;for(var a=d.length,f,g,k,m;256!==(f=Z(this,e));)if(256>f)b>=a&&(d=this.e(),a=d.length),d[b++]=f;else{g=f-257;m=O[g];0<Q[g]&&(m+=J(this,Q[g]));f=Z(this,c);k=ga[f];0<U[f]&&(k+=J(this,U[f]));b+m>a&&(d=this.e(),a=d.length);for(;m--;)d[b]=d[b++-k]}for(;8<=this.d;)this.d-=8,this.c--;this.a=b};
G.prototype.e=function(){var e=new (u?Uint8Array:Array)(this.a-32768),c=this.a-32768,d,b,a=this.b;if(u)e.set(a.subarray(32768,e.length));else{d=0;for(b=e.length;d<b;++d)e[d]=a[d+32768]}this.i.push(e);this.n+=e.length;if(u)a.set(a.subarray(c,c+32768));else for(d=0;32768>d;++d)a[d]=a[c+d];this.a=32768;return a};
G.prototype.F=function(e){var c,d=this.input.length/this.c+1|0,b,a,f,g=this.input,k=this.b;e&&("number"===typeof e.t&&(d=e.t),"number"===typeof e.A&&(d+=e.A));2>d?(b=(g.length-this.c)/this.r[2],f=258*(b/2)|0,a=f<k.length?k.length+f:k.length<<1):a=k.length*d;u?(c=new Uint8Array(a),c.set(k)):c=k;return this.b=c};
G.prototype.q=function(){var e=0,c=this.b,d=this.i,b,a=new (u?Uint8Array:Array)(this.n+(this.a-32768)),f,g,k,m;if(0===d.length)return u?this.b.subarray(32768,this.a):this.b.slice(32768,this.a);f=0;for(g=d.length;f<g;++f){b=d[f];k=0;for(m=b.length;k<m;++k)a[e++]=b[k]}f=32768;for(g=this.a;f<g;++f)a[e++]=c[f];this.i=[];return this.buffer=a};
G.prototype.B=function(){var e,c=this.a;u?this.z?(e=new Uint8Array(c),e.set(this.b.subarray(0,c))):e=this.b.subarray(0,c):(this.b.length>c&&(this.b.length=c),e=this.b);return this.buffer=e};function $(e){this.input=e;this.c=0;this.m=[];this.s=!1}$.prototype.G=function(){this.s||this.g();return this.m.slice()};
$.prototype.g=function(){for(var e=this.input.length;this.c<e;){var c=new B,d=q,b=q,a=q,f=q,g=q,k=q,m=q,p=q,t=q,h=this.input,l=this.c;c.u=h[l++];c.v=h[l++];(31!==c.u||139!==c.v)&&n(Error("invalid file signature:"+c.u+","+c.v));c.p=h[l++];switch(c.p){case 8:break;default:n(Error("unknown compression method: "+c.p))}c.h=h[l++];p=h[l++]|h[l++]<<8|h[l++]<<16|h[l++]<<24;c.I=new Date(1E3*p);c.O=h[l++];c.N=h[l++];0<(c.h&4)&&(c.J=h[l++]|h[l++]<<8,l+=c.J);if(0<(c.h&8)){m=[];for(k=0;0<(g=h[l++]);)m[k++]=String.fromCharCode(g);
c.name=m.join("")}if(0<(c.h&16)){m=[];for(k=0;0<(g=h[l++]);)m[k++]=String.fromCharCode(g);c.K=m.join("")}0<(c.h&2)&&(c.C=x(h,0,l)&65535,c.C!==(h[l++]|h[l++]<<8)&&n(Error("invalid header crc16")));d=h[h.length-4]|h[h.length-3]<<8|h[h.length-2]<<16|h[h.length-1]<<24;h.length-l-4-4<512*d&&(f=d);b=new G(h,{index:l,bufferSize:f});c.data=a=b.g();l=b.c;c.L=t=(h[l++]|h[l++]<<8|h[l++]<<16|h[l++]<<24)>>>0;x(a,q,q)!==t&&n(Error("invalid CRC-32 checksum: 0x"+x(a,q,q).toString(16)+" / 0x"+t.toString(16)));c.M=
d=(h[l++]|h[l++]<<8|h[l++]<<16|h[l++]<<24)>>>0;(a.length&4294967295)!==d&&n(Error("invalid input size: "+(a.length&4294967295)+" / "+d));this.m.push(c);this.c=l}this.s=!0;var y=this.m,s,M,S=0,T=0,C;s=0;for(M=y.length;s<M;++s)T+=y[s].data.length;if(u){C=new Uint8Array(T);for(s=0;s<M;++s)C.set(y[s].data,S),S+=y[s].data.length}else{C=[];for(s=0;s<M;++s)C[s]=y[s].data;C=Array.prototype.concat.apply([],C)}return C};r("Zlib.Gunzip",$);r("Zlib.Gunzip.prototype.decompress",$.prototype.g);r("Zlib.Gunzip.prototype.getMembers",$.prototype.G);}).call(this); //@ sourceMappingURL=gunzip.min.js.map

/**
 * @author Hiroyuki Wakaguri: hwakagur@bits.cc
 * bigbed.js v1.1.20170420
 */
var BigbedData=function(fil,option){this.file=fil;this.option=(option!==undefined)?option:{};this.fileType="None";this.indexBuff=512000;this.loadData={};this.loadData.zoom={};this.loadData.zoom.indexData={};this.indexData={};this.chromData={};this.zoomData={};this.rawData={}};BigbedData.prototype.accRequest=function(callback,reject,option){if(option===undefined)option={};if(this.option.localFlg){var accFile=(option.file!==undefined)?option.file:this.file;var blob=accFile;if(option.byteStart!==undefined&&option.byteEnd!==undefined){blob=accFile.slice(option.byteStart,option.byteEnd+1)}var reader=new FileReader();reader.onloadend=function(evt){if(evt.target.readyState==FileReader.DONE){callback(evt.target.result)}else{reject("file access failed",evt.target);return false}};reader.readAsArrayBuffer(blob)}else{this.accWebRequest(callback,reject,option)}};BigbedData.prototype.accWebRequest=function(callback,reject,option){let accFile=(option.file!==undefined)?option.file:this.file;let xhr=new XMLHttpRequest();xhr.open('GET',accFile,true);if(option.byteStart!==undefined&&option.byteEnd!==undefined){xhr.setRequestHeader("X-Test","bytes="+option.byteStart+"-"+option.byteEnd);xhr.setRequestHeader("Range","bytes="+option.byteStart+"-"+option.byteEnd)}xhr.addEventListener('loadend',function(ev){if(xhr.status!==200&&xhr.status!==206&&xhr.status!==0){console.error('web status: '+xhr.status+', '+xhr.statusText+", bytes="+option.byteStart+"-"+option.byteEnd);reject("web access failed",xhr);return xhr.status}else if(xhr.status===0){console.log('Retry: web status: (0), '+xhr.statusText+", bytes="+option.byteStart+"-"+option.byteEnd);let xhr2=new XMLHttpRequest();xhr2.open('GET',accFile,true);
if(option.byteStart!==undefined&&option.byteEnd!==undefined){xhr2.setRequestHeader("Range","bytes="+option.byteStart+"-"+option.byteEnd)}xhr2.addEventListener('loadend',function(ev2){if(xhr2.status!==200&&xhr2.status!==206){console.error('web status: '+xhr2.status+', '+xhr2.statusText+", bytes="+option.byteStart+"-"+option.byteEnd);reject("web access failed",xhr2);return xhr2.status}callback(xhr2.response)},false);xhr2.responseType='arraybuffer';xhr2.send();return}callback(xhr.response)},false);xhr.responseType='arraybuffer';xhr.send()};BigbedData.prototype.header=function(reductionLevel){let m=this;let option={};option.byteStart=0;option.byteEnd=63;return new Promise(function(resolve,reject){if(m.loadData.header){resolve([m,reductionLevel]);return}m.loadData.header=true;m.accRequest(function(response){let plain=new Uint8Array(response);let dataview=new DataView(plain.buffer);let magic=dataview.getUint32(0,true);if(magic==2273964779){m.fileType="BigBed"}else if(magic==2291137574){m.fileType="BigWig"}else{alert("unsupported file: "+magic);return false}let zoomLevels=dataview.getUint16(6,true);let chrPos=dataview.getUint32(8+4,true)*Math.pow(256,4)+dataview.getUint32(8,true);let dataPos=dataview.getUint32(16+4,true)*Math.pow(256,4)+dataview.getUint32(16,true);let indexPos=dataview.getUint32(24+4,true)*Math.pow(256,4)+dataview.getUint32(24,true);let fieldCount=dataview.getUint16(32,true);let definedFieldCount=dataview.getUint16(34,true);let byteStart=indexPos;m.indexData.byteStart=byteStart;m.chromData.byteStart=chrPos;m.chromData.byteEnd=dataPos;m.zoomData.zoomLevels=zoomLevels;resolve([m,reductionLevel])},reject,option)})};BigbedData.prototype.accChromData=function(self){return new Promise(function(resolve,reject){if(self.chromData.byteEnd===undefined||self.loadData.chromData){resolve(self);return}let option={};option.byteStart=self.chromData.byteStart;option.byteEnd=self.chromData.byteEnd;self.loadData.chromData=true;
self.accRequest(function(response){let plain=new Uint8Array(response);let dataview=new DataView(plain.buffer);let magic=dataview.getUint32(0,true);let blockSize=dataview.getUint32(4,true);let keySize=dataview.getUint32(8,true);let valSize=dataview.getUint32(12,true);let itemCount=dataview.getUint32(16+4,true)*Math.pow(256,4)+dataview.getUint32(16,true);self.chromData.plain=plain;let name2id={};self.addName2id(name2id,plain,self.chromData.byteStart+32,keySize);self.chromData.name2id=name2id;resolve(self)},reject,option)})};BigbedData.prototype.addName2id=function(name2id,plain,childOffset,keySize){let dataview=new DataView(plain.buffer);let byteStart=this.chromData.byteStart;let poi=childOffset-byteStart;let isLeaf=dataview.getUint8(poi,true);poi+=2;let count=dataview.getUint16(poi,true);poi+=2;if(isLeaf==1){for(let i=1;i<=count;i++){let chrName="";for(let j=1;j<=keySize;j++){if(plain[poi]!=0)chrName+=String.fromCharCode(plain[poi]);poi++}let chromId=dataview.getUint32(poi,true);poi+=4;let chromSize=dataview.getUint32(poi,true);poi+=4;name2id[chrName]=chromId}}else if(isLeaf==0){for(let i=1;i<=count;i++){poi+=keySize;let childOffset=dataview.getUint32(poi+4,true)*Math.pow(256,4)+dataview.getUint32(poi,true);poi+=8;this.addName2id(name2id,plain,childOffset,keySize)}}else{alert("error: not supported isLeaf = "+isLeaf);return false}};BigbedData.prototype.accZoomData=function(param){let self=param[0];let reductionLevel=param[1];return new Promise(function(resolve,reject){if(self.zoomData.zoomLevels===undefined||self.loadData.zoom.base){resolve(param);return}let option={};option.byteStart=64;option.byteEnd=64+self.zoomData.zoomLevels*24-1;self.loadData.zoom.base=true;self.accRequest(function(response){let plain=new Uint8Array(response);let dataview=new DataView(plain.buffer);let zoomData={};let poi=0;for(let i=0;i<self.zoomData.zoomLevels;i++){let reductionLevel=dataview.getUint32(poi,true);poi+=8;
let dataOffset=dataview.getUint32(poi+4,true)*Math.pow(256,4)+dataview.getUint32(poi,true);poi+=8;let indexOffset=dataview.getUint32(poi+4,true)*Math.pow(256,4)+dataview.getUint32(poi,true);poi+=8;zoomData[reductionLevel]={};zoomData[reductionLevel].dataOffset=dataOffset;zoomData[reductionLevel].indexOffset=indexOffset;if(self.zoomData.minDataOffset===undefined)self.zoomData.minDataOffset=dataOffset}if(self.zoomData.zoomLevels==0)self.zoomData.minDataOffset=0;self.zoomData.indexData=zoomData;resolve(param)},reject,option)})};BigbedData.prototype.accIndexData=function(param){let self=param[0];return new Promise(function(resolve,reject){if(self.zoomData.minDataOffset===undefined||self.loadData.indexData){resolve(self);return}let option={};option.byteStart=self.indexData.byteStart;option.byteEnd=(self.zoomData.minDataOffset==0)?"":self.zoomData.minDataOffset-1;self.loadData.indexData=true;self.accRequest(function(response){let plain=new Uint8Array(response);self.indexData.plain=plain;resolve(self)},reject,option)})};BigbedData.prototype.accZoomIndexData=function(param){let self=param[0];let reductionLevel=param[1];return new Promise(function(resolve,reject){if(self.zoomData.minDataOffset===undefined||self.loadData.zoom.indexData[reductionLevel]){resolve(self);return}let nextReductionLevel;for(let key in self.zoomData.indexData){if(reductionLevel<parseInt(key)){if(nextReductionLevel===undefined){nextReductionLevel=parseInt(key)}else if(nextReductionLevel>parseInt(key)){nextReductionLevel=parseInt(key)}}}let option={};option.byteStart=self.zoomData.indexData[reductionLevel].indexOffset;option.byteEnd=(nextReductionLevel===undefined)?"":self.zoomData.indexData[nextReductionLevel].dataOffset-4-1;self.loadData.zoom.indexData[reductionLevel]=true;self.accRequest(function(response){let plain=new Uint8Array(response);self.zoomData.indexData[reductionLevel].plain=plain;resolve(self)},reject,option)})};
BigbedData.prototype.loadRegionData=function(chr,start,end,reductionLevel,callback,reject){if(reductionLevel==0){this.loadBaseRegionData(chr,start,end,callback,reject)}else{this.loadZoomRegionData(chr,start,end,reductionLevel,callback,reject)}};BigbedData.prototype.loadBaseRegionData=function(chr,start,end,callback,reject){let m=this;this.header().then(m.accZoomData).then(m.accIndexData).then(m.accChromData).then(function(){if(m.indexData.plain===undefined||m.chromData.name2id===undefined){callback([]);return}let chromIx=m.chromData.name2id[chr];if(chromIx===undefined){callback([])}else{let resultDataPos=[];let byteStart=m.indexData.byteStart;let plainData=[byteStart,m.indexData.plain];m.checkIndex(resultDataPos,[byteStart+48],[chromIx,start,end],plainData);let accDataPos=m.getAccDataPos(chromIx,resultDataPos);let promises=[];let num=accDataPos.length;for(let i=0;i<num;i++){promises.push(m.accBigbedPartial(chromIx,accDataPos))}Promise.all(promises).then(callback).catch(reject)}})};BigbedData.prototype.loadZoomRegionData=function(chr,start,end,reductionLevel,callback,reject){let m=this;this.header(reductionLevel).then(m.accZoomData).then(m.accZoomIndexData).then(m.accChromData).then(function(){if(m.zoomData.indexData===undefined||m.zoomData.indexData[reductionLevel]===undefined||m.zoomData.indexData[reductionLevel].plain===undefined||m.chromData.name2id===undefined){callback([]);return}let chromIx=m.chromData.name2id[chr];if(chromIx===undefined){callback([])}else{let resultDataPos=[];let byteStart=m.zoomData.indexData[reductionLevel].indexOffset;let plainData=[byteStart,m.zoomData.indexData[reductionLevel].plain];m.checkIndex(resultDataPos,[byteStart+48],[chromIx,start,end],plainData);let accDataPos=m.getAccDataPos(chromIx,resultDataPos,reductionLevel);let promises=[];let num=accDataPos.length;for(let i=0;i<num;i++){promises.push(m.accZoomBigbedPartial(chromIx,accDataPos,reductionLevel))}Promise.all(promises).then(callback).catch(reject)}})};
BigbedData.prototype.getData=function(chr,start,end,reductionLevel){let resData;if(reductionLevel==0){resData=this.getBaseData(chr,start,end)}else{resData=this.getZoomData(chr,start,end,reductionLevel)}return resData};BigbedData.prototype.getBaseData=function(chr,start,end){let m=this;let resData=[];let chromIx=m.chromData.name2id[chr];if(chromIx===undefined)return resData;let dataChr=m.loadData.data[chromIx];if(chromIx===undefined){}else{let resultDataPos=[];let byteStart=m.indexData.byteStart;let plainData=[byteStart,m.indexData.plain];m.checkIndex(resultDataPos,[byteStart+48],[chromIx,start,end],plainData);for(let i=0;i<resultDataPos.length;i++){let dataPos=resultDataPos[i];let dataOffset=dataPos[0];let byteEnd=dataOffset+dataPos[1]-1;while(dataOffset<byteEnd){if(m.fileType=="BigWig"){let dataChunk=m.rawData[chromIx][dataOffset];let pos=dataChunk.chromStart;let step=dataChunk.itemStep;for(let j=0;j<dataChunk.itemCount;j++){let seVal=dataChunk.items[j];if(start<=seVal.chromEnd&&seVal.chromStart<=end){resData.push(seVal)}}}else{let dataSet=m.rawData[chromIx][dataOffset];for(let j=0;j<dataSet.length;j++){let seVal=dataSet[j];if(start<=seVal.chromEnd&&seVal.chromStart<=end){resData.push(seVal)}}}let dataSize=dataChr[dataOffset];dataOffset+=dataSize}}}return resData};BigbedData.prototype.getZoomData=function(chr,start,end,reductionLevel){let m=this;let resData=[];let chromIx=m.chromData.name2id[chr];if(chromIx===undefined)return resData;let dataChr=m.loadData.zoom.data[reductionLevel][chromIx];if(chromIx===undefined){}else{let resultDataPos=[];let byteStart=m.zoomData.indexData[reductionLevel].indexOffset;let plainData=[byteStart,m.zoomData.indexData[reductionLevel].plain];m.checkIndex(resultDataPos,[byteStart+48],[chromIx,start,end],plainData);for(let i=0;i<resultDataPos.length;i++){let dataPos=resultDataPos[i];let dataOffset=dataPos[0];let byteEnd=dataOffset+dataPos[1]-1;
while(dataOffset<byteEnd){let dataChunkList=m.zoomData.rawData[reductionLevel][chromIx][dataOffset];for(let j=0;j<dataChunkList.length;j++){let dataChunk=dataChunkList[j];if(start<=dataChunk.chromEnd&&dataChunk.chromStart<=end){resData.push(dataChunk)}}let dataSize=dataChr[dataOffset];dataOffset+=dataSize}}}return resData};BigbedData.prototype.isAllLoaded=function(chr,start,end,reductionLevel){let m=this;if((reductionLevel==0&&m.indexData.plain===undefined)||(reductionLevel!=0&&(m.zoomData.indexData===undefined||m.zoomData.indexData[reductionLevel]===undefined||m.zoomData.indexData[reductionLevel].plain===undefined))||m.chromData.name2id===undefined){return false}let chromIx=m.chromData.name2id[chr];if(chromIx===undefined)return true;let dataChr=(reductionLevel==0)?m.loadData.data[chromIx]:m.loadData.zoom.data[reductionLevel][chromIx];let resData=[];if(chromIx===undefined){}else{let resultDataPos=[];let byteStart=(reductionLevel==0)?m.indexData.byteStart:m.zoomData.indexData[reductionLevel].indexOffset;let indexData=(reductionLevel==0)?m.indexData.plain:m.zoomData.indexData[reductionLevel].plain;let plainData=[byteStart,indexData];m.checkIndex(resultDataPos,[byteStart+48],[chromIx,start,end],plainData);for(let i=0;i<resultDataPos.length;i++){let dataPos=resultDataPos[i];let dataOffset=dataPos[0];let byteEnd=dataOffset+dataPos[1]-1;while(dataOffset<byteEnd){if((reductionLevel==0&&(m.rawData[chromIx]===undefined||m.rawData[chromIx][dataOffset]===undefined))||(reductionLevel!=0&&(m.zoomData.rawData===undefined||m.zoomData.rawData[reductionLevel]===undefined||m.zoomData.rawData[reductionLevel][chromIx]===undefined||m.zoomData.rawData[reductionLevel][chromIx][dataOffset]===undefined))){return false}let dataSize=dataChr[dataOffset];dataOffset+=dataSize}}}return true};BigbedData.prototype.readWaitReader=function(chr,start,end,queryReductionLevel,callback,reject,option){if(option===undefined)option={};if(option.timeout===undefined)option.timeout=300;let m=this;
this.header().then(m.accZoomData).then(function(){let reductionLevel=0;for(let key in m.zoomData.indexData){if(reductionLevel<parseInt(key)&&parseInt(key)<=queryReductionLevel){reductionLevel=parseInt(key)}}let func=function*(){let resData=m.getData(chr,start,end,reductionLevel);for(let i=0;i<resData.length;i++){yield resData[i]}};m.loadRegionData(chr,start,end,reductionLevel,function(){if(!m.isAllLoaded(chr,start,end,reductionLevel)){let counter=0;let loopFunc=function(){m.loadRegionData(chr,start,end,reductionLevel,function(){if(m.isAllLoaded(chr,start,end,reductionLevel)){callback(reductionLevel,func)}else{if(++counter>=option.timeout){reject("timeout bigbed.js")}else{setTimeout(loopFunc,1000)}}},reject)};loopFunc()}else{callback(reductionLevel,func)}},reject)},reject)};BigbedData.prototype.checkIndex=function(resultDataPos,indPosList,queryRegion,plainData){let plainIndex=plainData[1];let dataview=new DataView(plainIndex.buffer);let byteBase=plainData[0];let chromIx=queryRegion[0];let start=queryRegion[1];let end=queryRegion[2];let inIndPosList=[];for(let i=0;i<indPosList.length;i++){let indPos=indPosList[i];let poi=indPos-byteBase;let isLeaf=dataview.getUint8(poi,true);poi+=2;let count=dataview.getUint16(poi,true);poi+=2;for(let j=1;j<=count;j++){if(isLeaf==0){let startChromIx=dataview.getUint32(poi,true);poi+=4;let startBase=dataview.getUint32(poi,true)+1;poi+=4;let endChromIx=dataview.getUint32(poi,true);poi+=4;let endBase=dataview.getUint32(poi,true);poi+=4;let dataOffset=dataview.getUint32(poi+4,true)*Math.pow(256,4)+dataview.getUint32(poi,true);poi+=8;if((startChromIx<chromIx||(startChromIx==chromIx&&startBase<=end))&&(chromIx<endChromIx||(endChromIx==chromIx&&start<=endBase))){inIndPosList.push(dataOffset)}}else if(isLeaf==1){let startChromIx=dataview.getUint32(poi,true);poi+=4;let startBase=dataview.getUint32(poi,true)+1;poi+=4;let endChromIx=dataview.getUint32(poi,true);poi+=4;let endBase=dataview.getUint32(poi,true);poi+=4;
let dataOffset=dataview.getUint32(poi+4,true)*Math.pow(256,4)+dataview.getUint32(poi,true);poi+=8;let dataSize=dataview.getUint32(poi+4,true)*Math.pow(256,4)+dataview.getUint32(poi,true);poi+=8;if((startChromIx<chromIx||(startChromIx==chromIx&&startBase<=end))&&(chromIx<endChromIx||(endChromIx==chromIx&&start<=endBase))){resultDataPos.push([dataOffset,dataSize])}}else{alert("Error: Invalid file format")}}this.checkIndex(resultDataPos,inIndPosList,queryRegion,plainData)}};BigbedData.prototype.getAccDataPos=function(chromIx,resultDataPos,reductionLevel){let sorter2=[];let sorter={};if(reductionLevel===undefined||reductionLevel==0){if(this.loadData.data===undefined)this.loadData.data={};if(this.loadData.data[chromIx]===undefined)this.loadData.data[chromIx]={}}else{if(this.loadData.zoom.data===undefined)this.loadData.zoom.data={};if(this.loadData.zoom.data[reductionLevel]===undefined)this.loadData.zoom.data[reductionLevel]={};if(this.loadData.zoom.data[reductionLevel][chromIx]===undefined)this.loadData.zoom.data[reductionLevel][chromIx]={}}for(let i=0;i<resultDataPos.length;i++){let dataPos=resultDataPos[i];let dataOffset=dataPos[0];let dataSize=dataPos[1];if(reductionLevel===undefined||reductionLevel==0){if(this.loadData.data[chromIx][dataOffset]===undefined){this.loadData.data[chromIx][dataOffset]=dataSize;sorter2.push(dataOffset);sorter[dataOffset]=dataOffset+dataSize}}else{if(this.loadData.zoom.data[reductionLevel][chromIx][dataOffset]===undefined){this.loadData.zoom.data[reductionLevel][chromIx][dataOffset]=dataSize;sorter2.push(dataOffset);sorter[dataOffset]=dataOffset+dataSize}}}let accDataPos=[];let sorted2=sorter2.sort(function(a,b){return a-b});let dataOffsetNext;for(let i=0;i<sorted2.length;i++){let dataOffset=sorted2[i];if(dataOffsetNext===undefined||dataOffsetNext!=dataOffset){accDataPos.push([dataOffset,sorter[dataOffset]])}else{accDataPos[accDataPos.length-1][1]=sorter[dataOffset]}dataOffsetNext=sorter[dataOffset]}return accDataPos};
BigbedData.prototype.accBigbedPartial=function(chromIx,accDataPos){let m=this;let accData=accDataPos.pop();let option={};option.byteStart=accData[0];option.byteEnd=accData[1]-1;let byteEnd=accData[1];let dataChr=this.loadData.data[chromIx];return new Promise(function(resolve,reject){m.accRequest(function(response){let totalArray=new Uint8Array(response);let str="";let dataPoi=0;let dataOffset=accData[0];while(dataOffset<byteEnd){let dataSize=dataChr[dataOffset];let subArray=totalArray.slice(dataPoi,dataPoi+dataSize);let plain=subArray;if((plain[0]&15)==8)plain=new Zlib.Inflate(subArray).decompress();let dataview=new DataView(plain.buffer);if(m.fileType=="BigWig"){let dataChunk={};let poi=4;dataChunk.chromStart=dataview.getUint32(poi,true)+1;poi+=4;dataChunk.chromEnd=dataview.getUint32(poi,true);poi+=4;dataChunk.itemStep=dataview.getUint32(poi,true);poi+=4;dataChunk.itemSpan=dataview.getUint32(poi,true);poi+=4;dataChunk.type=dataview.getUint8(poi,true);poi+=2;dataChunk.itemCount=dataview.getUint16(poi,true);poi+=2;dataChunk.items=[];let chromStart=dataChunk.chromStart;let chromEnd=dataChunk.chromStart+dataChunk.itemSpan-1;for(let i=0;i<dataChunk.itemCount;i++){if(dataChunk.itemStep==0){chromStart=dataview.getUint32(poi,true)+1;poi+=4;if(dataChunk.itemSpan==0){chromEnd=dataview.getUint32(poi,true);poi+=4}else{chromEnd=chromStart+dataChunk.itemSpan-1}}else{chromEnd=chromStart+dataChunk.itemSpan-1}let val=dataview.getFloat32(poi,true);poi+=4;let seVal={chromStart:chromStart,chromEnd:chromEnd,value:val};dataChunk.items.push(seVal);if(dataChunk.itemStep!=0){chromStart+=dataChunk.itemStep}}if(m.rawData[chromIx]===undefined)m.rawData[chromIx]={};m.rawData[chromIx][dataOffset]=dataChunk}else{let poi=0;let dataSet=[];while(poi<plain.length){let lineData={};poi+=4;lineData.chromStart=dataview.getUint32(poi,true)+1;poi+=4;lineData.chromEnd=dataview.getUint32(poi,true);poi+=4;let clmVal="";
while(true){if(plain[poi]==0){poi++;break}else{clmVal+=String.fromCharCode(plain[poi])}poi++}lineData.otherClm=clmVal;dataSet.push(lineData)}if(m.rawData[chromIx]===undefined)m.rawData[chromIx]={};m.rawData[chromIx][dataOffset]=dataSet}dataOffset+=dataSize;dataPoi+=dataSize}resolve(m)},reject,option)})};BigbedData.prototype.accZoomBigbedPartial=function(chromIx,accDataPos,reductionLevel){let m=this;let accData=accDataPos.pop();let option={};option.byteStart=accData[0];option.byteEnd=accData[1]-1;let byteEnd=accData[1];let dataChr=this.loadData.zoom.data[reductionLevel][chromIx];return new Promise(function(resolve,reject){m.accRequest(function(response){let totalArray=new Uint8Array(response);let str="";let dataPoi=0;let dataOffset=accData[0];while(dataOffset<byteEnd){let dataSize=dataChr[dataOffset];let subArray=totalArray.slice(dataPoi,dataPoi+dataSize);let plain=subArray;if((plain[0]&15)==8)plain=new Zlib.Inflate(subArray).decompress();let dataview=new DataView(plain.buffer);let dataChunkList=[];let poi=0;while(poi<plain.length){let dataChunk={};dataChunk.chromId=dataview.getUint32(poi,true);poi+=4;dataChunk.chromStart=dataview.getUint32(poi,true)+1;poi+=4;dataChunk.chromEnd=dataview.getUint32(poi,true);poi+=4;dataChunk.validCount=dataview.getUint32(poi,true);poi+=4;dataChunk.minVal=dataview.getFloat32(poi,true);poi+=4;dataChunk.maxVal=dataview.getFloat32(poi,true);poi+=4;dataChunk.sumData=dataview.getFloat32(poi,true);poi+=4;dataChunk.sumSquares=dataview.getFloat32(poi,true);poi+=4;dataChunkList.push(dataChunk)}if(m.zoomData.rawData===undefined)m.zoomData.rawData={};if(m.zoomData.rawData[reductionLevel]===undefined)m.zoomData.rawData[reductionLevel]={};if(m.zoomData.rawData[reductionLevel][chromIx]===undefined)m.zoomData.rawData[reductionLevel][chromIx]={};m.zoomData.rawData[reductionLevel][chromIx][dataOffset]=dataChunkList;dataOffset+=dataSize;dataPoi+=dataSize}resolve(m)},reject,option)})};BigbedData.prototype.onError=function(err){alert("Error:"+err)};

/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
(function() {'use strict';var m=this;function q(c,d){var a=c.split("."),b=m;!(a[0]in b)&&b.execScript&&b.execScript("var "+a[0]);for(var e;a.length&&(e=a.shift());)!a.length&&void 0!==d?b[e]=d:b=b[e]?b[e]:b[e]={}};var s="undefined"!==typeof Uint8Array&&"undefined"!==typeof Uint16Array&&"undefined"!==typeof Uint32Array&&"undefined"!==typeof DataView;function t(c){var d=c.length,a=0,b=Number.POSITIVE_INFINITY,e,f,g,h,k,l,p,n,r,K;for(n=0;n<d;++n)c[n]>a&&(a=c[n]),c[n]<b&&(b=c[n]);e=1<<a;f=new (s?Uint32Array:Array)(e);g=1;h=0;for(k=2;g<=a;){for(n=0;n<d;++n)if(c[n]===g){l=0;p=h;for(r=0;r<g;++r)l=l<<1|p&1,p>>=1;K=g<<16|n;for(r=l;r<e;r+=k)f[r]=K;++h}++g;h<<=1;k<<=1}return[f,a,b]};function u(c,d){this.g=[];this.h=32768;this.d=this.f=this.a=this.l=0;this.input=s?new Uint8Array(c):c;this.m=!1;this.i=v;this.s=!1;if(d||!(d={}))d.index&&(this.a=d.index),d.bufferSize&&(this.h=d.bufferSize),d.bufferType&&(this.i=d.bufferType),d.resize&&(this.s=d.resize);switch(this.i){case w:this.b=32768;this.c=new (s?Uint8Array:Array)(32768+this.h+258);break;case v:this.b=0;this.c=new (s?Uint8Array:Array)(this.h);this.e=this.A;this.n=this.w;this.j=this.z;break;default:throw Error("invalid inflate mode");
}}var w=0,v=1,x={u:w,t:v};
u.prototype.k=function(){for(;!this.m;){var c=y(this,3);c&1&&(this.m=!0);c>>>=1;switch(c){case 0:var d=this.input,a=this.a,b=this.c,e=this.b,f=d.length,g=void 0,h=void 0,k=b.length,l=void 0;this.d=this.f=0;if(a+1>=f)throw Error("invalid uncompressed block header: LEN");g=d[a++]|d[a++]<<8;if(a+1>=f)throw Error("invalid uncompressed block header: NLEN");h=d[a++]|d[a++]<<8;if(g===~h)throw Error("invalid uncompressed block header: length verify");if(a+g>d.length)throw Error("input buffer is broken");switch(this.i){case w:for(;e+
g>b.length;){l=k-e;g-=l;if(s)b.set(d.subarray(a,a+l),e),e+=l,a+=l;else for(;l--;)b[e++]=d[a++];this.b=e;b=this.e();e=this.b}break;case v:for(;e+g>b.length;)b=this.e({p:2});break;default:throw Error("invalid inflate mode");}if(s)b.set(d.subarray(a,a+g),e),e+=g,a+=g;else for(;g--;)b[e++]=d[a++];this.a=a;this.b=e;this.c=b;break;case 1:this.j(z,A);break;case 2:B(this);break;default:throw Error("unknown BTYPE: "+c);}}return this.n()};
var C=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],D=s?new Uint16Array(C):C,E=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],F=s?new Uint16Array(E):E,G=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],H=s?new Uint8Array(G):G,I=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],J=s?new Uint16Array(I):I,L=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,
13],M=s?new Uint8Array(L):L,N=new (s?Uint8Array:Array)(288),O,P;O=0;for(P=N.length;O<P;++O)N[O]=143>=O?8:255>=O?9:279>=O?7:8;var z=t(N),Q=new (s?Uint8Array:Array)(30),R,S;R=0;for(S=Q.length;R<S;++R)Q[R]=5;var A=t(Q);function y(c,d){for(var a=c.f,b=c.d,e=c.input,f=c.a,g=e.length,h;b<d;){if(f>=g)throw Error("input buffer is broken");a|=e[f++]<<b;b+=8}h=a&(1<<d)-1;c.f=a>>>d;c.d=b-d;c.a=f;return h}
function T(c,d){for(var a=c.f,b=c.d,e=c.input,f=c.a,g=e.length,h=d[0],k=d[1],l,p;b<k&&!(f>=g);)a|=e[f++]<<b,b+=8;l=h[a&(1<<k)-1];p=l>>>16;c.f=a>>p;c.d=b-p;c.a=f;return l&65535}
function B(c){function d(a,c,b){var d,e=this.q,f,g;for(g=0;g<a;)switch(d=T(this,c),d){case 16:for(f=3+y(this,2);f--;)b[g++]=e;break;case 17:for(f=3+y(this,3);f--;)b[g++]=0;e=0;break;case 18:for(f=11+y(this,7);f--;)b[g++]=0;e=0;break;default:e=b[g++]=d}this.q=e;return b}var a=y(c,5)+257,b=y(c,5)+1,e=y(c,4)+4,f=new (s?Uint8Array:Array)(D.length),g,h,k,l;for(l=0;l<e;++l)f[D[l]]=y(c,3);if(!s){l=e;for(e=f.length;l<e;++l)f[D[l]]=0}g=t(f);h=new (s?Uint8Array:Array)(a);k=new (s?Uint8Array:Array)(b);c.q=0;
c.j(t(d.call(c,a,g,h)),t(d.call(c,b,g,k)))}u.prototype.j=function(c,d){var a=this.c,b=this.b;this.o=c;for(var e=a.length-258,f,g,h,k;256!==(f=T(this,c));)if(256>f)b>=e&&(this.b=b,a=this.e(),b=this.b),a[b++]=f;else{g=f-257;k=F[g];0<H[g]&&(k+=y(this,H[g]));f=T(this,d);h=J[f];0<M[f]&&(h+=y(this,M[f]));b>=e&&(this.b=b,a=this.e(),b=this.b);for(;k--;)a[b]=a[b++-h]}for(;8<=this.d;)this.d-=8,this.a--;this.b=b};
u.prototype.z=function(c,d){var a=this.c,b=this.b;this.o=c;for(var e=a.length,f,g,h,k;256!==(f=T(this,c));)if(256>f)b>=e&&(a=this.e(),e=a.length),a[b++]=f;else{g=f-257;k=F[g];0<H[g]&&(k+=y(this,H[g]));f=T(this,d);h=J[f];0<M[f]&&(h+=y(this,M[f]));b+k>e&&(a=this.e(),e=a.length);for(;k--;)a[b]=a[b++-h]}for(;8<=this.d;)this.d-=8,this.a--;this.b=b};
u.prototype.e=function(){var c=new (s?Uint8Array:Array)(this.b-32768),d=this.b-32768,a,b,e=this.c;if(s)c.set(e.subarray(32768,c.length));else{a=0;for(b=c.length;a<b;++a)c[a]=e[a+32768]}this.g.push(c);this.l+=c.length;if(s)e.set(e.subarray(d,d+32768));else for(a=0;32768>a;++a)e[a]=e[d+a];this.b=32768;return e};
u.prototype.A=function(c){var d,a=this.input.length/this.a+1|0,b,e,f,g=this.input,h=this.c;c&&("number"===typeof c.p&&(a=c.p),"number"===typeof c.v&&(a+=c.v));2>a?(b=(g.length-this.a)/this.o[2],f=258*(b/2)|0,e=f<h.length?h.length+f:h.length<<1):e=h.length*a;s?(d=new Uint8Array(e),d.set(h)):d=h;return this.c=d};
u.prototype.n=function(){var c=0,d=this.c,a=this.g,b,e=new (s?Uint8Array:Array)(this.l+(this.b-32768)),f,g,h,k;if(0===a.length)return s?this.c.subarray(32768,this.b):this.c.slice(32768,this.b);f=0;for(g=a.length;f<g;++f){b=a[f];h=0;for(k=b.length;h<k;++h)e[c++]=b[h]}f=32768;for(g=this.b;f<g;++f)e[c++]=d[f];this.g=[];return this.buffer=e};
u.prototype.w=function(){var c,d=this.b;s?this.s?(c=new Uint8Array(d),c.set(this.c.subarray(0,d))):c=this.c.subarray(0,d):(this.c.length>d&&(this.c.length=d),c=this.c);return this.buffer=c};function U(c,d){var a,b;this.input=c;this.a=0;if(d||!(d={}))d.index&&(this.a=d.index),d.verify&&(this.B=d.verify);a=c[this.a++];b=c[this.a++];switch(a&15){case V:this.method=V;break;default:throw Error("unsupported compression method");}if(0!==((a<<8)+b)%31)throw Error("invalid fcheck flag:"+((a<<8)+b)%31);if(b&32)throw Error("fdict flag is not supported");this.r=new u(c,{index:this.a,bufferSize:d.bufferSize,bufferType:d.bufferType,resize:d.resize})}
U.prototype.k=function(){var c=this.input,d,a;d=this.r.k();this.a=this.r.a;if(this.B){a=(c[this.a++]<<24|c[this.a++]<<16|c[this.a++]<<8|c[this.a++])>>>0;var b=d;if("string"===typeof b){var e=b.split(""),f,g;f=0;for(g=e.length;f<g;f++)e[f]=(e[f].charCodeAt(0)&255)>>>0;b=e}for(var h=1,k=0,l=b.length,p,n=0;0<l;){p=1024<l?1024:l;l-=p;do h+=b[n++],k+=h;while(--p);h%=65521;k%=65521}if(a!==(k<<16|h)>>>0)throw Error("invalid adler-32 checksum");}return d};var V=8;q("Zlib.Inflate",U);q("Zlib.Inflate.prototype.decompress",U.prototype.k);var W={ADAPTIVE:x.t,BLOCK:x.u},X,Y,Z,$;if(Object.keys)X=Object.keys(W);else for(Y in X=[],Z=0,W)X[Z++]=Y;Z=0;for($=X.length;Z<$;++Z)Y=X[Z],q("Zlib.Inflate.BufferType."+Y,W[Y]);}).call(this); //@ sourceMappingURL=inflate.min.js.map

